<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Raluca Korean ‚Äî Exercises</title>

  <link rel="stylesheet" href="style.css" />

  <style>
    :root{
      --bg:#f7f3ff;
      --card-bg:#ffffff;
      --accent:#c9b5ff;
      --accent-strong:#9b7cff;
      --text-main:#333;
      --text-soft:#666;
      --border:#e0d7ff;
      --overlay-bg:rgba(0,0,0,.2);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,"Segoe UI",Roboto,Arial;
      color:var(--text-main);
    }

    body.pastel-theme{
      background: linear-gradient(120deg,#dff3ff,#ffe9ff,#f4fffc,#e8f0ff);
      background-size: 380% 380%;
      animation: bgFlow 28s ease-in-out infinite;
    }
    @keyframes bgFlow{
      0%{ background-position:0% 50%; }
      50%{ background-position:100% 50%; }
      100%{ background-position:0% 50%; }
    }

    .app{
      max-width: 980px;
      margin:0 auto;
      padding:16px 12px calc(76px + env(safe-area-inset-bottom));
    }

    /* HEADER */
    .rk-header{
      border-radius:26px;
      padding:12px 14px;
      color:#fff;
      background: linear-gradient(120deg,#6fb8ff,#a774ff,#ff7fd1);
      box-shadow: 0 18px 45px rgba(77,93,255,.25);
      position:relative;
    }
    .rk-header-main{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .rk-header-main h1{
      margin:0;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:18px;
      text-shadow:0 3px 10px rgba(0,0,0,.18);
    }
    .rk-badge{
      background: rgba(255,255,255,.18);
      border-radius:999px;
      padding:6px 12px;
      font-weight:700;
      font-size:12px;
      white-space:nowrap;
    }
    #subtitle{
      margin:6px 0 0;
      font-size:12px;
      opacity:.95;
    }

    /* SCREEN */
    .screen{ display:none; }
    .screen.active{ display:block; }

    /* CARD EXERCISES */
    .card{
      margin-top:14px;
      border-radius:26px;
      padding:16px;
      background: radial-gradient(circle at top left,#ffffff 5%, #f7f0ff 45%, #ffe9ff 85%);
      box-shadow: 0 18px 40px rgba(70,85,155,.18), 0 0 0 1px rgba(255,255,255,.9) inset;
      border:none;
    }

    .ex-header-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .ex-pill{
      display:inline-flex;
      align-items:center;
      padding:2px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      color:#5860b0;
      background:rgba(95,140,255,.14);
    }
    .ex-mini-hint{
      font-size:11px;
      color:rgba(0,0,0,.55);
      text-align:right;
      margin-top:2px;
    }

    h2{
      margin:8px 0 0;
      font-size:15px;
      font-weight:900;
      letter-spacing:.03em;
      color:#5860b0;
      text-transform:uppercase;
    }

    .ex-type-row{
      margin-top:12px;
      padding:10px 12px;
      border-radius:18px;
      background:rgba(255,255,255,.55);
      box-shadow: 0 10px 25px rgba(120,140,200,.18), 0 0 0 1px rgba(255,255,255,.7) inset;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .small-label{ font-size:11px; color:rgba(0,0,0,.55); font-weight:700; }
    .ex-type-chip{
      display:inline-flex;
      padding:3px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight:800;
      background:rgba(255,175,107,.22);
      color:#6f5430;
      margin-top:4px;
    }
    select{
      border-radius:999px;
      border:none;
      padding:10px 12px;
      font-size:13px;
      font-weight:700;
      box-shadow: 0 8px 20px rgba(135,130,200,.25);
      background:rgba(255,255,255,.9);
      outline:none;
    }

    .ex-question-shell{
      margin-top:12px;
      padding:12px 14px;
      border-radius:22px;
      background: linear-gradient(145deg,#ffffff,#f7f4ff);
      box-shadow: 0 12px 28px rgba(140,130,200,.20), 0 0 0 1px rgba(255,255,255,.85) inset;
    }

    .ex-question-tag-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .ex-question-tag{
      font-size:11px;
      font-weight:900;
      padding:3px 10px;
      border-radius:999px;
      background:rgba(95,140,255,.14);
      color:#5860b0;
    }
    .ex-question-subtag{
      font-size:11px;
      color:rgba(0,0,0,.55);
      font-weight:700;
      text-align:right;
    }

    .exercise-question{
      margin-top:10px;
      font-size:15px;
      font-weight:800;
      color:#2f2948;
    }
    .exercise-question.empty{
      color:rgba(0,0,0,.55);
      font-weight:600;
    }

    /* OPTIONS */
    .exercise-options{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .ex-option{
      width:100%;
      text-align:left;
      border:none;
      border-radius:18px;
      padding:10px 12px;
      font-weight:800;
      background: linear-gradient(135deg,#4b8bff,#a55dff);
      color:#fff;
      box-shadow: 0 10px 25px rgba(80,90,160,.28), 0 0 0 1px rgba(255,255,255,.65) inset;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    .ex-option:hover{ transform: translateY(-1px); filter: brightness(1.05); }
    .ex-option:active{ transform: translateY(1px) scale(.99); }
    .ex-option:disabled{ opacity:.55; cursor:default; }

    .ex-option.good{ background: linear-gradient(135deg,#5be6c6,#6cc9ff); }
    .ex-option.bad{ background: linear-gradient(135deg,#ff6b6b,#ff9a6c); }

    /* BUTTONS */
    .btn-group{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    button{
      border:none;
      border-radius:18px;
      padding:10px 14px;
      font-weight:900;
      color:#fff;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(80, 80, 140, 0.28), 0 0 0 1px rgba(255,255,255,.7) inset;
      background: linear-gradient(135deg,#4b8bff,#a55dff);
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    button.secondary{
      background: linear-gradient(135deg,#ffaf6b,#ff72b4);
    }
    button:active{ transform: translateY(2px); }
    button:disabled{ opacity:.55; cursor:default; box-shadow:none; }

    .exercise-feedback{
      margin-top:10px;
      min-height:18px;
      font-size:13px;
      font-weight:800;
      color:#2f2948;
      white-space:pre-line;
    }

    /* PUZZLE */
    .ex-pz-bank, .ex-pz-line{
      min-height:54px;
      padding:10px;
      border-radius:18px;
      background:rgba(255,255,255,.7);
      box-shadow: 0 10px 25px rgba(120,140,200,.18), 0 0 0 1px rgba(255,255,255,.7) inset;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .ex-chip{
      border:none;
      border-radius:999px;
      padding:8px 12px;
      font-weight:900;
      cursor:pointer;
      background:rgba(255,255,255,.85);
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
    }
    .ex-chip.active{
      background: linear-gradient(135deg,#8fd3ff,#c798ff);
      color:#fff;
    }

    /* NAV */
    .bottom-nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding:10px 10px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(120deg,#f3e6ff,#ffe8fb);
      box-shadow: 0 -10px 25px rgba(110,120,190,.25);
      display:flex;
      gap:10px;
      justify-content:space-around;
      z-index:500;
      backdrop-filter: blur(18px);
      border-radius:24px 24px 0 0;
    }
    .nav-btn{
      flex:1;
      border:none;
      background: linear-gradient(120deg,#f4e4ff,#fdf3ff);
      border-radius:999px;
      padding:8px 14px 6px;
      font-weight:800;
      color:#4a3b73;
      box-shadow: 0 8px 20px rgba(0,0,0,.10);
      cursor:pointer;
    }
    .nav-btn.active{
      background: linear-gradient(120deg,#8fd3ff,#c798ff);
      color:#fff;
      box-shadow: 0 14px 32px rgba(123,104,238,.45);
      transform: translateY(-2px);
    }
    .nav-btn .icon{ font-size:18px; display:block; }

  </style>
</head>

<body class="pastel-theme">
  <div class="app">
    <header class="rk-header">
      <div class="rk-header-main">
        <h1>Raluca Korean</h1>
        <span class="rk-badge">Study App v2.0</span>
      </div>
      <p id="subtitle">Exerci»õii TOPIK ‚Äî Quiz + Particule + Puzzle</p>
    </header>

    <div class="screen active" id="screen-exercises">
      <div class="card ex-card">
        <div class="ex-header-row">
          <div>
            <div class="ex-pill">TOPIK trainer</div>
            <h2>Exerci»õii TOPIK</h2>
          </div>
          <div class="ex-mini-hint">verbe ¬∑ particule ¬∑ puzzle</div>
        </div>

        <div class="ex-type-row">
          <div class="ex-type-left">
            <span class="small-label">Tip exerci»õiu</span>
            <span class="ex-type-chip" id="exerciseTypeLabel">‚Äî</span>
          </div>

          <!-- IMPORTANT: aici pƒÉstrƒÉm doar tipurile pe care le suportƒÉ JS-ul -->
          <select id="exerciseType">
            <option value="verb">Quiz KO ‚Üí RO</option>
            <option value="particle">Particule (alegere)</option>
            <option value="puzzle">üß© Puzzle ‚Äì ordoneazƒÉ propozi»õia</option>
          </select>
        </div>

        <div class="ex-question-shell">
          <div class="ex-question-tag-row">
            <span class="ex-question-tag">√éntrebare curentƒÉ</span>
            <span class="ex-question-subtag" id="exerciseSubtag"></span>
          </div>

          <div class="exercise-question empty" id="exerciseQuestion">
            Alege tipul de exerci»õiu »ôi apasƒÉ ‚Äû√éntrebare nouƒÉ‚Äù.
          </div>

          <div class="exercise-options" id="exerciseOptions"></div>

          <div class="btn-group ex-buttons">
            <button id="checkAnswerBtn" type="button">VerificƒÉ rƒÉspunsul</button>
            <button class="secondary" id="nextQuestionBtn" type="button">√éntrebare nouƒÉ</button>
          </div>

          <div class="exercise-feedback" id="exerciseFeedback"></div>
        </div>
      </div>
    </div>

    <nav class="bottom-nav">
      <button class="nav-btn" data-target="builder" type="button">
        <span class="icon">üèó</span><span>Builder</span>
      </button>
      <button class="nav-btn active" data-target="exercises" type="button">
        <span class="icon">üìù</span><span>Exerci»õii</span>
      </button>
      <button class="nav-btn" data-target="lessons" type="button">
        <span class="icon">üìó</span><span>Lec»õii</span>
      </button>
      <button class="nav-btn" data-target="glossary" type="button">
        <span class="icon">üìö</span><span>Glosar</span>
      </button>
    </nav>
  </div>

  <!-- banca de date TOPIK4 -->
  <script src="topik4_quiz_particles_500.js"></script>

  <script>
    (function(){
      const map = { builder:'builder.html', exercises:'exercises.html', lessons:'lessons.html', glossary:'glossary.html' };
      document.querySelectorAll('.nav-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const t = btn.dataset.target;
          if(map[t]) window.location.href = map[t];
        });
      });
    })();

    const EX_LS_KEY = "rk_exercises_state_v3_topik4";

    const QUIZ_BANK = Array.isArray(window.TOPIK4_QUIZ_500) ? window.TOPIK4_QUIZ_500 : [];
    const PARTICLES_BANK = Array.isArray(window.TOPIK4_PARTICLES_500) ? window.TOPIK4_PARTICLES_500 : [];

    const PUZZLE_BANK = QUIZ_BANK.slice(0, 500).map(q=>{
      const clean = String(q.ko||"").trim().replace(/[.?!]/g,"");
      const words = clean.split(/\s+/).filter(Boolean);
      return { words, answer: clean, ro: q.ro || "" };
    }).filter(p=>p.words.length >= 2);

    const exerciseTypeEl = document.getElementById("exerciseType");
    const exerciseTypeLabelEl = document.getElementById("exerciseTypeLabel");
    const exerciseSubtagEl = document.getElementById("exerciseSubtag");
    const exerciseQuestionEl = document.getElementById("exerciseQuestion");
    const exerciseOptionsEl = document.getElementById("exerciseOptions");
    const exerciseFeedbackEl = document.getElementById("exerciseFeedback");
    const checkAnswerBtn = document.getElementById("checkAnswerBtn");
    const nextQuestionBtn = document.getElementById("nextQuestionBtn");

    function safeParse(json, fallback){ try { return JSON.parse(json); } catch { return fallback; } }
    function loadState(){
      const base = { quiz:{idx:0,correct:0,total:0}, particles:{idx:0,correct:0,total:0}, puzzle:{idx:0,correct:0,total:0}, lastType:"verb" };
      const raw = localStorage.getItem(EX_LS_KEY);
      if(!raw) return base;
      const st = safeParse(raw, base);
      return Object.assign(base, st);
    }
    const state = loadState();
    function saveState(){ localStorage.setItem(EX_LS_KEY, JSON.stringify(state)); }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }

    function setEmptyQuestion(msg){
      exerciseQuestionEl.classList.add("empty");
      exerciseQuestionEl.textContent = msg;
      exerciseOptionsEl.innerHTML = "";
      exerciseFeedbackEl.textContent = "";
      exerciseSubtagEl.textContent = "";
    }

    let current = null;

    function setTypeLabel(type){
      const map = {
        verb: "Quiz KO ‚Üí RO (alegi traducerea corectƒÉ)",
        particle: "Particule (alegi particula corectƒÉ)",
        puzzle: "Puzzle (aranjezi cuvintele)"
      };
      exerciseTypeLabelEl.textContent = map[type] || "‚Äî";
    }

    function renderQuestion(type){
      setTypeLabel(type);
      exerciseFeedbackEl.textContent = "";
      exerciseOptionsEl.innerHTML = "";
      exerciseQuestionEl.classList.remove("empty");

      if(type==="verb"){
        if(!QUIZ_BANK.length) return setEmptyQuestion("Nu existƒÉ √ÆntrebƒÉri √Æn banca QUIZ.");
        if(state.quiz.idx >= QUIZ_BANK.length) state.quiz.idx = 0;

        const q = QUIZ_BANK[state.quiz.idx];
        const correct = q.ro;

        const wrong = shuffle(QUIZ_BANK.filter(x=>x.ro!==correct)).slice(0,3).map(x=>x.ro);
        const opts = shuffle([correct, ...wrong]);

        exerciseSubtagEl.textContent = `√éntrebarea ${state.quiz.idx+1}/${QUIZ_BANK.length} ¬∑ Scor ${state.quiz.correct}/${state.quiz.total}`;
        exerciseQuestionEl.innerHTML = q.ko;

        opts.forEach(opt=>{
          const btn = document.createElement("button");
          btn.type="button";
          btn.className="ex-option";
          btn.textContent = opt;
          btn.addEventListener("click", ()=>{
            document.querySelectorAll("#exerciseOptions .ex-option").forEach(b=>b.disabled=true);
            const ok = opt === correct;
            state.quiz.total += 1;
            if(ok) state.quiz.correct += 1;
            btn.classList.add(ok ? "good" : "bad");
            exerciseFeedbackEl.textContent = ok ? "‚úÖ Corect." : `‚ùå Gre»ôit. Corect: ${correct}`;
            saveState();
            exerciseSubtagEl.textContent = `√éntrebarea ${state.quiz.idx+1}/${QUIZ_BANK.length} ¬∑ Scor ${state.quiz.correct}/${state.quiz.total}`;
          });
          exerciseOptionsEl.appendChild(btn);
        });

        current = { type:"verb" };
        return;
      }

      if(type==="particle"){
        if(!PARTICLES_BANK.length) return setEmptyQuestion("Nu existƒÉ √ÆntrebƒÉri √Æn banca PARTICULE.");
        if(state.particles.idx >= PARTICLES_BANK.length) state.particles.idx = 0;

        const q = PARTICLES_BANK[state.particles.idx];
        exerciseSubtagEl.textContent = `√éntrebarea ${state.particles.idx+1}/${PARTICLES_BANK.length} ¬∑ Corecte ${state.particles.correct}/${state.particles.total}`;
        exerciseQuestionEl.innerHTML = q.text;

        q.choices.forEach(ch=>{
          const btn = document.createElement("button");
          btn.type="button";
          btn.className="ex-option";
          btn.textContent = ch;
          btn.addEventListener("click", ()=>{
            document.querySelectorAll("#exerciseOptions .ex-option").forEach(b=>b.disabled=true);
            const ok = ch === q.answer;
            state.particles.total += 1;
            if(ok) state.particles.correct += 1;
            btn.classList.add(ok ? "good" : "bad");
            exerciseFeedbackEl.textContent = ok ? `‚úÖ Corect. (${q.explain || ""})` : `‚ùå Gre»ôit. Corect: ${q.answer} ${q.explain ? "‚Äî "+q.explain : ""}`;
            saveState();
            exerciseSubtagEl.textContent = `√éntrebarea ${state.particles.idx+1}/${PARTICLES_BANK.length} ¬∑ Corecte ${state.particles.correct}/${state.particles.total}`;
          });
          exerciseOptionsEl.appendChild(btn);
        });

        current = { type:"particle" };
        return;
      }

      if(type==="puzzle"){
        if(!PUZZLE_BANK.length) return setEmptyQuestion("Nu existƒÉ puzzle-uri √Æn bancƒÉ.");
        if(state.puzzle.idx >= PUZZLE_BANK.length) state.puzzle.idx = 0;

        const pz = PUZZLE_BANK[state.puzzle.idx];
        exerciseSubtagEl.textContent = `Puzzle ${state.puzzle.idx+1}/${PUZZLE_BANK.length} ¬∑ Corecte ${state.puzzle.correct}/${state.puzzle.total}`;
        exerciseQuestionEl.innerHTML = `<b>AranjeazƒÉ cuvintele:</b>`;

        exerciseOptionsEl.innerHTML = `
          <div class="ex-pz-title" style="font-weight:900;color:#5860b0;margin-bottom:6px;">Cuvinte</div>
          <div id="pzBank" class="ex-pz-bank"></div>
          <div class="ex-pz-title" style="font-weight:900;color:#5860b0;margin:10px 0 6px;">Propozi»õia ta</div>
          <div id="pzLine" class="ex-pz-line"></div>
          <div class="btn-group" style="justify-content:flex-start;margin-top:10px;">
            <button class="secondary" id="pzClear" type="button">CurƒÉ»õƒÉ</button>
          </div>
        `;

        const bankEl = document.getElementById("pzBank");
        const lineEl = document.getElementById("pzLine");
        const clearBtn = document.getElementById("pzClear");

        let built = [];

        function renderPuzzle(){
          bankEl.innerHTML = "";
          lineEl.innerHTML = "";

          const usedCount = {};
          built.forEach(w => usedCount[w] = (usedCount[w]||0) + 1);

          const remaining = [];
          pz.words.forEach(w=>{
            const used = usedCount[w] || 0;
            const total = pz.words.filter(x=>x===w).length;
            if(used < total) remaining.push(w);
          });

          shuffle(remaining).forEach(w=>{
            const chip = document.createElement("button");
            chip.type="button";
            chip.className="ex-chip";
            chip.textContent = w;
            chip.addEventListener("click", ()=>{
              built.push(w);
              renderPuzzle();
            });
            bankEl.appendChild(chip);
          });

          built.forEach((w, idx)=>{
            const chip = document.createElement("button");
            chip.type="button";
            chip.className="ex-chip active";
            chip.textContent = w;
            chip.addEventListener("click", ()=>{
              built.splice(idx,1);
              renderPuzzle();
            });
            lineEl.appendChild(chip);
          });
        }

        clearBtn.addEventListener("click", ()=>{
          built = [];
          exerciseFeedbackEl.textContent = "";
          renderPuzzle();
        });

        renderPuzzle();

        current = {
          type:"puzzle",
          getBuilt: ()=> built.join(" ").trim(),
          answer: pz.answer.trim(),
          ro: pz.ro || ""
        };
        return;
      }

      setEmptyQuestion("SelecteazƒÉ un tip de exerci»õiu.");
    }

    function nextQuestion(){
      const type = exerciseTypeEl ? exerciseTypeEl.value : "verb";
      state.lastType = type;

      if(type==="verb") state.quiz.idx += 1;
      if(type==="particle") state.particles.idx += 1;
      if(type==="puzzle") state.puzzle.idx += 1;

      saveState();
      renderQuestion(type);
    }

    function checkAnswer(){
      const type = exerciseTypeEl ? exerciseTypeEl.value : "verb";
      if(type==="puzzle" && current && current.type==="puzzle"){
        const built = current.getBuilt();
        const ok = built === current.answer;

        state.puzzle.total += 1;
        if(ok) state.puzzle.correct += 1;

        exerciseFeedbackEl.textContent = ok
          ? `‚úÖ Corect! ${current.ro ? "\nRO: " + current.ro : ""}`
          : `‚ùå Nu √ÆncƒÉ.\nCorect: ${current.answer}${current.ro ? "\nRO: "+current.ro : ""}`;

        saveState();
        exerciseSubtagEl.textContent = `Puzzle ${state.puzzle.idx+1}/${PUZZLE_BANK.length} ¬∑ Corecte ${state.puzzle.correct}/${state.puzzle.total}`;
      } else {
        exerciseFeedbackEl.textContent = "Alege o op»õiune (tap).";
      }
    }

    if(exerciseTypeEl){
      exerciseTypeEl.value = state.lastType || "verb";
      exerciseTypeEl.addEventListener("change", ()=> renderQuestion(exerciseTypeEl.value));
    }
    if(nextQuestionBtn) nextQuestionBtn.addEventListener("click", nextQuestion);
    if(checkAnswerBtn) checkAnswerBtn.addEventListener("click", checkAnswer);

    renderQuestion(exerciseTypeEl ? exerciseTypeEl.value : "verb");
  </script>
</body>
</html>
