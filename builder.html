<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Raluca Korean ‚Äî Builder</title>

  <!-- DacƒÉ ai style.css global, √Æl po»õi lƒÉsa. Nu stricƒÉ. -->
  <link rel="stylesheet" href="style.css" />

  <style>
    /* =========================================================
       Raluca Korean ‚Äî Builder (single-file, stabil)
       - Func»õioneazƒÉ singur (are CSS + JS √Æn acest fi»ôier)
       - Po»õi avea ORIC√ÇTE propozi»õii (nu doar P1/P2)
       ========================================================= */

    /* ---------- Reset & base ---------- */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.35;
      -webkit-text-size-adjust: 100%;
    }

    :root{
      --bg0: #fbf7ff;
      --ink: #1b1630;
      --muted: #5f5a77;

      --accent: #8b5cf6;
      --accent2: #22c55e;

      --card: rgba(255,255,255,0.78);
      --card-strong: rgba(255,255,255,0.92);

      --border: rgba(27,22,48,0.12);
      --shadow: 0 18px 40px rgba(27,22,48,0.12);

      --radius-lg: 22px;
      --radius-md: 16px;

      --maxw: 1040px;
    }

    body.pastel-theme{
      color: var(--ink);
      background:
        radial-gradient(900px 500px at 12% 18%, rgba(139,92,246,0.18), transparent 55%),
        radial-gradient(900px 520px at 88% 22%, rgba(34,197,94,0.14), transparent 55%),
        radial-gradient(900px 520px at 45% 88%, rgba(6,182,212,0.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), #f7f3ff);
    }

    .shell{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 18px 14px 26px;
      min-height: 100%;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .topbar{
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .mark{
      width: 44px; height: 44px;
      border-radius: 14px;
      display:grid; place-items:center;
      font-weight: 900; color:#fff;
      background: linear-gradient(135deg, rgba(139,92,246,1), rgba(6,182,212,0.95));
      box-shadow: 0 10px 24px rgba(139,92,246,0.25);
      flex: 0 0 auto;
    }
    .titleWrap{ min-width:0; }
    .title{
      margin:0;
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      margin-top: 2px;
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .topActions{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(27,22,48,0.14);
      background: rgba(255,255,255,0.9);
      color: rgba(27,22,48,0.9);
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 800;
      font-size: 13px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(27,22,48,0.10);
      transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(139,92,246,0.35); }
    .btn:active{ transform: translateY(0px); box-shadow: 0 8px 18px rgba(27,22,48,0.10); }

    .btn.primary{
      background: rgba(139,92,246,0.14);
      border-color: rgba(139,92,246,0.26);
    }
    .btn.green{
      background: rgba(34,197,94,0.14);
      border-color: rgba(34,197,94,0.26);
    }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    @media (min-width: 960px){
      .grid{
        grid-template-columns: 1.2fr 0.8fr;
      }
    }

    .card{
      border: 1px solid var(--border);
      background: var(--card-strong);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 14px;
    }

    .cardTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      margin-bottom: 10px;
    }
    .cardTitle h2{
      margin:0;
      font-size: 16px;
      font-weight: 900;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
    }

    /* --- Sentence Tabs --- */
    .tabs{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .tab{
      border: 1px solid rgba(27,22,48,0.12);
      background: rgba(255,255,255,0.85);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 900;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap: 6px;
    }
    .tab.active{
      background: rgba(139,92,246,0.16);
      border-color: rgba(139,92,246,0.28);
    }
    .tab small{
      font-weight: 800;
      color: rgba(27,22,48,0.65);
    }

    /* --- Builder rows --- */
    .rowGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 720px){
      .rowGrid{
        grid-template-columns: 1fr 1fr;
      }
    }

    .slot{
      border: 1px solid rgba(27,22,48,0.12);
      background: rgba(255,255,255,0.85);
      border-radius: var(--radius-md);
      padding: 10px;
    }
    .slotTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .slotLabel{
      font-weight: 900;
      font-size: 13px;
    }
    .slotValue{
      width: 100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      border: 1px solid rgba(27,22,48,0.12);
      border-radius: 14px;
      padding: 10px 10px;
      cursor:pointer;
      user-select:none;
      background: rgba(255,255,255,0.9);
      font-weight: 900;
    }
    .slotValue span{
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .slotValue em{
      font-style: normal;
      color: rgba(27,22,48,0.55);
      font-weight: 800;
      font-size: 12px;
    }

    .slotActions{
      display:flex; gap: 8px; flex-wrap:wrap;
      margin-top: 10px;
    }

    /* --- Preview --- */
    .previewKo{
      font-size: 20px;
      font-weight: 900;
      letter-spacing: .2px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(27,22,48,0.12);
      background: rgba(255,255,255,0.9);
      min-height: 52px;
      display:flex;
      align-items:center;
    }
    .previewRo{
      margin-top: 10px;
      font-size: 13px;
      color: rgba(27,22,48,0.75);
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px dashed rgba(27,22,48,0.16);
      background: rgba(255,255,255,0.65);
      min-height: 48px;
    }

    .divider{
      height: 1px;
      background: rgba(27,22,48,0.10);
      margin: 10px 0;
    }

    /* --- Overlay picker --- */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(10, 8, 20, 0.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
      z-index: 50;
    }
    .overlay.show{ display:flex; }

    .panel{
      width: min(860px, 100%);
      max-height: min(86vh, 760px);
      overflow: hidden;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.24);
      background: rgba(255,255,255,0.92);
      box-shadow: 0 30px 80px rgba(0,0,0,0.25);
      display:flex;
      flex-direction:column;
    }
    .panelHeader{
      padding: 12px 12px 10px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      border-bottom: 1px solid rgba(27,22,48,0.10);
      background: rgba(255,255,255,0.9);
    }
    .panelHeader h3{
      margin:0;
      font-size: 14px;
      font-weight: 900;
    }
    .panelHeader .sub{
      margin-top: 2px;
      font-size: 12px;
      color: rgba(27,22,48,0.65);
      font-weight: 700;
    }
    .panelBody{
      padding: 10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap: 10px;
      overflow:auto;
    }
    .fieldRow{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }
    .inp{
      flex: 1 1 220px;
      border: 1px solid rgba(27,22,48,0.14);
      background: rgba(255,255,255,0.96);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 14px;
      outline: none;
    }

    .list{
      border: 1px solid rgba(27,22,48,0.12);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(255,255,255,0.85);
    }
    .item{
      padding: 10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(27,22,48,0.08);
      cursor:pointer;
    }
    .item:last-child{ border-bottom: none; }
    .item:hover{ background: rgba(139,92,246,0.10); }
    .item .ko{
      font-weight: 900;
      font-size: 15px;
    }
    .item .ro{
      font-size: 12px;
      color: rgba(27,22,48,0.65);
      font-weight: 700;
      text-align:right;
    }

    .pillInfo{
      display:inline-flex;
      align-items:center;
      gap: 6px;
      font-size: 12px;
      color: rgba(27,22,48,0.7);
      background: rgba(34,197,94,0.12);
      border: 1px solid rgba(34,197,94,0.22);
      padding: 7px 10px;
      border-radius: 999px;
      font-weight: 900;
    }

    .small{
      font-size: 12px;
      color: rgba(27,22,48,0.65);
    }
  </style>
</head>

<body class="pastel-theme">
  <div class="shell">
    <!-- TOPBAR -->
    <div class="topbar">
      <div class="brand">
        <div class="mark">RK</div>
        <div class="titleWrap">
          <div class="title">Raluca Korean ‚Äî Builder</div>
          <div class="subtitle">Propozi»õii nelimitate ¬∑ particule ¬∑ conjugare ¬∑ audio ¬∑ favorite</div>
        </div>
      </div>
      <div class="topActions">
        <a class="btn ghost" href="index.html" style="text-decoration:none;">‚¨Ö √énapoi</a>
        <button class="btn primary" id="addSentenceBtn" type="button">‚ûï Add sentence</button>
        <button class="btn" id="dupSentenceBtn" type="button">üìÑ Duplicate</button>
        <button class="btn" id="delSentenceBtn" type="button">üóë Delete</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: BUILDER -->
      <div class="card">
        <div class="cardTitle">
          <h2>Construc»õia propozi»õiei</h2>
          <span class="pillInfo" id="sentInfo">Sentence 1 / 1</span>
        </div>

        <div class="tabs" id="tabs"></div>

        <div class="rowGrid" id="slots"></div>

        <div class="divider"></div>

        <div class="slotActions">
          <button class="btn primary" id="randomBtn" type="button">üé≤ Random</button>
          <button class="btn" id="clearBtn" type="button">üßΩ Clear sentence</button>
          <button class="btn green" id="saveFavBtn" type="button">‚≠ê Save favorite</button>
          <button class="btn" id="speakBtn" type="button">üîä Audio (KO)</button>
        </div>

        <div class="divider"></div>

        <div class="hint">
          Tap pe un c√¢mp ca sƒÉ alegi cuv√¢ntul. √én listƒÉ ai »ôi cƒÉutare + po»õi adƒÉuga propriile cuvinte (cu traducere).
        </div>
      </div>

      <!-- RIGHT: PREVIEW -->
      <div class="card">
        <div class="cardTitle">
          <h2>Preview</h2>
          <span class="hint" id="statusText">‚Äî</span>
        </div>

        <div class="small">CoreeanƒÉ (KO)</div>
        <div class="previewKo" id="previewKo">Alege cuvinte‚Ä¶</div>

        <div class="small" style="margin-top:10px;">Rom√¢nƒÉ (aproximativ)</div>
        <div class="previewRo" id="previewRo">‚Äî</div>

        <div class="divider"></div>

        <div class="cardTitle" style="margin-bottom:6px;">
          <h2>Ultimele favorite</h2>
          <span class="hint">salvate √Æn telefon (local)</span>
        </div>
        <div id="favList" class="small">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- OVERLAY PICKER -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="panel" role="dialog" aria-modal="true">
      <div class="panelHeader">
        <div>
          <h3 id="panelTitle">Alege</h3>
          <div class="sub" id="panelSub">‚Äî</div>
        </div>
        <button class="btn" id="closeOverlayBtn" type="button">‚úï</button>
      </div>
      <div class="panelBody">
        <div class="fieldRow">
          <input class="inp" id="searchInput" type="text" placeholder="CautƒÉ (KO sau RO)..." />
        </div>

        <div class="fieldRow">
          <input class="inp" id="newKo" type="text" placeholder="AdaugƒÉ nou (KO)..." />
          <input class="inp" id="newRo" type="text" placeholder="Traducere RO (op»õional)..." />
          <button class="btn primary" id="addCustomBtn" type="button">+ Add</button>
        </div>

        <div class="list" id="list"></div>
        <div class="small" id="panelFoot">Tip: apƒÉsarea pe element √Æl selecteazƒÉ.</div>
      </div>
    </div>
  </div>

  <script>
    // =========================================================
    // Raluca Korean ‚Äî Builder (single-file)
    // - Stare salvatƒÉ √Æn localStorage
    // - Propozi»õii nelimitate (array)
    // =========================================================

    const LS_KEY = "rk_builder_v1";
    const LS_FAV = "rk_favorites_v1";

    // --- DATA (po»õi extinde oric√¢nd) ---
    // Format item: { ko: "Ï†ÄÎäî", ro: "eu (topic)" }
    const DATA = {
      subject: [
        { ko:"Ï†ÄÎäî", ro:"eu (topic)" },
        { ko:"Ï†ÄÎäîÏöî", ro:"eu (topic, accent)" },
        { ko:"Ï†ÄÌù¨Îäî", ro:"noi (topic)" },
        { ko:"ÏπúÍµ¨Îäî", ro:"prietenul (topic)" },
        { ko:"ÏóÑÎßàÎäî", ro:"mama (topic)" },
        { ko:"ÌïôÏÉùÏùÄ", ro:"studentul (topic)" },
        { ko:"Ï†Ä", ro:"eu" },
        { ko:"Ï†ÄÌù¨", ro:"noi" }
      ],
      time: [
        { ko:"Ïò§Îäò", ro:"azi" },
        { ko:"ÎÇ¥Ïùº", ro:"m√¢ine" },
        { ko:"ÏßÄÍ∏à", ro:"acum" },
        { ko:"ÏïÑÏπ®Ïóê", ro:"diminea»õa" },
        { ko:"Ï†ÄÎÖÅÏóê", ro:"seara" },
        { ko:"Ï£ºÎßêÏóê", ro:"√Æn weekend" }
      ],
      place: [
        { ko:"ÏßëÏóê", ro:"acasƒÉ" },
        { ko:"ÌïôÍµêÏóê", ro:"la »ôcoalƒÉ" },
        { ko:"ÌöåÏÇ¨Ïóê", ro:"la muncƒÉ" },
        { ko:"Ïπ¥ÌéòÏóê", ro:"la cafenea" },
        { ko:"ÏÑúÏö∏Ïóê", ro:"√Æn Seoul" },
        { ko:"Î≥ëÏõêÏóê", ro:"la spital" }
      ],
      object: [
        { ko:"Ïª§ÌîºÎ•º", ro:"cafea (obj)" },
        { ko:"Î∞•ÏùÑ", ro:"m√¢ncare/orez (obj)" },
        { ko:"Î¨ºÏùÑ", ro:"apƒÉ (obj)" },
        { ko:"ÌïúÍµ≠Ïñ¥Î•º", ro:"coreeanƒÉ (obj)" },
        { ko:"ÏïΩÏùÑ", ro:"medicament (obj)" }
      ],
      verb: [
        { ko:"ÎßàÏãúÎã§", ro:"a bea" },
        { ko:"Î®πÎã§", ro:"a m√¢nca" },
        { ko:"Í∞ÄÎã§", ro:"a merge" },
        { ko:"Ïò§Îã§", ro:"a veni" },
        { ko:"Í≥µÎ∂ÄÌïòÎã§", ro:"a studia" },
        { ko:"ÌïòÎã§", ro:"a face" }
      ],
      // termina»õii simple (demo). Le ‚Äúlipim‚Äù la verb.
      ending: [
        { ko:"-ÏïÑÏöî/Ïñ¥Ïöî", ro:"prezent politicos" },
        { ko:"-Í≥† ÏûàÏñ¥Ïöî", ro:"acum (continuu)" },
        { ko:"-(Ïúº)Î†§Í≥† Ìï¥Ïöî", ro:"inten»õie" },
        { ko:"-(Ïúº)„ÑπÍπåÏöî?", ro:"propunere / sƒÉ‚Ä¶?" },
        { ko:"-Ïïò/ÏóàÏñ¥Ïöî", ro:"trecut" }
      ],
      connector: [
        { ko:"Í∑∏Î¶¨Í≥†", ro:"»ôi" },
        { ko:"Í∑∏ÎûòÏÑú", ro:"deci" },
        { ko:"ÌïòÏßÄÎßå", ro:"dar" },
        { ko:"Í∑∏ÎûòÎèÑ", ro:"totu»ôi" }
      ]
    };

    const SLOT_DEF = [
      { key:"subject", label:"Subiect / Topic" },
      { key:"time", label:"Timp" },
      { key:"place", label:"Loc" },
      { key:"object", label:"Obiect" },
      { key:"verb", label:"Verb (dic»õionar)" },
      { key:"ending", label:"Conjugare / Ending" },
      { key:"connector", label:"Conector (op»õional)" }
    ];

    // --- Helpers ---
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function safeParse(json, fallback){
      try { return JSON.parse(json); } catch { return fallback; }
    }

    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      const base = {
        activeIndex: 0,
        sentences: [ emptySentence() ],
        custom: { subject:[], time:[], place:[], object:[], verb:[], ending:[], connector:[] }
      };
      if (!raw) return base;
      const st = safeParse(raw, base);
      // harden:
      if (!Array.isArray(st.sentences) || st.sentences.length === 0) st.sentences = [ emptySentence() ];
      if (typeof st.activeIndex !== "number") st.activeIndex = 0;
      if (!st.custom) st.custom = { subject:[], time:[], place:[], object:[], verb:[], ending:[], connector:[] };
      return st;
    }

    function saveState(st){
      localStorage.setItem(LS_KEY, JSON.stringify(st));
    }

    function emptySentence(){
      return {
        subject: null,
        time: null,
        place: null,
        object: null,
        verb: null,
        ending: null,
        connector: null
      };
    }

    function loadFav(){
      const raw = localStorage.getItem(LS_FAV);
      const fav = safeParse(raw, []);
      return Array.isArray(fav) ? fav : [];
    }

    function saveFav(list){
      localStorage.setItem(LS_FAV, JSON.stringify(list));
    }

    // Conjugare foarte simplƒÉ (demo, stabil):
    // -ÏïÑÏöî/Ïñ¥Ïöî => (nu facem reguli complexe aici; punem verb + ending ‚Äúfrumos‚Äù)
    // Rest => verb fƒÉrƒÉ -Îã§ + ending (dacƒÉ ending √Æncepe cu -)
    function conjugate(verbKo, endingKo){
      if (!verbKo) return "";
      if (!endingKo) return verbKo;

      const cleanEnding = endingKo.startsWith("-") ? endingKo.slice(1) : endingKo;

      // dacƒÉ e "-ÏïÑÏöî/Ïñ¥Ïöî" doar arƒÉtƒÉm ca exemplu: verb(Stem)+Ïöî (aprox)
      if (endingKo === "-ÏïÑÏöî/Ïñ¥Ïöî"){
        // stem: scoatem "Îã§" dacƒÉ existƒÉ
        const stem = verbKo.endsWith("Îã§") ? verbKo.slice(0, -1) : verbKo;
        return stem + "Ïöî"; // simplificat
      }

      // general: stem + ending
      const stem = verbKo.endsWith("Îã§") ? verbKo.slice(0, -1) : verbKo;
      return stem + cleanEnding;
    }

    function sentenceKo(s){
      // Ordine simplƒÉ: [time] [place] [subject] [object] [verb+ending] [connector]
      // (po»õi schimba mai t√¢rziu)
      const parts = [];
      if (s.time?.ko) parts.push(s.time.ko);
      if (s.place?.ko) parts.push(s.place.ko);
      if (s.subject?.ko) parts.push(s.subject.ko);
      if (s.object?.ko) parts.push(s.object.ko);

      const v = conjugate(s.verb?.ko || "", s.ending?.ko || "");
      if (v) parts.push(v);

      if (s.connector?.ko) parts.push(s.connector.ko);

      return parts.join(" ").replace(/\s+/g," ").trim();
    }

    function sentenceRo(s){
      // Traducere aproximativƒÉ din RO-urile item-urilor
      const parts = [];
      if (s.time?.ro) parts.push(s.time.ro);
      if (s.place?.ro) parts.push(s.place.ro);
      if (s.subject?.ro) parts.push(s.subject.ro);
      if (s.object?.ro) parts.push(s.object.ro);
      if (s.verb?.ro) parts.push(s.verb.ro);
      if (s.ending?.ro) parts.push("(" + s.ending.ro + ")");
      if (s.connector?.ro) parts.push(s.connector.ro);
      const out = parts.join(" ¬∑ ").replace(/\s+/g," ").trim();
      return out || "‚Äî";
    }

    // --- UI / render ---
    const st = loadState();

    const tabsEl = $("#tabs");
    const slotsEl = $("#slots");
    const sentInfoEl = $("#sentInfo");
    const previewKoEl = $("#previewKo");
    const previewRoEl = $("#previewRo");
    const statusTextEl = $("#statusText");
    const favListEl = $("#favList");

    // overlay
    const overlayEl = $("#overlay");
    const panelTitleEl = $("#panelTitle");
    const panelSubEl = $("#panelSub");
    const searchInputEl = $("#searchInput");
    const listEl = $("#list");
    const newKoEl = $("#newKo");
    const newRoEl = $("#newRo");

    let currentSlotKey = null;

    function allItemsForKey(key){
      const base = DATA[key] || [];
      const custom = (st.custom?.[key] || []);
      return [...custom, ...base];
    }

    function renderTabs(){
      tabsEl.innerHTML = "";
      st.sentences.forEach((_, idx) => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "tab" + (idx === st.activeIndex ? " active" : "");
        b.innerHTML = `S${idx+1} <small>${idx===st.activeIndex ? "active" : ""}</small>`;
        b.addEventListener("click", () => {
          st.activeIndex = idx;
          saveState(st);
          renderAll();
        });
        tabsEl.appendChild(b);
      });
      sentInfoEl.textContent = `Sentence ${st.activeIndex+1} / ${st.sentences.length}`;
    }

    function renderSlots(){
      slotsEl.innerHTML = "";
      const s = st.sentences[st.activeIndex];

      SLOT_DEF.forEach(def => {
        const box = document.createElement("div");
        box.className = "slot";

        const top = document.createElement("div");
        top.className = "slotTop";

        const label = document.createElement("div");
        label.className = "slotLabel";
        label.textContent = def.label;

        const small = document.createElement("div");
        small.className = "small";
        small.textContent = def.key;

        top.appendChild(label);
        top.appendChild(small);

        const val = document.createElement("div");
        val.className = "slotValue";

        const chosen = s[def.key];
        const left = document.createElement("span");
        left.textContent = chosen?.ko || "Alege‚Ä¶";

        const right = document.createElement("em");
        right.textContent = chosen?.ro || "";

        val.appendChild(left);
        val.appendChild(right);

        val.addEventListener("click", () => openPicker(def.key));

        box.appendChild(top);
        box.appendChild(val);
        slotsEl.appendChild(box);
      });
    }

    function renderPreview(){
      const s = st.sentences[st.activeIndex];
      const ko = sentenceKo(s);
      previewKoEl.textContent = ko || "Alege cuvinte‚Ä¶";
      previewRoEl.textContent = sentenceRo(s);

      statusTextEl.textContent = ko ? "OK" : "‚Äî";
    }

    function renderFav(){
      const fav = loadFav().slice(-6).reverse();
      if (fav.length === 0){
        favListEl.textContent = "‚Äî";
        return;
      }
      favListEl.innerHTML = fav.map(x => `‚Ä¢ <b>${escapeHtml(x.ko)}</b> <span style="color:rgba(27,22,48,.65)">(${escapeHtml(x.ro||"")})</span>`).join("<br/>");
    }

    function renderAll(){
      renderTabs();
      renderSlots();
      renderPreview();
      renderFav();
    }

    // --- Picker ---
    function openPicker(key){
      currentSlotKey = key;
      const s = st.sentences[st.activeIndex];

      panelTitleEl.textContent = "Alege: " + key;
      panelSubEl.textContent = "Tap pe element ca sƒÉ √Æl selectezi. (Po»õi adƒÉuga »ôi custom.)";

      searchInputEl.value = "";
      newKoEl.value = "";
      newRoEl.value = "";

      overlayEl.classList.add("show");
      overlayEl.setAttribute("aria-hidden", "false");

      // list
      renderPickerList(key, "");

      // focus
      setTimeout(() => searchInputEl.focus(), 50);
    }

    function closePicker(){
      overlayEl.classList.remove("show");
      overlayEl.setAttribute("aria-hidden", "true");
      currentSlotKey = null;
    }

    function renderPickerList(key, q){
      const items = allItemsForKey(key);
      const query = (q || "").trim().toLowerCase();

      const filtered = !query ? items : items.filter(it => {
        const a = (it.ko || "").toLowerCase();
        const b = (it.ro || "").toLowerCase();
        return a.includes(query) || b.includes(query);
      });

      listEl.innerHTML = "";
      if (filtered.length === 0){
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `<div class="ko">Nimic gƒÉsit</div><div class="ro">√ÆncearcƒÉ alt text</div>`;
        div.style.cursor = "default";
        listEl.appendChild(div);
        return;
      }

      filtered.forEach(it => {
        const row = document.createElement("div");
        row.className = "item";
        row.innerHTML = `<div class="ko">${escapeHtml(it.ko)}</div><div class="ro">${escapeHtml(it.ro||"")}</div>`;
        row.addEventListener("click", () => {
          const s = st.sentences[st.activeIndex];
          s[key] = { ko: it.ko, ro: it.ro || "" };
          saveState(st);
          closePicker();
          renderAll();
        });
        listEl.appendChild(row);
      });
    }

    // --- Buttons ---
    $("#addSentenceBtn").addEventListener("click", () => {
      st.sentences.push(emptySentence());
      st.activeIndex = st.sentences.length - 1;
      saveState(st);
      renderAll();
    });

    $("#dupSentenceBtn").addEventListener("click", () => {
      const cur = st.sentences[st.activeIndex];
      st.sentences.push(JSON.parse(JSON.stringify(cur)));
      st.activeIndex = st.sentences.length - 1;
      saveState(st);
      renderAll();
    });

    $("#delSentenceBtn").addEventListener("click", () => {
      if (st.sentences.length === 1){
        st.sentences[0] = emptySentence();
      } else {
        st.sentences.splice(st.activeIndex, 1);
        st.activeIndex = Math.max(0, st.activeIndex - 1);
      }
      saveState(st);
      renderAll();
    });

    $("#clearBtn").addEventListener("click", () => {
      st.sentences[st.activeIndex] = emptySentence();
      saveState(st);
      renderAll();
    });

    $("#randomBtn").addEventListener("click", () => {
      const s = st.sentences[st.activeIndex];
      SLOT_DEF.forEach(def => {
        const arr = allItemsForKey(def.key);
        if (!arr || arr.length === 0) return;
        // connector e op»õional (random: uneori gol)
        if (def.key === "connector" && Math.random() < 0.55){
          s.connector = null;
          return;
        }
        const it = arr[Math.floor(Math.random() * arr.length)];
        s[def.key] = { ko: it.ko, ro: it.ro || "" };
      });
      saveState(st);
      renderAll();
    });

    $("#saveFavBtn").addEventListener("click", () => {
      const s = st.sentences[st.activeIndex];
      const ko = sentenceKo(s);
      const ro = sentenceRo(s);

      if (!ko){
        statusTextEl.textContent = "Alege √Ænt√¢i cuvinte.";
        return;
      }

      const fav = loadFav();
      fav.push({ ko, ro, ts: Date.now() });
      saveFav(fav);
      statusTextEl.textContent = "Saved ‚≠ê";
      renderFav();
    });

    $("#speakBtn").addEventListener("click", () => {
      const s = st.sentences[st.activeIndex];
      const ko = sentenceKo(s);
      if (!ko){
        statusTextEl.textContent = "Nu am ce citi.";
        return;
      }
      speakKorean(ko);
    });

    // overlay events
    $("#closeOverlayBtn").addEventListener("click", closePicker);
    overlayEl.addEventListener("click", (e) => {
      if (e.target === overlayEl) closePicker();
    });

    searchInputEl.addEventListener("input", (e) => {
      if (!currentSlotKey) return;
      renderPickerList(currentSlotKey, e.target.value);
    });

    $("#addCustomBtn").addEventListener("click", () => {
      if (!currentSlotKey) return;
      const ko = (newKoEl.value || "").trim();
      const ro = (newRoEl.value || "").trim();
      if (!ko) return;

      st.custom[currentSlotKey] = st.custom[currentSlotKey] || [];
      st.custom[currentSlotKey].unshift({ ko, ro });
      saveState(st);

      // refresh list with same search
      renderPickerList(currentSlotKey, searchInputEl.value);
      newKoEl.value = "";
      newRoEl.value = "";
      newKoEl.focus();
    });

    // --- Speech ---
    function speakKorean(text){
      try{
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "ko-KR";

        // alege voce coreeanƒÉ dacƒÉ existƒÉ
        const voices = speechSynthesis.getVoices ? speechSynthesis.getVoices() : [];
        const koVoice = voices.find(v => (v.lang || "").toLowerCase().startsWith("ko"));
        if (koVoice) u.voice = koVoice;

        speechSynthesis.cancel();
        speechSynthesis.speak(u);
        statusTextEl.textContent = "üîä Speaking‚Ä¶";
        u.onend = () => statusTextEl.textContent = "OK";
      } catch {
        statusTextEl.textContent = "Audio indisponibil.";
      }
    }

    // Safari/iOS: uneori voices se √ÆncarcƒÉ async
    if (typeof speechSynthesis !== "undefined" && speechSynthesis.onvoiceschanged !== undefined){
      speechSynthesis.onvoiceschanged = () => {};
    }

    // --- Utils ---
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // init
    renderAll();
  </script>
</body>
</html>
