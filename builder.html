<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<title>Raluca Korean – Sentence Builder</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: system-ui, -apple-system, Segoe UI, Roboto;
  background:#f4f6fb;
  padding:20px;
}
h1{margin-bottom:10px}
textarea{width:100%;height:80px}
button{margin:6px 4px;padding:6px 12px;font-weight:600}

.table-block{
  background:#fff;
  border-radius:14px;
  padding:12px;
  margin-bottom:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
.table{
  display:flex;
  gap:6px;
  overflow-x:auto;
}
.col{
  min-width:120px;
  border:1px solid #ddd;
  border-radius:10px;
  padding:6px;
}
.col h4{
  margin:0;
  font-size:11px;
  text-align:center;
  color:#555;
}
.col div{
  margin-top:4px;
  min-height:28px;
  border:1px dashed #ccc;
  border-radius:6px;
  padding:4px;
}
.col div[contenteditable]{outline:none}

#preview{
  background:#fff;
  padding:14px;
  border-radius:14px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
}
#previewSentence{
  font-size:22px;
  font-weight:900;
  margin-top:6px;
}
</style>
</head>

<body>

<h1>Raluca Korean – Builder</h1>

<textarea id="inputText"
placeholder="Ex: Astăzi merg la cafenea și citesc o carte și beau o cafea."></textarea>
<br>
<button id="addClause">+ Clauză</button>
<button id="resetAll">Reset</button>

<label style="margin-left:12px">
  <input type="checkbox" id="politeToggle"> Polite (ultima clauză)
</label>

<h2>Builder</h2>
<div id="clausesHost"></div>

<div id="preview">
  <div>Propoziția finală:</div>
  <div id="previewSentence">저 가요</div>
</div>

<script>
 /* ======================================================
   RALUCA KOREAN — BUILDER.JS (FINAL, FULL, STABLE)
   ====================================================== */
(function () {
  "use strict";

  /* =========================
     HELPERS — HANGUL
  ========================= */
  function lastHangulChar(str) {
    const s = (str || "").trim();
    return s ? s[s.length - 1] : "";
  }

  function hasBatchim(char) {
    if (!char) return false;
    const code = char.charCodeAt(0);
    if (code < 0xac00 || code > 0xd7a3) return false;
    return (code - 0xac00) % 28 !== 0;
  }

  /* =========================
     PARTICLES
  ========================= */
  function subjectParticle(word) {
    if (!word) return "";
    return hasBatchim(lastHangulChar(word)) ? "은" : "는";
  }

  function objectParticle(word) {
    if (!word) return "";
    return hasBatchim(lastHangulChar(word)) ? "을" : "를";
  }

  function placeParticle(place, verb) {
    if (!place) return "";
    if (verb === "가다" || verb === "오다") return "에";
    return "에서";
  }

  /* =========================
     ENDINGS
  ========================= */
  function attachEnding(verbInf, ending) {
    if (!verbInf || !ending) return verbInf;
    if (!verbInf.endsWith("다")) return verbInf;

    const stem = verbInf.slice(0, -1);
    const last = lastHangulChar(stem);
    const batchim = hasBatchim(last);

    if (ending === "-고") return stem + "고";
    if (ending === "-지만") return stem + "지만";
    if (ending === "-아서" || ending === "-어서") return stem + ending.slice(1);
    if (ending === "-(으)면") return stem + (batchim ? "으면" : "면");
    if (ending === "-(으)ㄹ 때") return stem + (batchim ? "을 때" : "ㄹ 때");
    if (ending === "-(으)려고") return stem + (batchim ? "으려고" : "려고");

    return stem + ending.replace(/^[-]/, "");
  }

  function politePresent(verbInf) {
    if (!verbInf || !verbInf.endsWith("다")) return verbInf;
    if (verbInf === "하다") return "해요";

    const stem = verbInf.slice(0, -1);
    const last = lastHangulChar(stem);
    const code = last.charCodeAt(0);
    const jung = Math.floor(((code - 0xac00) % (21 * 28)) / 28);
    const aGroup = [0, 2, 8, 9]; // ㅏ ㅑ ㅗ ㅛ
    return stem + (aGroup.includes(jung) ? "아요" : "어요");
  }

  /* =========================
     DOM HELPERS
  ========================= */
  function cell(tableId, key) {
    return document.querySelector(
      `#${tableId} .col[data-key="${key}"] .col-body-main`
    );
  }

  function read(tableId, key) {
    const c = cell(tableId, key);
    return c ? c.textContent.trim() : "";
  }

  function write(tableId, key, value) {
    const c = cell(tableId, key);
    if (c) c.textContent = value || "";
  }

  /* =========================
     BUILD CLAUSE
  ========================= */
  function buildClause(idx, isLast, polite) {
    const tableId = "tableP" + (idx + 1);

    const subject = read(tableId, "subject");
    const time = read(tableId, "time");
    const placeBase = read(tableId, "place");
    const mod = read(tableId, "mod");
    const object = read(tableId, "object");
    const numeral = read(tableId, "numeral");
    const counter = read(tableId, "counter");
    const verbInf = read(tableId, "verb");
    const conj = read(tableId, "conj");

    let subjectOut = subject ? subject + subjectParticle(subject) : "";
    let objectOut = "";

    if (object && numeral && counter)
      objectOut =
        numeral + " " + counter + objectParticle(counter);
    else if (object)
      objectOut = object + objectParticle(object);

    let placeOut = placeBase
      ? placeBase + placeParticle(placeBase, verbInf)
      : "";

    let verbOut = attachEnding(verbInf, conj);

    if (isLast && polite && !conj) {
      verbOut = politePresent(verbInf);
    }

    return [
      subjectOut,
      time,
      placeOut,
      mod,
      objectOut,
      verbOut
    ]
      .filter(Boolean)
      .join(" ");
  }

  /* =========================
     PREVIEW
  ========================= */
  function rebuildPreview() {
    const blocks = document.querySelectorAll("[data-clause-index]");
    const polite = document.getElementById("politeToggle")?.checked;
    const out = document.getElementById("previewSentence");

    const parts = [];
    blocks.forEach((_, i) => {
      const clause = buildClause(i, i === blocks.length - 1, polite);
      if (clause) parts.push(clause);
    });

    out.textContent = parts.join(" ").trim() || "저 가요";
  }

  /* =========================
     LIVE UPDATE
  ========================= */
  function wire() {
    document.addEventListener("input", e => {
      if (e.target.classList.contains("col-body-main")) {
        rebuildPreview();
      }
    });

    document
      .getElementById("politeToggle")
      ?.addEventListener("change", rebuildPreview);
  }

  /* =========================
     INIT
  ========================= */
  function init() {
    wire();
    rebuildPreview();
  }

  window.addEventListener("DOMContentLoaded", init);
})(); 

</script>

</body>
</html>
