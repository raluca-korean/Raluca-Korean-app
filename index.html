<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sentence Builder ‚Äî Premium</title>
  <style>
    :root{
      /* Premium light theme (clean, TTMIK-ish) */
      --bg:#f6f7fb;
      --paper:#ffffff;
      --ink:#101526;
      --muted:#5b647a;
      --line:#dfe4f0;

      --green:#1f7a5a;
      --greenSoft:#eaf6f1;
      --blueSoft:#eef4ff;
      --chip:#f3f5fb;

      --shadow:0 10px 26px rgba(18,24,38,.08);
      --r:18px;
      --r2:14px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:var(--bg);
      color:var(--ink);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:20px 14px 46px}

    .header{
      display:flex;gap:12px;align-items:stretch;justify-content:space-between;flex-wrap:wrap;
      margin-bottom:12px;
    }
    .card{
      background:var(--paper);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
    }
    .hero{flex:1;min-width:min(720px,100%);padding:16px 18px}
    .hero h1{margin:0;font-size:18px;letter-spacing:.2px}
    .hero p{margin:6px 0 0 0;color:var(--muted);font-size:13px;line-height:1.45}

    .ctrl{min-width:320px;padding:16px 18px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted)}
    select,input,button{
      font:inherit;
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px 12px;
      background:#fff;
      color:var(--ink);
      outline:none;
    }
    select{min-width:240px}
    button{
      cursor:pointer;
      background:var(--chip);
    }
    button.primary{
      background:var(--green);
      border-color:var(--green);
      color:#fff;
    }
    button.ghost{background:#fff}
    button:active{transform:translateY(1px)}

    .grid{
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media(max-width: 980px){
      .grid{grid-template-columns:1fr}
      select{min-width:100%}
    }

    .section{padding:16px 18px}
    .section h2{
      margin:0 0 10px 0;
      font-size:12px;
      letter-spacing:.6px;
      text-transform:uppercase;
      color:var(--muted);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
    }

    /* A/B/C cards */
    .abc{display:grid;grid-template-columns:1fr;gap:10px}
    .box{
      border:1px solid var(--line);
      border-radius:var(--r2);
      padding:12px 12px;
      background:#fff;
    }
    .tag{
      display:flex;align-items:center;gap:8px;
      font-size:12px;color:var(--muted);
      margin-bottom:8px;
    }
    .tag b{
      font-size:12px;
      color:#fff;
      background:var(--green);
      border-radius:999px;
      padding:4px 10px;
      letter-spacing:.2px;
    }
    .ko{margin:0;font-size:20px;line-height:1.25}
    .tr{margin:7px 0 0 0;color:var(--muted);font-size:13px;line-height:1.45}

    .miniActions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .mini{font-size:12px;padding:8px 10px;border-radius:10px}

    .line{height:1px;background:var(--line);margin:12px 0}

    /* Flow */
    .flow{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .step{
      border:1px solid var(--line);
      border-radius:var(--r2);
      background:linear-gradient(180deg, #fff, #fff);
      overflow:hidden;
    }
    .sh{
      padding:10px 12px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.02);
    }
    .sh .left{
      display:flex;flex-direction:column;gap:2px
    }
    .sh .left b{font-size:12px;letter-spacing:.3px}
    .sh .left span{font-size:12px;color:var(--muted)}
    .sb{padding:12px 12px}

    .chips{display:flex;flex-wrap:wrap;gap:8px}
    .chip{
      border:1px solid var(--line);
      background:var(--chip);
      border-radius:999px;
      padding:8px 10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      display:inline-flex;gap:8px;align-items:center;
    }
    .chip.active{
      background:var(--greenSoft);
      border-color:rgba(31,122,90,.35);
    }
    .chip .k{font-family:var(--mono);font-size:11px;color:var(--muted)}
    .hint{font-size:12px;color:var(--muted);line-height:1.45}

    .final{
      border:1px solid rgba(31,122,90,.30);
      background:var(--greenSoft);
      border-radius:var(--r2);
      padding:12px 12px;
    }
    .final .ko{font-size:19px}
    .final .tr{color:#355b4f}

    /* Review (fill-in) */
    .review{
      border:1px solid var(--line);
      border-radius:var(--r2);
      background:var(--blueSoft);
      padding:12px 12px;
      display:flex;flex-direction:column;gap:10px;
    }
    .blank{
      display:inline-block;
      min-width:80px;
      border-bottom:2px solid rgba(16,21,38,.25);
      padding:0 6px 2px 6px;
      font-family:var(--mono);
    }
    .ok{color:var(--green);font-weight:600}
    .bad{color:#c43b4f;font-weight:600}

    /* Translator */
    .translator{
      border:1px solid var(--line);
      border-radius:var(--r2);
      padding:12px 12px;
      background:#fff;
    }
    .status{font-size:12px;color:var(--muted);margin-top:8px}

    /* Tiny pill */
    .pill{
      font-size:11px;color:var(--muted);
      border:1px solid var(--line);
      padding:4px 8px;border-radius:999px;
      background:#fff;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="header">
      <div class="card hero">
        <h1>Sentence Builder ‚Äî Premium (A / B / C ‚Üí 1 frazƒÉ)</h1>
        <p>
          Totul e clar: vezi A, B, C separat; alegi ADD/MODIFY; apoi COMBINE √Æn 2 pa»ôi; ai FINAL + Review (fill-in) + RO‚ÜîKO offline.
          Static, gratis, gata de lipit √Æn aplica»õia mare.
        </p>
      </div>

      <div class="card ctrl">
        <div class="row">
          <label>Scenariu</label>
          <select id="scenario"></select>
        </div>
        <div class="row">
          <label>Traducere</label>
          <select id="lang">
            <option value="ro">RO</option>
            <option value="en">EN</option>
          </select>
        </div>
        <div class="row">
          <button class="primary" id="auto">Auto (TTMIK)</button>
          <button class="ghost" id="reset">Reset</button>
        </div>
        <div class="hint">
          Auto aplicƒÉ: <span class="pill">Ï†ïÎßê</span> + <span class="pill">Î¨º‚ÜíÎú®Í±∞Ïö¥ Î¨º</span> + conectori clasici.
        </div>
      </div>
    </div>

    <div class="grid">

      <!-- LEFT: A/B/C -->
      <div class="card section">
        <h2>Cele 3 propozi»õii <span class="pill">A / B / C</span></h2>

        <div class="abc">
          <div class="box" id="boxA"></div>
          <div class="box" id="boxB"></div>
          <div class="box" id="boxC"></div>
        </div>

        <div class="line"></div>

        <h2>Rezultatul final <span class="pill">FINAL</span></h2>
        <div class="final" id="final"></div>

        <div class="miniActions">
          <button class="mini primary" id="speakFinal">üîä Audio</button>
          <button class="mini" id="copyFinal">Copy</button>
        </div>

        <div class="line"></div>

        <h2>Review (fill-in) <span class="pill">Practice</span></h2>
        <div class="review">
          <div class="hint" id="reviewHint"></div>
          <div id="reviewQ" class="ko" style="font-size:16px;line-height:1.5"></div>
          <div class="row" style="width:100%">
            <input id="reviewInput" type="text" placeholder="CompleteazƒÉ blank-ul‚Ä¶" style="width:100%" />
          </div>
          <div class="row">
            <button class="mini" id="checkReview">Check</button>
            <button class="mini" id="showAnswer">Show answer</button>
            <span id="reviewResult" class="status"></span>
          </div>
        </div>
      </div>

      <!-- RIGHT: Flow + Translator -->
      <div class="card section">
        <h2>Flow (ADD ‚Üí MODIFY ‚Üí COMBINE) <span class="pill">logicƒÉ vizibilƒÉ</span></h2>

        <div class="flow">

          <div class="step">
            <div class="sh">
              <div class="left">
                <b>1) ADD</b>
                <span>Adaugi adverb / marker (ex: Ï†ïÎßê, Í∞ëÏûêÍ∏∞, Í∑∏ÎûòÏÑú)</span>
              </div>
              <span class="pill" id="addCount">0 selected</span>
            </div>
            <div class="sb">
              <div class="chips" id="adds"></div>
            </div>
          </div>

          <div class="step">
            <div class="sh">
              <div class="left">
                <b>2) MODIFY</b>
                <span>Alegi o modificare (ex: Î¨º ‚Üí Îú®Í±∞Ïö¥ Î¨º)</span>
              </div>
              <span class="pill" id="modStatus">none</span>
            </div>
            <div class="sb">
              <div class="chips" id="mods"></div>
            </div>
          </div>

          <div class="step">
            <div class="sh">
              <div class="left">
                <b>3) COMBINE</b>
                <span>Legi propozi»õiile √Æn 2 pa»ôi (A‚ÜíB, apoi (A+B)‚ÜíC)</span>
              </div>
              <span class="pill">connectors</span>
            </div>
            <div class="sb">
              <div class="row">
                <label>A ‚Üí B</label>
                <select id="c1"></select>
              </div>
              <div class="row">
                <label>(A+B) ‚Üí C</label>
                <select id="c2"></select>
              </div>
              <div class="hint" style="margin-top:8px">
                Recomandare clasicƒÉ: <span class="pill">-(Ïúº)„Ñ¥Îç∞</span> apoi <span class="pill">-ÏïÑ/Ïñ¥/Ïó¨ÏÑú</span>
              </div>
            </div>
          </div>

        </div>

        <div class="line"></div>

        <h2>Translator RO ‚Üî KO (offline) <span class="pill">auto</span></h2>
        <div class="translator">
          <div class="hint">Scrii √Æntr-o parte, apare automat √Æn cealaltƒÉ. Func»õioneazƒÉ pentru ce ai √Æn dic»õionarul tƒÉu (PHRASES/WORDS).</div>
          <div class="line"></div>
          <div class="row" style="width:100%">
            <input id="roIn" type="text" placeholder="Scrie √Æn rom√¢nƒÉ‚Ä¶" style="width:100%" />
          </div>
          <div class="row" style="width:100%">
            <input id="koIn" type="text" placeholder="ÌïúÍµ≠Ïñ¥Î°ú Ïì∞ÏÑ∏Ïöî‚Ä¶" style="width:100%" />
          </div>
          <div class="row">
            <button class="mini" id="addPhrase">AdaugƒÉ ca PHRASE</button>
            <button class="mini ghost" id="clearTr">Clear</button>
          </div>
          <div class="status" id="trStatus"></div>
        </div>

        <div class="line"></div>

        <h2>Unde editezi con»õinutul <span class="pill">√Æn cod</span></h2>
        <div class="hint">
          Adaugi scenarii noi √Æn <b>SCENARIOS</b>. A/B/C sunt √Æn <span style="font-family:var(--mono)">base.A / base.B / base.C</span>.
          Dic»õionarul offline e √Æn <b>PHRASES</b> »ôi <b>WORDS</b>.
        </div>
      </div>

    </div>
  </div>

  <script>
    /* =========================================================
       1) Con»õinut: A/B/C + add/modify/connectors
       ========================================================= */
    const SCENARIOS = [
      {
        id:"ttmik_ch13",
        name:"Cap. 13 ‚Äî din»õi / apƒÉ fierbinte / surprins",
        base:{
          A:{ ko:"ÏñëÏπòÌïòÎ†§Í≥† ÏªµÏóê Î¨ºÏùÑ Î∞õÏïòÏñ¥Ïöî.", ro:"Am umplut un pahar cu apƒÉ ca sƒÉ mƒÉ spƒÉl pe din»õi.", en:"I filled a cup with water to brush my teeth." },
          B:{ ko:"Î¨ºÏù¥ ÎÇòÏôîÏñ¥Ïöî.", ro:"A ie»ôit apƒÉ.", en:"Water came out." },
          C:{ ko:"ÎÜÄÎûêÏñ¥Ïöî.", ro:"Am fost surprins(ƒÉ).", en:"I was surprised." }
        },
        add:[
          {id:"add_really", ko:"Ï†ïÎßê", ro:"foarte / chiar", en:"really"},
          {id:"add_suddenly", ko:"Í∞ëÏûêÍ∏∞", ro:"dintr-odatƒÉ", en:"suddenly"},
          {id:"add_so", ko:"Í∑∏ÎûòÏÑú", ro:"de aceea", en:"so"}
        ],
        modify:[
          {id:"mod_hotwater", label:"Î¨º ‚Üí Îú®Í±∞Ïö¥ Î¨º", target:"B", type:"replace", from:"Î¨º", to:"Îú®Í±∞Ïö¥ Î¨º"},
          {id:"mod_very_surprised", label:"ÎÜÄÎûêÏñ¥Ïöî ‚Üí Ï†ïÎßê ÎÜÄÎûêÏñ¥Ïöî", target:"C", type:"prefix", prefix:"Ï†ïÎßê "}
        ],
        connectors:[
          {id:"c_but", label:"-(Ïúº)„Ñ¥Îç∞ (dar/√ÆnsƒÉ)", apply:(a,b)=> a.replace("Ïöî.","") + "ÎäîÎç∞, " + b},
          {id:"c_reason", label:"-ÏïÑ/Ïñ¥/Ïó¨ÏÑú (cauzƒÉ)", apply:(a,b)=> a.replace("Ïöî.","") + "ÏÑú " + b},
          {id:"c_intent", label:"-(Ïúº)Î†§Í≥† (inten»õie)", apply:(a,b)=> a.replace("Ïöî.","") + " " + b},
          {id:"c_and", label:"Í∑∏Î¶¨Í≥† (»ôi)", apply:(a,b)=> a + " Í∑∏Î¶¨Í≥† " + b}
        ],
        defaults:{ c1:"c_but", c2:"c_reason", autoAdds:["add_really"], autoMod:"mod_hotwater" },
        review:{
          hintRO:"CompleteazƒÉ cu conectorul corect (ca √Æn TTMIK).",
          q:"ÏñëÏπòÌïòÎ†§Í≥† ÏªµÏóê Î¨ºÏùÑ Î∞õÏïò__ , Îú®Í±∞Ïö¥ Î¨ºÏù¥ ÎÇòÏôîÏñ¥Ïöî.",
          answer:"ÎäîÎç∞"
        }
      }
    ];

    /* =========================================================
       2) Dic»õionar offline pentru RO‚ÜîKO (editezi aici)
       ========================================================= */
    const PHRASES = {
      ro2ko:{
        "Am fost surprins(ƒÉ).":"ÎÜÄÎûêÏñ¥Ïöî.",
        "Am fost foarte surprins(ƒÉ).":"Ï†ïÎßê ÎÜÄÎûêÏñ¥Ïöî.",
        "A ie»ôit apƒÉ fierbinte.":"Îú®Í±∞Ïö¥ Î¨ºÏù¥ ÎÇòÏôîÏñ¥Ïöî.",
        "Am umplut un pahar cu apƒÉ.":"ÏªµÏóê Î¨ºÏùÑ Î∞õÏïòÏñ¥Ïöî.",
        "Am umplut un pahar cu apƒÉ ca sƒÉ mƒÉ spƒÉl pe din»õi.":"ÏñëÏπòÌïòÎ†§Í≥† ÏªµÏóê Î¨ºÏùÑ Î∞õÏïòÏñ¥Ïöî."
      },
      ko2ro:{
        "ÎÜÄÎûêÏñ¥Ïöî.":"Am fost surprins(ƒÉ).",
        "Ï†ïÎßê ÎÜÄÎûêÏñ¥Ïöî.":"Am fost foarte surprins(ƒÉ).",
        "Îú®Í±∞Ïö¥ Î¨ºÏù¥ ÎÇòÏôîÏñ¥Ïöî.":"A ie»ôit apƒÉ fierbinte.",
        "ÏªµÏóê Î¨ºÏùÑ Î∞õÏïòÏñ¥Ïöî.":"Am umplut un pahar cu apƒÉ.",
        "ÏñëÏπòÌïòÎ†§Í≥† ÏªµÏóê Î¨ºÏùÑ Î∞õÏïòÏñ¥Ïöî.":"Am umplut un pahar cu apƒÉ ca sƒÉ mƒÉ spƒÉl pe din»õi."
      }
    };

    const WORDS = {
      ro2ko:{ "apƒÉ":"Î¨º","fierbinte":"Îú®Í±∞Ïö¥","de":"Ïùò","aceea":"Í∑∏ÎûòÏÑú","dintr-odatƒÉ":"Í∞ëÏûêÍ∏∞","foarte":"Ï†ïÎßê" },
      ko2ro:{ "Î¨º":"apƒÉ","Îú®Í±∞Ïö¥":"fierbinte","Í∑∏ÎûòÏÑú":"de aceea","Í∞ëÏûêÍ∏∞":"dintr-odatƒÉ","Ï†ïÎßê":"foarte" }
    };

    /* =========================================================
       3) UI + State
       ========================================================= */
    const $ = (s)=>document.querySelector(s);
    const scenarioSel = $("#scenario");
    const langSel = $("#lang");

    const boxA = $("#boxA"), boxB = $("#boxB"), boxC = $("#boxC");
    const addsEl = $("#adds"), modsEl = $("#mods");
    const c1El = $("#c1"), c2El = $("#c2");
    const finalEl = $("#final");

    const addCountEl = $("#addCount");
    const modStatusEl = $("#modStatus");

    const reviewHint = $("#reviewHint");
    const reviewQ = $("#reviewQ");
    const reviewInput = $("#reviewInput");
    const reviewResult = $("#reviewResult");

    const state = {
      scenarioId: SCENARIOS[0].id,
      lang:"ro",
      adds:new Set(),
      mod:null,
      c1:null,
      c2:null
    };

    function scenario(){ return SCENARIOS.find(s=>s.id===state.scenarioId) || SCENARIOS[0]; }
    function tr(obj){ return state.lang==="ro" ? obj.ro : obj.en; }
    function esc(s){ return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

    function renderScenarioOptions(){
      scenarioSel.innerHTML = SCENARIOS.map(s=>`<option value="${esc(s.id)}">${esc(s.name)}</option>`).join("");
      scenarioSel.value = state.scenarioId;
    }

    function renderConnectors(){
      const s = scenario();
      const opts = s.connectors.map(c=>`<option value="${esc(c.id)}">${esc(c.label)}</option>`).join("");
      c1El.innerHTML = opts;
      c2El.innerHTML = opts;

      state.c1 = state.c1 || s.defaults.c1;
      state.c2 = state.c2 || s.defaults.c2;
      c1El.value = state.c1;
      c2El.value = state.c2;
    }

    function renderAddsMods(){
      const s = scenario();

      addsEl.innerHTML = s.add.map(a=>{
        const active = state.adds.has(a.id) ? "active" : "";
        const sub = state.lang==="ro" ? a.ro : a.en;
        return `<div class="chip ${active}" data-add="${esc(a.id)}"><span>${esc(a.ko)}</span><span class="k">${esc(sub)}</span></div>`;
      }).join("");

      modsEl.innerHTML = s.modify.map(m=>{
        const active = state.mod===m.id ? "active" : "";
        return `<div class="chip ${active}" data-mod="${esc(m.id)}"><span>${esc(m.label)}</span><span class="k">MODIFY</span></div>`;
      }).join("");

      addCountEl.textContent = `${state.adds.size} selected`;
      modStatusEl.textContent = state.mod ? "1 selected" : "none";
    }

    function applyMod(ko, mod){
      if(!mod) return ko;
      if(mod.type==="replace") return ko.replace(mod.from, mod.to);
      if(mod.type==="prefix") return (mod.prefix||"") + ko;
      return ko;
    }

    function applyAddsToClauses(A,B,C){
      if(state.adds.has("add_suddenly") && !B.startsWith("Í∞ëÏûêÍ∏∞")) B = "Í∞ëÏûêÍ∏∞ " + B;
      if(state.adds.has("add_really") && !C.startsWith("Ï†ïÎßê") && state.mod!=="mod_very_surprised") C = "Ï†ïÎßê " + C;
      if(state.adds.has("add_so") && !C.startsWith("Í∑∏ÎûòÏÑú")) C = "Í∑∏ÎûòÏÑú " + C;
      return {A,B,C};
    }

    function combine(a,b,conn){ return conn.apply(a,b); }

    function renderABCandFinal(){
      const s = scenario();

      let A = s.base.A.ko;
      let B = s.base.B.ko;
      let C = s.base.C.ko;

      const mod = s.modify.find(x=>x.id===state.mod) || null;
      if(mod){
        if(mod.target==="A") A = applyMod(A, mod);
        if(mod.target==="B") B = applyMod(B, mod);
        if(mod.target==="C") C = applyMod(C, mod);
      }

      ({A,B,C} = applyAddsToClauses(A,B,C));

      boxA.innerHTML = `
        <div class="tag"><b>A</b> Propozi»õia 1 (inten»õie/ac»õiune)</div>
        <p class="ko">${esc(A)}</p>
        <p class="tr">${esc(tr(s.base.A))}</p>
        <div class="miniActions">
          <button class="mini" data-speak="${esc(A)}">üîä Audio</button>
          <button class="mini" data-copy="${esc(A)}">Copy</button>
        </div>
      `;
      boxB.innerHTML = `
        <div class="tag"><b>B</b> Propozi»õia 2 (eveniment)</div>
        <p class="ko">${esc(B)}</p>
        <p class="tr">${esc(tr(s.base.B))}</p>
        <div class="miniActions">
          <button class="mini" data-speak="${esc(B)}">üîä Audio</button>
          <button class="mini" data-copy="${esc(B)}">Copy</button>
        </div>
      `;
      boxC.innerHTML = `
        <div class="tag"><b>C</b> Propozi»õia 3 (reac»õie)</div>
        <p class="ko">${esc(C)}</p>
        <p class="tr">${esc(tr(s.base.C))}</p>
        <div class="miniActions">
          <button class="mini" data-speak="${esc(C)}">üîä Audio</button>
          <button class="mini" data-copy="${esc(C)}">Copy</button>
        </div>
      `;

      const conn1 = s.connectors.find(c=>c.id===state.c1) || s.connectors[0];
      const conn2 = s.connectors.find(c=>c.id===state.c2) || s.connectors[0];

      const AB = combine(A,B,conn1);
      const ABC = combine(AB,C,conn2);

      finalEl.innerHTML = `
        <p class="ko">${esc(ABC)}</p>
        <p class="tr">${esc(tr(s.base.A))} + ${esc(tr(s.base.B))} + ${esc(tr(s.base.C))}</p>
      `;

      // Review
      reviewHint.textContent = (state.lang==="ro") ? s.review.hintRO : "Fill in the correct connector (TTMIK style).";
      reviewQ.innerHTML = esc(s.review.q).replace("__", `<span class="blank" id="blank"></span>`);
      reviewResult.textContent = "";
      reviewInput.value = "";
    }

    function init(){
      renderScenarioOptions();
      renderConnectors();
      renderAddsMods();
      renderABCandFinal();
    }

    scenarioSel.addEventListener("change", ()=>{
      state.scenarioId = scenarioSel.value;
      state.adds.clear();
      state.mod = null;
      state.c1 = null;
      state.c2 = null;
      renderConnectors();
      renderAddsMods();
      renderABCandFinal();
    });

    langSel.addEventListener("change", ()=>{
      state.lang = langSel.value;
      renderAddsMods();
      renderABCandFinal();
    });

    addsEl.addEventListener("click", (e)=>{
      const chip = e.target.closest("[data-add]");
      if(!chip) return;
      const id = chip.getAttribute("data-add");
      if(state.adds.has(id)) state.adds.delete(id); else state.adds.add(id);
      renderAddsMods();
      renderABCandFinal();
    });

    modsEl.addEventListener("click", (e)=>{
      const chip = e.target.closest("[data-mod]");
      if(!chip) return;
      const id = chip.getAttribute("data-mod");
      state.mod = (state.mod===id) ? null : id;
      renderAddsMods();
      renderABCandFinal();
    });

    c1El.addEventListener("change", ()=>{ state.c1 = c1El.value; renderABCandFinal(); });
    c2El.addEventListener("change", ()=>{ state.c2 = c2El.value; renderABCandFinal(); });

    $("#reset").addEventListener("click", ()=>{
      const s = scenario();
      state.adds.clear();
      state.mod = null;
      state.c1 = s.defaults.c1;
      state.c2 = s.defaults.c2;
      renderConnectors();
      renderAddsMods();
      renderABCandFinal();
    });

    $("#auto").addEventListener("click", ()=>{
      const s = scenario();
      state.adds.clear();
      (s.defaults.autoAdds||[]).forEach(x=>state.adds.add(x));
      state.mod = s.defaults.autoMod || null;
      state.c1 = s.defaults.c1;
      state.c2 = s.defaults.c2;
      renderConnectors();
      renderAddsMods();
      renderABCandFinal();
    });

    /* =========================================================
       Copy + Audio (delegation)
       ========================================================= */
    async function copyText(t){
      try{ await navigator.clipboard.writeText(t); }
      catch{
        const ta=document.createElement("textarea"); ta.value=t; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); ta.remove();
      }
    }
    function speakKo(text){
      if(!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ko-KR";
      window.speechSynthesis.speak(u);
    }

    document.addEventListener("click", (e)=>{
      const bSpeak = e.target.closest("[data-speak]");
      if(bSpeak){ speakKo(bSpeak.getAttribute("data-speak")); return; }
      const bCopy = e.target.closest("[data-copy]");
      if(bCopy){ copyText(bCopy.getAttribute("data-copy")); return; }
    });

    $("#copyFinal").addEventListener("click", ()=>{
      const t = finalEl.querySelector(".ko")?.textContent || "";
      copyText(t);
    });
    $("#speakFinal").addEventListener("click", ()=>{
      const t = finalEl.querySelector(".ko")?.textContent || "";
      speakKo(t);
    });

    /* =========================================================
       Review logic
       ========================================================= */
    $("#checkReview").addEventListener("click", ()=>{
      const s = scenario();
      const ans = (s.review.answer || "").trim();
      const user = (reviewInput.value || "").trim();
      if(!user){
        reviewResult.innerHTML = `CompleteazƒÉ blank-ul.`;
        return;
      }
      reviewResult.innerHTML = (user === ans)
        ? `<span class="ok">Corect.</span>`
        : `<span class="bad">Gre»ôit.</span> Corect: <b>${esc(ans)}</b>`;
      const blank = document.getElementById("blank");
      if(blank) blank.textContent = user;
    });

    $("#showAnswer").addEventListener("click", ()=>{
      const s = scenario();
      const ans = (s.review.answer || "").trim();
      const blank = document.getElementById("blank");
      if(blank) blank.textContent = ans;
      reviewResult.innerHTML = `RƒÉspuns: <b>${esc(ans)}</b>`;
    });

    /* =========================================================
       Translator RO‚ÜîKO offline (auto)
       ========================================================= */
    const roIn = $("#roIn"), koIn = $("#koIn"), trStatus = $("#trStatus");
    let lock=false;

    function norm(s){ return s.trim().replace(/\s+/g," ").replace(/ +([.,!?;:])/g,"$1"); }

    function ro2ko(ro){
      const key = norm(ro);
      if(PHRASES.ro2ko[key]) return {ok:true,out:PHRASES.ro2ko[key],mode:"PHRASE"};
      const tokens = key.toLowerCase().replace(/[.,!?;:]/g,"").split(" ").filter(Boolean);
      let miss=[];
      const out = tokens.map(t=>{ const x=WORDS.ro2ko[t]; if(!x) miss.push(t); return x||t; }).join(" ");
      return miss.length ? {ok:false,out,mode:"WORDS",missing:miss} : {ok:true,out,mode:"WORDS"};
    }

    function ko2ro(ko){
      const key = norm(ko);
      if(PHRASES.ko2ro[key]) return {ok:true,out:PHRASES.ko2ro[key],mode:"PHRASE"};
      const tokens = key.replace(/[.,!?;:]/g,"").split(" ").filter(Boolean);
      let miss=[];
      const out = tokens.map(t=>{ const x=WORDS.ko2ro[t]; if(!x) miss.push(t); return x||t; }).join(" ");
      return miss.length ? {ok:false,out,mode:"WORDS",missing:miss} : {ok:true,out,mode:"WORDS"};
    }

    function setStatus(r){
      if(!r){ trStatus.textContent=""; return; }
      trStatus.textContent = r.ok
        ? `OK (${r.mode})`
        : `Nu existƒÉ complet √Æn dic»õionar (${r.mode}). Lipsesc: ${r.missing.join(", ")}`;
    }

    roIn.addEventListener("input", ()=>{
      if(lock) return; lock=true;
      const v=roIn.value;
      if(!v.trim()){ koIn.value=""; setStatus(null); lock=false; return; }
      const r=ro2ko(v); koIn.value=r.out; setStatus(r);
      lock=false;
    });

    koIn.addEventListener("input", ()=>{
      if(lock) return; lock=true;
      const v=koIn.value;
      if(!v.trim()){ roIn.value=""; setStatus(null); lock=false; return; }
      const r=ko2ro(v); roIn.value=r.out; setStatus(r);
      lock=false;
    });

    $("#addPhrase").addEventListener("click", ()=>{
      const ro = norm(roIn.value);
      const ko = norm(koIn.value);
      if(!ro || !ko){ trStatus.textContent = "CompleteazƒÉ »ôi RO »ôi KO √Ænainte sƒÉ adaugi."; return; }
      PHRASES.ro2ko[ro]=ko;
      PHRASES.ko2ro[ko]=ro;
      trStatus.textContent = "PHRASE adƒÉugat (√Æn memorie). Pentru permanent: copiezi √Æn PHRASES din cod.";
    });

    $("#clearTr").addEventListener("click", ()=>{
      roIn.value=""; koIn.value=""; trStatus.textContent="";
    });

    init();
  </script>
</body>
</html>
