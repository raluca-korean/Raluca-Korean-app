<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Raluca Korean ‚Äì Builder P2 Test (Clean)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --bg1:#dff3ff; --bg2:#ffe9ff; --bg3:#f4fffc; --bg4:#e8f0ff;
      --accent:#7b5dff; --card-bg:#ffffffcc;
      --text-main:#2f343b; --text-soft:#7a8088; --border:#e1d7c7;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--text-main);
      background:linear-gradient(120deg,var(--bg1),var(--bg2),var(--bg3),var(--bg4));
      background-size:380% 380%;
      animation:bgFlow 28s ease-in-out infinite;
    }
    @keyframes bgFlow{
      0%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }
    .app{max-width:1040px;margin:0 auto;padding:18px 14px 80px;}
    .rk-header{
      position:relative;
      padding:12px 16px 16px;
      border-radius:26px;
      background:linear-gradient(120deg,#6fb8ff,#a774ff,#ff7fd1);
      color:#fff;
      box-shadow:0 18px 45px rgba(77,93,255,0.4);
    }
    .rk-header-main{display:flex;justify-content:space-between;align-items:center;gap:10px;}
    .rk-header-main h1{
      margin:0;font-size:20px;font-weight:900;letter-spacing:0.06em;text-transform:uppercase;
    }
    .rk-badge{
      font-size:11px;font-weight:600;padding:4px 9px;border-radius:999px;
      background:rgba(255,255,255,0.18);border:1px solid rgba(255,255,255,0.4);
    }
    #subtitle{margin:8px 0 0;font-size:12px;}

    .card{
      margin-top:16px;padding:16px 18px 18px;border-radius:22px;
      background:var(--card-bg);backdrop-filter:blur(16px);
      border:1px solid rgba(255,255,255,0.7);
      box-shadow:0 18px 40px rgba(0,0,0,0.12);
    }
    .card h2{margin:0 0 8px;font-size:16px;font-weight:800;letter-spacing:0.03em;}

    textarea{
      width:100%;border-radius:16px;border:1px solid var(--border);
      padding:10px 12px;font-size:14px;resize:vertical;min-height:70px;
      color:var(--text-main);background:#fff;
    }
    textarea:focus{
      outline:none;
      box-shadow:0 0 0 1px rgba(255,255,255,0.9), 0 0 0 3px rgba(149,120,255,0.5);
      border-color:rgba(149,120,255,0.7);
    }
    .btn-row{margin-top:10px;display:flex;flex-wrap:wrap;gap:8px;}
    button{
      border:none;border-radius:999px;padding:8px 16px;font-size:12px;font-weight:700;
      cursor:pointer;color:#fff;background:linear-gradient(135deg,#6b8cff,#9b6bff);
      box-shadow:0 10px 24px rgba(108,110,210,0.4), 0 0 0 1px rgba(255,255,255,0.7) inset;
      transition:transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    button.secondary{background:linear-gradient(135deg,#ff9a6c,#ff5f8c);}
    button:hover{transform:translateY(-1px);box-shadow:0 12px 26px rgba(0,0,0,0.18);filter:brightness(1.03);}
    button:active{transform:translateY(1px) scale(0.98);box-shadow:0 6px 16px rgba(0,0,0,0.25);filter:brightness(0.97);}

    .section-title{
      margin-top:18px;margin-bottom:6px;font-size:13px;font-weight:700;
      letter-spacing:0.08em;text-transform:uppercase;color:#4b607d;
    }
    .table-block{
      margin-top:6px;padding:10px 10px 12px;border-radius:20px;
      background:var(--card-bg);
      border:1px solid rgba(255,255,255,0.7);
      box-shadow:0 14px 30px rgba(0,0,0,0.1);
    }
    .table-title{
      display:flex;justify-content:space-between;align-items:center;
      font-size:12px;font-weight:700;color:var(--text-soft);margin-bottom:6px;
    }
    .table-horizontal{display:flex;gap:8px;overflow-x:auto;padding-bottom:4px;}
    .col{
      min-width:110px;max-width:140px;flex:0 0 auto;border-radius:16px;
      padding:7px 7px 9px;background:radial-gradient(circle at top left,#fdfbf7,#f2ebde);
      border:1px solid #e2d7c8;box-shadow:0 10px 22px rgba(95,78,58,0.16);
    }
    .col-header{
      display:flex;align-items:center;justify-content:space-between;gap:4px;
      font-size:10px;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;
      color:#7b5dff;border-bottom:1px solid rgba(208,196,255,0.8);
      padding-bottom:2px;margin-bottom:3px;
    }
    .col-header::before{
      content:"";display:inline-flex;align-items:center;justify-content:center;
      width:16px;height:16px;border-radius:6px;background:#fff;font-size:11px;
      box-shadow:0 1px 3px rgba(0,0,0,0.06);
    }
    .col[data-key="subject"] .col-header::before{content:"üë§";}
    .col[data-key="time"]    .col-header::before{content:"‚è∞";}
    .col[data-key="place"]   .col-header::before{content:"üìç";}
    .col[data-key="mod"]     .col-header::before{content:"‚ú®";}
    .col[data-key="object"]  .col-header::before{content:"üéØ";}
    .col[data-key="numeral"] .col-header::before{content:"#Ô∏è‚É£";}
    .col[data-key="counter"] .col-header::before{content:"üî¢";}
    .col[data-key="verb"]    .col-header::before{content:"üöÄ";}
    .col[data-key="conj"]    .col-header::before{content:"üîó";}

    .col-body-label{font-size:10px;color:#938777;margin-bottom:1px;}
    .col-body-main{font-size:15px;font-weight:700;min-height:1.4em;}
    .col-body-main[contenteditable="true"]{outline:none;cursor:text;}
    .col-body-main:focus{
      box-shadow:0 0 0 1px rgba(255,255,255,0.8), 0 0 0 2px rgba(149,120,255,0.7);
      border-radius:6px;
    }
    .col-body-extra.example{margin-top:2px;font-size:10px;color:#b09b83;}

    .builder-enable-p2{
      margin-top:6px;padding-top:6px;border-top:1px dashed var(--border);
      font-size:11px;display:flex;justify-content:flex-end;color:var(--text-soft);
    }
    .builder-enable-p2 label{display:flex;align-items:center;gap:4px;}
    .hidden{display:none !important;}

    .preview-card{
      margin-top:14px;padding:12px 14px;border-radius:20px;background:var(--card-bg);
      border:1px solid rgba(255,255,255,0.7);box-shadow:0 16px 32px rgba(0,0,0,0.12);
    }
    .preview-title{
      font-size:12px;font-weight:700;color:#4b607d;display:flex;
      justify-content:space-between;align-items:center;margin-bottom:6px;
    }
    .preview-sentence{font-size:22px;font-weight:800;line-height:1.6;margin-bottom:4px;}
    .preview-ro{font-size:12px;color:var(--text-soft);}

    @media (max-width:600px){
      .rk-header-main h1{font-size:17px;}
      .col{min-width:95px;}
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="rk-header">
      <div class="rk-header-main">
        <h1>RALUCA KOREAN</h1>
        <span class="rk-badge">Builder P2 ‚Äì clean</span>
      </div>
      <p id="subtitle">
        P1 + P2, ‚Äú»ôi/and‚Äù ‚Üí -Í≥† lipit de verb, conectori standalone separa»õi.
      </p>
    </header>

    <section class="card" id="roCard">
      <h2>Rom√¢nƒÉ / EnglezƒÉ ‚Üí Builder</h2>
      <p style="font-size:12px;color:var(--text-soft);margin-top:0;margin-bottom:4px;">
        Exemplu: <em>AstƒÉzi merg la cafenea »ôi citesc o carte.</em> /
        <em>Today I go to the cafe and read a book.</em>
      </p>
      <div style="margin-bottom:6px;font-size:11px;color:var(--text-soft);display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <span>Limba:</span>
        <select id="langSelect" style="padding:2px 6px;border-radius:999px;border:1px solid var(--border);font-size:11px;">
          <option value="ro" selected>Rom√¢nƒÉ</option>
          <option value="en">English</option>
        </select>
      </div>
      <textarea id="roInput" placeholder="Scrie aici propozi»õia ta‚Ä¶"></textarea>

      <div class="btn-row">
        <button id="autoFillBtn">CompleteazƒÉ automat</button>
        <button id="clearBtn" class="secondary">CurƒÉ»õƒÉ tot</button>
      </div>
    </section>

    <h3 class="section-title">Propozi»õia 1</h3>
    <section class="table-block">
      <div class="table-title">
        <span>P1 (clauza principalƒÉ)</span>
        <span style="font-size:11px;color:var(--text-soft);">verb la infinitiv, ending √Æn CONJ</span>
      </div>

      <div id="tableP1" class="table-horizontal">
        <div class="col" data-key="subject"><div class="col-header">SUBJECT</div><div class="col-body-label">eu, tu‚Ä¶</div><div class="col-body-main" contenteditable="true">Ï†Ä</div></div>
        <div class="col" data-key="time"><div class="col-header">TIME</div><div class="col-body-label">azi‚Ä¶</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="place"><div class="col-header">PLACE</div><div class="col-body-label">acasƒÉ‚Ä¶</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="mod"><div class="col-header">MOD</div><div class="col-body-label">cum?</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="object"><div class="col-header">OBJECT</div><div class="col-body-label">ce?</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="numeral"><div class="col-header">NUMERAL</div><div class="col-body-label">una‚Ä¶</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="counter"><div class="col-header">COUNTER</div><div class="col-body-label">Í∞ú‚Ä¶</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="verb"><div class="col-header">VERB</div><div class="col-body-label">infinitiv</div><div class="col-body-main" contenteditable="true">Í∞ÄÎã§</div></div>

        <div class="col" data-key="conj">
          <div class="col-header">CONJ / ENDING</div>
          <div class="col-body-label">-Í≥† / -ÏïÑÏÑú / -Ïñ¥ÏÑú sau Í∑∏Î¶¨Í≥†‚Ä¶</div>
          <div class="col-body-main" contenteditable="true"></div>
          <div class="col-body-extra example">ex: -Í≥†, -ÏïÑÏÑú, -Ïñ¥ÏÑú, Í∑∏Î¶¨Í≥†, Í∑∏ÎûòÏÑú, ÌïòÏßÄÎßå‚Ä¶</div>
        </div>
      </div>
    </section>

    <section class="table-block" id="p2Block">
      <div class="table-title">
        <span>Propozi»õia 2</span>
        <div class="builder-enable-p2">
          <label>
            <input type="checkbox" id="enableP2" checked />
            <span>ActiveazƒÉ P2</span>
          </label>
        </div>
      </div>

      <div id="tableP2" class="table-horizontal">
        <div class="col" data-key="subject"><div class="col-header">SUBJECT</div><div class="col-body-label">eu, tu‚Ä¶</div><div class="col-body-main" contenteditable="true"></div><div class="col-body-extra example">ex: Ï†Ä</div></div>
        <div class="col" data-key="time"><div class="col-header">TIME</div><div class="col-body-label">azi‚Ä¶</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="place"><div class="col-header">PLACE</div><div class="col-body-label">acasƒÉ‚Ä¶</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="mod"><div class="col-header">MOD</div><div class="col-body-label">cum?</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="object"><div class="col-header">OBJECT</div><div class="col-body-label">ce?</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="numeral"><div class="col-header">NUMERAL</div><div class="col-body-label">una‚Ä¶</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="counter"><div class="col-header">COUNTER</div><div class="col-body-label">Í∞ú‚Ä¶</div><div class="col-body-main" contenteditable="true"></div></div>
        <div class="col" data-key="verb"><div class="col-header">VERB</div><div class="col-body-label">infinitiv</div><div class="col-body-main" contenteditable="true"></div><div class="col-body-extra example">ex: ÏùΩÎã§, ÎßàÏãúÎã§</div></div>
        <div class="col" data-key="conj">
          <div class="col-header">CONJ / ENDING</div>
          <div class="col-body-label">(op»õional) ending P2</div>
          <div class="col-body-main" contenteditable="true"></div>
          <div class="col-body-extra example">ex: -ÏïÑÏöî/Ïñ¥Ïöî (dacƒÉ vrei, mai t√¢rziu)</div>
        </div>
      </div>
    </section>

    <section class="preview-card">
      <div class="preview-title">
        <span>Preview coreeanƒÉ (P1 + conector + P2)</span>
      </div>
      <div id="previewSentence" class="preview-sentence">Ï†Ä Í∞ÄÎã§</div>
      <div id="debugLine" class="preview-ro"></div>
    </section>
  </div>

  <script>
  (function () {
    // =========================
    // 1) Normalizare + split
    // =========================
    function normalizeText(text) {
      if (!text) return "";
      let t = text.toLowerCase();
      t = t.replace(/≈ü/g, "»ô").replace(/≈£/g, "»õ");
      t = t.replace(/[.,!?;:]/g, " ");
      t = t.replace(/\s+/g, " ").trim();
      return t;
    }

    // Split DOAR pe primul conector de coordonare ‚Äú»ôi/and‚Äù
    // (restul le extindem dupƒÉ ce baza merge stabil)
    function splitSentence(raw) {
      const t = (raw || "").replace(/\s+/g, " ").trim();
      if (!t) return { p1: "", conj: "", p2: "" };

      const re = /^(.*?)(?:\s+(»ôi|si|and)\s+)(.+)$/i;
      const m = t.match(re);
      if (m) return { p1: m[1].trim(), conj: (m[2] || "").toLowerCase(), p2: m[3].trim() };
      return { p1: t, conj: "", p2: "" };
    }

    // =========================
    // 2) Rules RO/EN -> slots
    // =========================
    const RO_RULES = {
      subject: [{ re: /\beu\b/, value: "Ï†Ä" }, { re: /\btu\b/, value: "ÎÑà" }],
      time: [{ re: /\bazi\b|\bastƒÉzi\b/, value: "Ïò§Îäò" }, { re: /\bm√¢ine\b/, value: "ÎÇ¥Ïùº" }, { re: /\bieri\b/, value: "Ïñ¥Ï†ú" }, { re: /\bacum\b/, value: "ÏßÄÍ∏à" }],
      place: [{ re: /\bacas[ƒÉa]\b/, value: "Ïßë" }, { re: /cafenea/, value: "Ïπ¥Ìéò" }, { re: /pia[t»õ]ƒÉ/, value: "ÏãúÏû•" }, { re: /»ôcoal[ƒÉa]|scoala/, value: "ÌïôÍµê" }, { re: /serviciu|firm[ƒÉa]|companie/, value: "ÌöåÏÇ¨" }],
      mod: [{ re: /\bbine\b/, value: "Ïûò" }, { re: /√Æncet|incet/, value: "Ï≤úÏ≤úÌûà" }, { re: /repede|rapid/, value: "Îπ®Î¶¨" }, { re: /cu\s+s√¢rguint|cu\s+sarguint|harnic/, value: "Ïó¥Ïã¨Ìûà" }],
      object: [{ re: /cafea/, value: "Ïª§Ìîº" }, { re: /\bap[ƒÉa]\b/, value: "Î¨º" }, { re: /carte|c[ƒÉa]r»õ/, value: "Ï±Ö" }, { re: /m[ƒÉa]ncare|pr[ƒÉa]nz|cina|mic\s+dejun/, value: "ÏùåÏãù" }],
      numeral: [{ re: /\bo\s+(carte|cafea)\b/, value: "Ìïú" }, { re: /\bdou[ƒÉa]\s+(car»õi|cafele)\b/, value: "Îëê" }, { re: /\btrei\s+(car»õi|cafele)\b/, value: "ÏÑ∏" }],
      counter: [{ re: /carte|c[ƒÉa]r»õ/, value: "Í∂å" }, { re: /cafea|ap[ƒÉa]\b|m[ƒÉa]ncare/, value: "Í∞ú" }],
      verb: [
        { re: /merg\b|a merge|sƒÉ merg|sa merg/, value: "Í∞ÄÎã§" },
        { re: /vin\b|a veni|sƒÉ vin|sa vin/, value: "Ïò§Îã§" },
        { re: /beau\b|a bea|sƒÉ beau|sa beau/, value: "ÎßàÏãúÎã§" },
        { re: /m[√¢ƒÉ]n[√¢a]nc|mananc|a m[√¢ƒÉ]nca/, value: "Î®πÎã§" },
        { re: /citesc|a citi|sƒÉ citesc|sa citesc/, value: "ÏùΩÎã§" },
        { re: /lucrez|a lucra/, value: "ÏùºÌïòÎã§" }
      ]
    };

    const EN_RULES = {
      subject: [{ re: /\bi\b/, value: "Ï†Ä" }, { re: /\byou\b/, value: "ÎÑà" }],
      time: [{ re: /\btoday\b/, value: "Ïò§Îäò" }, { re: /\btomorrow\b/, value: "ÎÇ¥Ïùº" }, { re: /\byesterday\b/, value: "Ïñ¥Ï†ú" }, { re: /\bnow\b/, value: "ÏßÄÍ∏à" }],
      place: [{ re: /\bhome\b|house\b/, value: "Ïßë" }, { re: /\bcafe\b|coffee shop\b/, value: "Ïπ¥Ìéò" }, { re: /\bmarket\b|mart\b/, value: "ÏãúÏû•" }, { re: /\bschool\b/, value: "ÌïôÍµê" }, { re: /\bwork\b|company\b|office\b/, value: "ÌöåÏÇ¨" }],
      mod: [{ re: /\bwell\b/, value: "Ïûò" }, { re: /\bslowly\b/, value: "Ï≤úÏ≤úÌûà" }, { re: /\bfast\b|quickly\b/, value: "Îπ®Î¶¨" }, { re: /\bhard\b|diligently\b/, value: "Ïó¥Ïã¨Ìûà" }],
      object: [{ re: /\bcoffee\b/, value: "Ïª§Ìîº" }, { re: /\bwater\b/, value: "Î¨º" }, { re: /\bbook(s)?\b/, value: "Ï±Ö" }, { re: /\bfood\b|meal\b|lunch\b|dinner\b|breakfast\b/, value: "ÏùåÏãù" }],
      numeral: [{ re: /\ba\s+(book|coffee)\b|\bone\s+(book|coffee)\b/, value: "Ìïú" }, { re: /\btwo\s+(books|coffees)\b/, value: "Îëê" }, { re: /\bthree\s+(books|coffees)\b/, value: "ÏÑ∏" }],
      counter: [{ re: /\bbook(s)?\b/, value: "Í∂å" }, { re: /\bcoffee|water|food|meal\b/, value: "Í∞ú" }],
      verb: [
        { re: /\bgo\b|\bgoing\b/, value: "Í∞ÄÎã§" },
        { re: /\bcome\b|\bcoming\b/, value: "Ïò§Îã§" },
        { re: /\bdrink\b|\bdrinking\b/, value: "ÎßàÏãúÎã§" },
        { re: /\beat\b|\beating\b/, value: "Î®πÎã§" },
        { re: /\bread\b|\breading\b/, value: "ÏùΩÎã§" },
        { re: /\bwork\b|\bworking\b/, value: "ÏùºÌïòÎã§" }
      ]
    };

    function matchSlot(rules, textNorm) {
      if (!rules) return "";
      for (const r of rules) if (r.re.test(textNorm)) return r.value;
      return "";
    }

    function parseToSlots(text, lang) {
      const t = normalizeText(text);
      if (!t) return {};
      const R = (lang === "en") ? EN_RULES : RO_RULES;
      return {
        subject: matchSlot(R.subject, t),
        time: matchSlot(R.time, t),
        place: matchSlot(R.place, t),
        mod: matchSlot(R.mod, t),
        object: matchSlot(R.object, t),
        numeral: matchSlot(R.numeral, t),
        counter: matchSlot(R.counter, t),
        verb: matchSlot(R.verb, t)
      };
    }

    // =========================
    // 3) DOM helpers
    // =========================
    function applySlotsToTable(tableId, slots) {
      const table = document.getElementById(tableId);
      if (!table || !slots) return;
      ["subject","time","place","mod","object","numeral","counter","verb"].forEach((k)=>{
        if (!slots[k]) return;
        const cell = table.querySelector('.col[data-key="'+k+'"] .col-body-main');
        if (cell) cell.textContent = slots[k];
      });
    }

    function clearTable(tableId) {
      const t = document.getElementById(tableId);
      if (!t) return;
      t.querySelectorAll('.col-body-main').forEach(el => el.textContent = "");
    }

    function readFromTable(tableId, key) {
      const cell = document.querySelector('#'+tableId+' .col[data-key="'+key+'"] .col-body-main');
      return cell ? (cell.textContent || "").trim() : "";
    }

    // =========================
    // 4) Logic: endings & connectors
    // =========================
    const STANDALONE_CONNECTORS = new Set([
      "Í∑∏Î¶¨Í≥†","Í∑∏ÎûòÏÑú","ÌïòÏßÄÎßå","Îòê","ÎòêÎäî","Í∑∏ÎûòÎèÑ","Í∑∏Îü¨Î©¥","Í∑∏Îü¨ÎÇò","Í≤åÎã§Í∞Ä","Ï¶â"
    ]);

    function normalizeEnding(x) {
      return (x || "").trim().replace(/^[-~]/, "").trim();
    }

    function isAttachableEnding(e) {
      const t = normalizeEnding(e);
      return (t === "Í≥†" || t === "ÏïÑÏÑú" || t === "Ïñ¥ÏÑú");
    }

    function isStandaloneConnector(e) {
      const t = normalizeEnding(e);
      return STANDALONE_CONNECTORS.has(t);
    }

    function attachEndingToVerb(verbInf, endingRaw) {
      const v = (verbInf || "").trim();
      const e = normalizeEnding(endingRaw);
      if (!v) return "";
      if (!e) return v;

      // dacƒÉ e conector standalone, NU lipim
      if (isStandaloneConnector(e)) return v;

      // lipim doar pentru Í≥†/ÏïÑÏÑú/Ïñ¥ÏÑú
      if (!isAttachableEnding(e)) return v;

      if (!v.endsWith("Îã§")) return v; // lipim doar dacƒÉ e infinitiv

      // excep»õii utile
      if (v === "ÌïòÎã§") {
        if (e === "Í≥†") return "ÌïòÍ≥†";
        if (e === "ÏïÑÏÑú" || e === "Ïñ¥ÏÑú") return "Ìï¥ÏÑú";
      }
      if (v === "Í∞ÄÎã§" && (e === "ÏïÑÏÑú" || e === "Ïñ¥ÏÑú")) return "Í∞ÄÏÑú";
      if (v === "Ïò§Îã§" && (e === "ÏïÑÏÑú" || e === "Ïñ¥ÏÑú")) return "ÏôÄÏÑú";

      // default: scoatem Îã§ »ôi lipim
      return v.slice(0, -1) + e;
    }

    // construie»ôte clauza: sloturi + verb (cu ending lipit dacƒÉ e cazul)
    // returneazƒÉ »ôi ‚ÄúmiddleConnector‚Äù dacƒÉ ending e standalone (Í∑∏Î¶¨Í≥†/Í∑∏ÎûòÏÑú‚Ä¶)
    function buildClause(tableId, allowAttach) {
      const s = {
        subject: readFromTable(tableId,"subject"),
        time: readFromTable(tableId,"time"),
        place: readFromTable(tableId,"place"),
        mod: readFromTable(tableId,"mod"),
        object: readFromTable(tableId,"object"),
        numeral: readFromTable(tableId,"numeral"),
        counter: readFromTable(tableId,"counter"),
        verb: readFromTable(tableId,"verb"),
        conj: readFromTable(tableId,"conj")
      };

      let obj = "";
      if (s.object && s.numeral && s.counter) obj = s.object + " " + s.numeral + " " + s.counter;
      else if (s.object) obj = s.object;

      let middleConnector = "";
      let verbOut = s.verb;

      if (allowAttach && s.conj) {
        const cj = normalizeEnding(s.conj);

        if (isStandaloneConnector(cj)) {
          middleConnector = cj; // va sta √Æntre P1 »ôi P2
        } else if (isAttachableEnding(cj)) {
          verbOut = attachEndingToVerb(s.verb, cj); // se lipe»ôte
        } else {
          // dacƒÉ user scrie altceva, √Æl tratƒÉm ca standalone
          middleConnector = s.conj.trim();
        }
      }

      const pieces = [s.subject, s.time, s.place, s.mod, obj, verbOut].filter(Boolean);
      const clause = pieces.join(" ").trim();

      return { clause, middleConnector, hasAny: pieces.length > 0 || !!middleConnector };
    }

    // =========================
    // 5) Preview final
    // =========================
    function rebuildPreview() {
      const enableP2 = document.getElementById("enableP2");
      const useP2 = !!(enableP2 && enableP2.checked);

      const p1 = buildClause("tableP1", true);
      let finalSentence = p1.clause || "Ï†Ä Í∞ÄÎã§";

      // detectƒÉm dacƒÉ P2 are ceva
      const hasAnyP2 =
        readFromTable("tableP2","subject") ||
        readFromTable("tableP2","time") ||
        readFromTable("tableP2","place") ||
        readFromTable("tableP2","mod") ||
        readFromTable("tableP2","object") ||
        readFromTable("tableP2","numeral") ||
        readFromTable("tableP2","counter") ||
        readFromTable("tableP2","verb");

      if (useP2 && hasAnyP2) {
        const p2 = buildClause("tableP2", false);

        // dacƒÉ P1.conj e -Í≥†/-ÏïÑÏÑú/-Ïñ¥ÏÑú -> e lipit deja, middleConnector gol
        // dacƒÉ e Í∑∏Î¶¨Í≥†/Í∑∏ÎûòÏÑú -> √Æl punem √Æntre propozi»õii
        const parts = [p1.clause, p1.middleConnector, p2.clause].filter(Boolean);
        finalSentence = parts.join(" ").trim();
      }

      document.getElementById("previewSentence").textContent = finalSentence;

      // debug util (ca sƒÉ vezi exact ce cite»ôte)
      const dbg = [];
      dbg.push("P1 verb: " + (readFromTable("tableP1","verb") || "(gol)"));
      dbg.push("P1 conj: " + (readFromTable("tableP1","conj") || "(gol)"));
      dbg.push("P2 verb: " + (readFromTable("tableP2","verb") || "(gol)"));
      document.getElementById("debugLine").textContent = dbg.join(" | ");
    }

    // =========================
    // 6) Autofill RO/EN
    // =========================
    function autoFillFromInput() {
      const input = document.getElementById("roInput");
      const lang = (document.getElementById("langSelect") || {}).value || "ro";
      if (!input) return;

      const parts = splitSentence(input.value || "");

      // P1
      applySlotsToTable("tableP1", parseToSlots(parts.p1, lang));

      // P2
      if (parts.p2) applySlotsToTable("tableP2", parseToSlots(parts.p2, lang));
      else clearTable("tableP2");

      // CONJ logic:
      // - dacƒÉ detectƒÉm ‚Äú»ôi/and‚Äù -> CONJ = "-Í≥†" (lipit de verb) + activeazƒÉ P2
      const conjCell = document.querySelector('#tableP1 .col[data-key="conj"] .col-body-main');
      if (conjCell) conjCell.textContent = parts.conj ? "-Í≥†" : "";

      // toggle P2
      const enableP2 = document.getElementById("enableP2");
      if (enableP2) enableP2.checked = !!parts.p2;
      syncP2Visibility();

      rebuildPreview();
    }

    function clearAll() {
      document.getElementById("roInput").value = "";
      clearTable("tableP1");
      clearTable("tableP2");
      // default minim
      const p1sub = document.querySelector('#tableP1 .col[data-key="subject"] .col-body-main');
      const p1verb = document.querySelector('#tableP1 .col[data-key="verb"] .col-body-main');
      if (p1sub) p1sub.textContent = "Ï†Ä";
      if (p1verb) p1verb.textContent = "Í∞ÄÎã§";

      const conjCell = document.querySelector('#tableP1 .col[data-key="conj"] .col-body-main');
      if (conjCell) conjCell.textContent = "";

      const enableP2 = document.getElementById("enableP2");
      if (enableP2) enableP2.checked = false;
      syncP2Visibility();
      rebuildPreview();
    }

    function syncP2Visibility() {
      const enableP2 = document.getElementById("enableP2");
      const p2Block = document.getElementById("p2Block");
      if (!enableP2 || !p2Block) return;
      p2Block.style.display = enableP2.checked ? "" : "none";
    }

    // =========================
    // 7) Init: listeners (IMPORTANT)
    // =========================
    window.addEventListener("DOMContentLoaded", function () {
      document.getElementById("autoFillBtn").addEventListener("click", autoFillFromInput);
      document.getElementById("clearBtn").addEventListener("click", clearAll);
      document.getElementById("enableP2").addEventListener("change", function(){
        syncP2Visibility();
        rebuildPreview();
      });

      // live update: orice editare √Æn celule reconstruie»ôte preview
      document.getElementById("tableP1").addEventListener("input", rebuildPreview);
      document.getElementById("tableP2").addEventListener("input", rebuildPreview);

      syncP2Visibility();
      rebuildPreview();
    });
  })();
  </script>
</body>
</html>
