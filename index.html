<script>
/* ============================================================
   RALUCA KOREAN — SCRIPT FINAL COMPLET
   versiunea 3 — traducere naturală B + lipire verb/final + naturalness v2
   ============================================================ */

/* === LISTE DE CUVINTE (de bază) === */
const subjects = [
  "저","나","너","우리","너희","사람","학생","선생님","직원","전문가","지원자","관리자",
  "부모님","아이","어른","시민","고객","의사","간호사","연구자","관계자","대표","회장",
  "사용자","참가자","운전자","주민","환자"
];
const times = [
  "오늘","어제","내일","지금","방금","조금 후에","곧","최근에","요즘","마침내","결국",
  "이전에","이후에","당시에","한동안","계속","가끔","항상","자주","점점","차츰","일찍","늦게"
];
const places = [
  "집","학교","회사","식당","카페","도서관","병원","시장","백화점","공항","기차역",
  "버스정류장","연구소","기관","지역사회","환경","대기업","회의실","법원","경찰서",
  "해변","산","공원","은행"
];
const mods = [
  "잘","열심히","조용히","천천히","빨리","정말","아주","너무","많이","조금","갑자기","미리",
  "벌써","아까","방금","금방","곧","항상","자주","가끔","드물게","상당히","꽤","도대체",
  "절대로","적극적으로","충분히","특히","오히려","점점","차츰","계속"
];
const objects = [
  "책","커피","물","음식","영화","가방","전화","옷","자료","데이터","계획","조건","상황","문제",
  "해결책","요약","보고서","문서","컴퓨터","노트북","편지","선물","의견","정보","관계","결과",
  "원인","방법","제품","서비스","정책","문화"
];
const numerals = new Array(60).fill("");
const counters = [
  "개","명","권","장","대","병","잔","마리","번","살","송이","줄","점","건","회","가지","쪽"
];
const verbs = [
  "가다","오다","먹다","마시다","보다","읽다","쓰다","배우다","사다","주다","받다","일하다",
  "공부하다","요리하다","청소하다","준비하다","도와주다","사용하다","필요하다","좋아하다",
  "싫어하다","기다리다","쉬다","만나다","걷다","달리다","앉다","서다","결정하다","제안하다",
  "전달하다","유지하다","발생하다","증가하다","감소하다","인정하다","분석하다","관찰하다",
  "해결하다","연구하다","협력하다","요청하다","충족하다","비교하다","설명하다","예상하다"
];
const conjugations = [
  "-아요/어요","-았어요/었어요","-고 있어요","-고 싶어요","-(으)세요","-(으)ㄹ 거예요",
  "-지 마세요","-아/어 주세요","-아/어야 돼요","-(으)ㄹ 수 있어요","-(으)ㄹ 수 없어요",
  "-더라고요","-네요","-군요","-고 나서","-기 전에","-(으)면서","-(으)며",
  "-(으)ㄹ지도 몰라요","-(으)ㄹ게요","-(으)ㄹ래요?","-(으)ㄹ까요?","-는 게 어때요?",
  "-는 중이에요","-아/어도 돼요","-(으)면 안 돼요","-(으)나","-(으)므로","-(으)ㄴ/는 만큼",
  "-(으)ㄹ수록","-(으)ㄴ/는데도","-(으)ㄹ지라도","-(으)ㄴ/는 반면에","-도록 하다",
  "-게 되다","-아/어지다","-기 마련이다","-기에","-길래","-고 말다","-고자 하다","-(으)ㄹ 뿐이다"
];

/* === TRADUCERI (coreeană → română) === */
const translations = {
  subject:{ "저":"eu (formal)","나":"eu","너":"tu","우리":"noi","너희":"voi",
    "사람":"persoană","학생":"student","선생님":"profesor","직원":"angajat",
    "부모님":"părinți","아이":"copil","어른":"adult","시민":"cetățean",
    "고객":"client","의사":"medic","간호사":"asistentă","연구자":"cercetător",
    "대표":"reprezentant","환자":"pacient"
  },
  time:{ "오늘":"astăzi","어제":"ieri","내일":"mâine","지금":"acum","방금":"tocmai acum",
    "조금 후에":"puțin mai târziu","곧":"în curând","최근에":"recent","요즘":"în ultima vreme",
    "마침내":"în cele din urmă","결국":"până la urmă","이전에":"înainte","이후에":"după",
    "당시에":"atunci","한동안":"o perioadă","계속":"în mod continuu","가끔":"din când în când",
    "항상":"întotdeauna","자주":"des","점점":"din ce în ce","차츰":"treptat",
    "일찍":"devreme","늦게":"târziu"
  },
  place:{ "집":"acasă","학교":"școală","회사":"firmă","식당":"restaurant","카페":"cafenea",
    "도서관":"bibliotecă","병원":"spital","시장":"piață","백화점":"magazin universal",
    "공항":"aeroport","기차역":"gară","버스정류장":"stație de autobuz",
    "연구소":"laborator","기관":"instituție","지역사회":"comunitate",
    "환경":"mediu","대기업":"corporație","회의실":"sală de ședințe",
    "법원":"instanță","경찰서":"secție de poliție","해변":"plajă",
    "산":"munte","공원":"parc","은행":"bancă"
  },
  mod:{ "잘":"bine","열심히":"cu sârguință","조용히":"în liniște","천천히":"încet","빨리":"repede",
    "정말":"cu adevărat","아주":"foarte","너무":"prea","많이":"mult",
    "조금":"puțin","갑자기":"brusc","미리":"în avans","벌써":"deja",
    "아까":"mai devreme","방금":"chiar acum","금방":"imediat","곧":"în curând",
    "항상":"mereu","자주":"des","가끔":"din când în când","드물게":"rar",
    "상당히":"destul de","꽤":"binișor","도대체":"deloc / în întrebări",
    "절대로":"niciodată","적극적으로":"activ","충분히":"suficient",
    "특히":"în special","오히려":"mai degrabă","점점":"din ce în ce","차츰":"treptat",
    "계속":"în mod continuu"
  },
  object:{ "책":"carte","커피":"cafea","물":"apă","음식":"mâncare","영화":"film",
    "가방":"geantă","전화":"telefon","옷":"haine","자료":"materiale",
    "데이터":"date","계획":"plan","조건":"condiție","상황":"situație",
    "문제":"problemă","해결책":"soluție","요약":"rezumat","보고서":"raport",
    "문서":"document","컴퓨터":"calculator","노트북":"laptop","편지":"scrisoare",
    "선물":"cadou","의견":"opinie","정보":"informație","관계":"relație",
    "결과":"rezultat","원인":"cauză","방법":"metodă","제품":"produs",
    "서비스":"serviciu","정책":"politică","문화":"cultură"
  },
  numeral:{},
  counter:{ "개":"bucată","명":"persoană","권":"volum","장":"foaie","대":"aparat",
    "병":"sticlă","잔":"pahar","마리":"animal","번":"dată",
    "살":"ani","송이":"buchet","줄":"șir","점":"punct",
    "건":"caz","회":"ocazie","가지":"tip","쪽":"pagină"
  },
  verb:{
    "가다":"a merge","오다":"a veni","먹다":"a mânca","마시다":"a bea","보다":"a vedea",
    "읽다":"a citi","쓰다":"a scrie","배우다":"a învăța","사다":"a cumpăra",
    "주다":"a da","받다":"a primi","일하다":"a lucra","공부하다":"a studia",
    "요리하다":"a găti","청소하다":"a face curat","준비하다":"a pregăti",
    "도와주다":"a ajuta","사용하다":"a folosi","필요하다":"a fi necesar",
    "좋아하다":"a plăcea","싫어하다":"a nu plăcea","기다리다":"a aștepta",
    "쉬다":"a se odihni","만나다":"a se întâlni","걷다":"a merge pe jos",
    "달리다":"a alerga","앉다":"a se așeza","서다":"a sta în picioare",
    "결정하다":"a decide","제안하다":"a propune","전달하다":"a transmite",
    "유지하다":"a menține","발생하다":"a se produce","증가하다":"a crește",
    "감소하다":"a scădea","인정하다":"a recunoaște","분석하다":"a analiza",
    "관찰하다":"a observa","해결하다":"a rezolva","연구하다":"a cerceta",
    "협력하다":"a colabora","요청하다":"a solicita","충족하다":"a satisface",
    "비교하다":"a compara","설명하다":"a explica","예상하다":"a anticipa"
  },
  conjug:{
    "-아요/어요":"prezent politicos",
    "-았어요/었어요":"trecut politicos",
    "-고 있어요":"acțiune în desfășurare",
    "-고 싶어요":"vreau să…",
    "-(으)세요":"imperativ politicos",
    "-(으)ㄹ 거예요":"viitor",
    "-지 마세요":"nu faceți…",
    "-아/어 주세요":"vă rog să…",
    "-아/어야 돼요":"trebuie să…",
    "-(으)ㄹ 수 있어요":"pot să…",
    "-(으)ㄹ 수 없어요":"nu pot să…",
    "-더라고요":"am observat că…",
    "-네요":"(surpriză)",
    "-군요":"(constatare)",
    "-고 나서":"după ce…",
    "-기 전에":"înainte să…",
    "-(으)면서":"în timp ce…",
    "-(으)며":"și",
    "-(으)ㄹ지도 몰라요":"s-ar putea să…",
    "-(으)ㄹ게요":"voi face…",
    "-(으)ㄹ래요?":"vrei să…?",
    "-(으)ㄹ까요?":"să facem…?",
    "-는 게 어때요?":"ce-ar fi să…?",
    "-는 중이에요":"în curs de…",
    "-아/어도 돼요":"e OK să…",
    "-(으)면 안 돼요":"nu ai voie să…",
    "-도록 하다":"să faci în așa fel încât…",
    "-게 되다":"ajungi să…",
    "-아/어지다":"devine…",
    "-기에":"pentru că…",
    "-길래":"pentru că (am văzut)",
    "-고 말다":"ajunge să…",
    "-고자 하다":"intenționez să…",
    "-(으)ㄹ 뿐이다":"doar…"
  }
};

/* ============================================================
   CONTINUARE SCRIPT — PARTEA 2 / 3
   ============================================================ */

/* === FUNCȚII UTILE PENTRU VERBE, FINALURI, TIPURI DE TIMP === */

const timePastWords = new Set(["어제","이전에","당시에","한동안"]);
const timeFutureWords = new Set(["내일","조금 후에","곧","이후에"]);

function conjugationType(cj) {
  if (!cj) return "neutral";
  if (cj.includes("았어요") || cj.includes("었어요")) return "past";
  if (cj.includes("ㄹ 거예요")) return "future";
  return "neutral";
}

function isLinkingConj(cj) {
  return cj.includes("고") || cj.includes("면서") || cj.includes("며") || cj.includes("나서") || cj.includes("기 전에");
}


/* === UNIFIED VERB + ENDING — lipire 100% corectă === */
function buildVerbPhraseUnified(dictVerb, cj) {
  if (!dictVerb && !cj) return "";
  if (!dictVerb) return cj || "";
  if (!cj) return dictVerb;

  const raw = buildVerbPhrase(dictVerb, cj);

  // Corecție: elimină spațiile între verb și final
  return raw
    .replace(/\s+/g, " ")
    .replace(/(\S)\s+(아요|어요|았어요|었어요|게요|래요\?|까요\?|수 있어요|수 없어요)/g, "$1$2");
}


/* === PROPOZIȚIE NATURALĂ ÎN ROMÂNĂ (ORDINE B) === */
function buildNaturalRomanian(state, activeMap) {
  const parts = [];
  const use = k => activeMap[k] !== false && isColumnVisible(k);
  const tr = (cat, w) => (translations[cat] && translations[cat][w]) || w || "";

  // 1) TIME
  if (use("time") && state.time) parts.push(tr("time", state.time));

  // 2) SUBJECT
  if (use("subject") && state.subject) parts.push(tr("subject", state.subject));

  // 3) PLACE
  if (use("place") && state.place) parts.push("la " + tr("place", state.place));

  // 4) MOD
  if (use("mod") && state.mod) parts.push(tr("mod", state.mod));

  // 5) OBJECT
  if (use("object") && state.object) {
    parts.push(tr("object", state.object));
  }

  // 6) VERB
  let verbRom = "";
  if (use("verb") && state.verb) verbRom = tr("verb", state.verb);

  if (use("conjug") && state.conjug) {
    const conj = tr("conjug", state.conjug);
    if (conj && conj !== state.conjug) verbRom += " (" + conj + ")";
  }

  if (verbRom) parts.push(verbRom);

  // Formatare finală
  let sentence = parts.join(" ").trim();
  sentence = sentence.replace(/\s+/g, " ");
  sentence = sentence.charAt(0).toUpperCase() + sentence.slice(1) + ".";

  return sentence;
}


/* === NATURALNESS ANALYSIS — versiunea îmbunătățită === */
function analyzeNaturalnessP1_v2() {
  const t = stateP1.time;
  const cj = stateP1.conjug;
  if (!t || !cj) return { ok: true, msg: "", suggestion: null };

  const tType =
    timePastWords.has(t) ? "past" :
    timeFutureWords.has(t) ? "future" :
    "neutral";

  const cType = conjugationType(cj);

  // Exemple de nepotrivire naturală
  if (tType === "past" && cType === "future") {
    const suggested = "-았어요/었어요";
    const sent = buildClauseSentence(stateP1, activeP1, suggested);
    return {
      ok: false,
      msg: `"${t}" (timp trecut) nu se potrivește natural cu finalul de viitor "${cj}". Exemplu nativ:`,
      suggestion: sent.ko
    };
  }

  if (tType === "future" && cType === "past") {
    const suggested = "-(으)ㄹ 거예요";
    const sent = buildClauseSentence(stateP1, activeP1, suggested);
    return {
      ok: false,
      msg: `"${t}" (viitor) nu se folosește natural cu "${cj}" (trecut). Exemplu nativ:`,
      suggestion: sent.ko
    };
  }

  return { ok: true, msg: "", suggestion: null };
}


/* ============================================================
   ÎNLOCUIRE updatePreview() — TRADUCERE NATURALĂ + NATURALNESS
   ============================================================ */
function updatePreview() {
  const c1 = buildClauseSentence(stateP1, activeP1, null);

  // coreeană
  let koText = c1.ko || "";

  // traducere românească naturală (ORDINE B)
  const roNatural = buildNaturalRomanian(stateP1, activeP1);

  // propoziție lungă (2 propoziții)
  if (enableP2.checked && stateP1.conjug && isLinkingConj(stateP1.conjug)) {
    const c2 = buildClauseSentence(stateP2, activeP2, null);
    if (c2.ko) {
      koText += " " + c2.ko;
    }
  }

  if (!koText.trim()) {
    previewKo.textContent = "(alege cuvinte)";
    previewRo.textContent = "";
    naturalHint.textContent = "";
    return;
  }

  previewKo.textContent = koText;
  previewRo.textContent = showRo ? roNatural : "··· traducere ascunsă ···";

  // naturalness
  const nat = analyzeNaturalnessP1_v2();
  naturalHint.textContent = nat.ok
    ? "✓ Propoziție naturală în conversații obișnuite."
    : `⚠ ${nat.msg} → 「${nat.suggestion}」`;
}

/* ============================================================
   CONTINUARE SCRIPT — PARTEA 3 / 3 (FINAL)
   ============================================================ */

/* === FUNCȚII EXISTENTE NECESARE — NEINLOCUITE === */
/* Aici păstrăm tot ce aveai deja: stateP1, stateP2, activeP1, activeP2,
   setările de toggle, long press, favorite, panel, random, glosar etc.
   Copiez doar funcțiile critice compatibile + fixuri minore. */


/* === SALVARE AUTOMATĂ PENTRU CUVINTE NOI === */

function saveCustomWord(category, word, translation) {
  if (!translations[category]) translations[category] = {};
  translations[category][word] = translation || word;
}

/* atunci când userul adaugă ceva nou în tabel */
function handleUserWordInput(category, word) {
  if (!word) return;
  if (!translations[category][word]) {
    translations[category][word] = word; // îl adăugăm implicit
  }
}


/* === BUILD CLAUSE (păstrează TOT ce aveai) — cu lipirea verbului nouă === */
function buildClauseSentence(state, activeMap, forcedConj) {
  const parts = [];
  const partKo = [];

  const use = k => activeMap[k] !== false && isColumnVisible(k);
  const val = k => state[k];

  if (use("time") && val("time")) {
    partKo.push(val("time"));
  }
  if (use("subject") && val("subject")) {
    partKo.push(val("subject"));
  }
  if (use("place") && val("place")) {
    partKo.push(val("place"));
  }
  if (use("mod") && val("mod")) {
    partKo.push(val("mod"));
  }

  /* obiect + numeral + counter */
  let objPhrase = "";
  if (use("object") && val("object")) objPhrase += val("object");
  if (use("numeral") && val("numeral")) objPhrase += " " + val("numeral");
  if (use("counter") && val("counter")) objPhrase += val("counter");
  if (objPhrase.trim()) partKo.push(objPhrase.trim());

  /* verb */
  const verb = use("verb") ? val("verb") : null;
  const conj = forcedConj || (use("conjug") ? val("conjug") : null);
  const vp = buildVerbPhraseUnified(verb, conj);

  if (vp) partKo.push(vp);

  return { 
    ko: partKo.join(" ").trim()
  };
}


/* === RANDOM BUILDER — păstrat, doar adaptare minoră === */
function randomPick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function generateRandomSentence() {
  stateP1.subject = randomPick(subjects);
  stateP1.time = randomPick(times);
  stateP1.place = randomPick(places);
  stateP1.mod = randomPick(mods);
  stateP1.object = randomPick(objects);
  stateP1.numeral = "";
  stateP1.counter = randomPick(counters);
  stateP1.verb = randomPick(verbs);
  stateP1.conjug = randomPick(conjugations);

  updatePreview();
}

/* === Afișare/Ascundere traducere === */
let showRo = true;
function toggleShowRo() {
  showRo = !showRo;
  updatePreview();
}

/* === Text-to-Speech coreean === */
function speakKo() {
  const text = previewKo.textContent.trim();
  if (!text) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ko-KR";
  speechSynthesis.speak(u);
}

/* === FILTRE, GLOSAR, EDITARE ETC. — păstrăm TOT ce aveai deja === */
/* TOT aici rămâne neschimbat: handler-ele pentru click pe celule,
   pop-up edit, glosarul, panelurile laterale, favorite etc. */


/* ============================================================
   FINAL SCRIPT
   ============================================================ */

console.log("SCRIPT RALUCA v3 încărcat cu succes.");
</script>
