<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Raluca Korean ‚Äì Study App v2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f7f3ff;
      --card-bg: #ffffff;
      --accent: #c9b5ff;
      --accent-strong: #9b7cff;
      --text-main: #333333;
      --text-soft: #666666;
      --border: #e0d7ff;
      --dimmed-bg: #f2eefc;
      --overlay-bg: rgba(0, 0, 0, 0.2);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#fdfbff,#f4f0ff);
      color:var(--text-main);display:flex;flex-direction:column;min-height:100vh;
    }
    .app{
      max-width:1000px;margin:0 auto;padding:10px 10px 60px;
      display:flex;flex-direction:column;gap:10px;min-height:100vh;
    }
    header{text-align:center;padding:4px 8px 4px;}
    header h1{font-size:18px;margin:2px 0;font-weight:700;color:var(--accent-strong);}
    header p{margin:0;font-size:11px;color:var(--text-soft);}

    .screen{display:none;flex-direction:column;gap:10px;flex:1;min-height:0;}
    .screen.active{display:flex;}

    .mode-panel{
      background:var(--card-bg);border-radius:12px;border:1px solid var(--border);
      padding:6px 8px;font-size:11px;display:flex;flex-direction:column;gap:4px;
      box-shadow:0 4px 12px rgba(120,96,190,0.08);
    }
    .mode-row{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;
    }
    .mode-row label{font-size:11px;display:flex;align-items:center;gap:4px;}
    .part-toggles{display:flex;flex-wrap:wrap;gap:6px;}
    .chip{
      display:inline-flex;align-items:center;gap:3px;
      padding:3px 8px;border-radius:999px;background:#ede7ff;color:var(--accent-strong);
      font-size:10px;cursor:pointer;
    }
    .chip input{margin:0;}
    .section-label{font-size:11px;font-weight:600;color:var(--accent-strong);margin-top:2px;}

    .small-mode-btn{
      padding:3px 8px;
      font-size:10px;
    }
    .small-mode-btn.active{
      background:var(--accent-strong);
      color:#fff;
    }

    .table-block{
      background:var(--card-bg);border-radius:14px;padding:8px;
      box-shadow:0 6px 16px rgba(120,96,190,0.12);border:1px solid var(--border);
      display:flex;flex-direction:column;gap:6px;flex:1;min-height:0;
    }
    .table-title{
      font-size:11px;font-weight:600;color:var(--text-soft);
      display:flex;justify-content:space-between;align-items:center;
    }
    .table-horizontal{
      display:flex;flex-direction:row;overflow-x:auto;padding-bottom:4px;gap:6px;
    }
    .col{
      min-width:110px;max-width:140px;flex:0 0 auto;background:#faf8ff;border-radius:10px;
      border:1px solid var(--border);display:flex;flex-direction:column;
      padding:6px 6px 8px;transition:0.2s;cursor:pointer;
      touch-action:manipulation;
    }
    .col-header{
      font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;
      color:var(--accent-strong);margin-bottom:4px;border-bottom:1px solid var(--border);
      padding-bottom:3px;
    }
    .col-body-label{font-size:10px;color:var(--text-soft);margin-bottom:2px;}
    .col-body-main{font-size:15px;font-weight:600;margin-bottom:2px;}
    .col-body-extra{font-size:11px;color:var(--text-soft);}
    .dimmed{
      opacity:0.35;background-image:repeating-linear-gradient(
        -45deg,var(--dimmed-bg),var(--dimmed-bg) 4px,#fdfbff 4px,#fdfbff 8px
      );
    }

    .controls{
      display:flex;justify-content:space-between;align-items:center;gap:8px;
      padding-top:4px;border-top:1px dashed var(--border);
    }
    .btn-group{display:flex;gap:6px;}
    button{
      border-radius:999px;border:none;padding:6px 10px;font-size:12px;font-weight:600;
      cursor:pointer;background:var(--accent);color:#fff;display:inline-flex;
      align-items:center;gap:4px;box-shadow:0 2px 6px rgba(90,70,160,0.25);
    }
    button.secondary{background:#ede7ff;color:var(--accent-strong);box-shadow:none;}
    button:disabled{opacity:0.4;box-shadow:none;cursor:default;}
    .page-indicator{font-size:11px;color:var(--text-soft);}
    .legend{font-size:10px;color:var(--text-soft);text-align:center;padding:2px 4px 0;}
    .hidden{display:none !important;}

    .preview-card{
      margin-top:6px;padding:8px;border-radius:12px;
      background:#f9f7ff;border:1px solid var(--border);
      display:flex;flex-direction:column;gap:4px;
    }
    .preview-title{
      font-size:11px;font-weight:600;color:var(--accent-strong);
      display:flex;justify-content:space-between;align-items:center;
    }
    .preview-ko{
      font-size:14px;font-weight:600;margin-top:2px;
    }
    .preview-ro{
      font-size:12px;color:var(--text-soft);
    }
    .preview-natural{
      font-size:11px;
      color:#8e6cff;
      margin-top:2px;
    }
    .preview-buttons{
      display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;
    }

    .overlay{
      position:fixed;inset:0;background:var(--overlay-bg);
      display:flex;justify-content:center;align-items:flex-end;z-index:1000;
    }
    .panel{
      width:100%;max-width:900px;background:var(--card-bg);
      border-radius:18px 18px 0 0;box-shadow:0 -6px 18px rgba(0,0,0,0.15);
      padding:10px 12px 14px;animation:slideUp 0.18s ease-out;
    }
    @keyframes slideUp{
      from{transform:translateY(40px);opacity:0;}
      to{transform:translateY(0);opacity:1;}
    }
    .panel-header{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;
    }
    .panel-title{font-size:13px;font-weight:600;color:var(--accent-strong);}
    .panel-sub{font-size:11px;color:var(--text-soft);}
    .panel-close{
      background:transparent;color:var(--text-soft);box-shadow:none;
      padding:4px 6px;font-size:14px;
    }
    .panel-input-row{display:flex;gap:6px;margin-bottom:6px;}
    .panel-input-row input{
      flex:1;border-radius:999px;border:1px solid var(--border);
      padding:6px 10px;font-size:12px;
    }
    .panel-list{
      max-height:260px;overflow-y:auto;border-radius:10px;
      border:1px solid var(--border);background:#faf8ff;padding:4px;
    }
    .panel-item{
      padding:4px 8px;border-radius:8px;display:flex;justify-content:space-between;
      align-items:center;font-size:13px;cursor:pointer;
    }
    .panel-item:hover{background:#ede7ff;}
    .panel-item-main{font-weight:600;}
    .panel-item-extra{
      display:flex;flex-direction:column;align-items:flex-end;gap:2px;
    }
    .panel-item-tag{font-size:10px;color:var(--accent-strong);}

    .bottom-nav{
      position:fixed;bottom:0;left:0;right:0;
      background:#ffffffee;border-top:1px solid var(--border);
      display:flex;justify-content:space-around;align-items:center;
      padding:6px 0;backdrop-filter:blur(8px);z-index:500;
    }
    .nav-btn{
      flex:1;text-align:center;border:none;background:transparent;
      font-size:11px;color:var(--text-soft);padding:4px 0;cursor:pointer;
      display:flex;flex-direction:column;align-items:center;gap:2px;
    }
    .nav-btn span.icon{font-size:18px;}
    .nav-btn.active{color:var(--accent-strong);font-weight:600;}
    .nav-btn.active span.icon{transform:translateY(-1px);}
    @media (max-width:600px){
      header h1{font-size:16px;}
      .col{min-width:95px;}
    }

    .card{
      background:var(--card-bg);border-radius:14px;padding:10px;
      box-shadow:0 4px 12px rgba(120,96,190,0.12);border:1px solid var(--border);
      display:flex;flex-direction:column;gap:6px;
    }
    .card h2{
      margin:0;font-size:14px;color:var(--accent-strong);
    }
    .small-label{font-size:11px;color:var(--text-soft);}
    select{
      border-radius:999px;border:1px solid var(--border);
      padding:4px 10px;font-size:12px;background:#fff;
    }
    .exercise-question{
      font-size:14px;font-weight:600;margin-top:4px;
    }
    .exercise-options{display:flex;flex-direction:column;gap:4px;margin-top:2px;}
    .exercise-options label{
      font-size:13px;display:flex;align-items:center;gap:6px;
    }
    .exercise-feedback{
      font-size:12px;margin-top:4px;
    }

    .glossary-search{
      display:flex;gap:6px;align-items:center;margin-top:4px;
    }
    .glossary-search input{
      flex:1;border-radius:999px;border:1px solid var(--border);
      padding:6px 10px;font-size:12px;
    }
    .glossary-list{
      margin-top:6px;max-height:260px;overflow-y:auto;padding-right:2px;
    }
    .glossary-item{
      padding:6px 8px;border-radius:10px;border:1px solid var(--border);
      background:#faf8ff;margin-bottom:4px;font-size:12px;
      display:flex;justify-content:space-between;gap:8px;
    }
    .glossary-ko{font-weight:600;}
    .glossary-ro{color:var(--text-soft);}
    .glossary-cat{font-size:10px;color:var(--accent-strong);}

    .fav-list{
      margin-top:4px;max-height:140px;overflow-y:auto;padding-right:2px;
    }
    .fav-item{
      padding:4px 6px;border-radius:8px;border:1px solid var(--border);
      background:#fdfbff;margin-bottom:4px;font-size:11px;
    }
    .fav-ko{font-weight:600;margin-bottom:2px;}
    .fav-ro{color:var(--text-soft);}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Raluca Korean ‚Äì Study App</h1>
      <p id="subtitle">Builder propozi»õii + particule + audio + conjugƒÉri</p>
    </header>

    <!-- SCREEN 1: BUILDER -->
    <div class="screen active" id="screen-builder">
      <div class="mode-panel">
        <div class="mode-row">
          <span class="section-label">Mod afi»ôare</span>
          <div>
            <button class="secondary small-mode-btn" data-mode="simple">Simplu</button>
            <button class="secondary small-mode-btn active" data-mode="topik">TOPIK</button>
          </div>
        </div>
        <div class="mode-row">
          <span class="section-label">Propozi»õia 1 ‚Äì ce pƒÉr»õi folose»ôte?</span>
          <div class="part-toggles" id="togglesP1"></div>
        </div>
        <div class="mode-row">
          <label>
            <input type="checkbox" id="enableP2" />
            ActiveazƒÉ Propozi»õia 2 (fraza)
          </label>
          <div class="part-toggles" id="togglesP2"></div>
        </div>
      </div>

      <div class="table-block">
        <div class="table-title">
          <span>Propozi»õia 1</span>
          <span class="page-indicator" id="pageInfo"></span>
        </div>
        <div class="table-horizontal" id="tableP1"></div>

        <div class="table-title hidden" id="titleP2">
          <span>Propozi»õia 2 (continuare / frazƒÉ)</span>
        </div>
        <div class="table-horizontal hidden" id="tableP2"></div>

        <div class="controls">
          <div class="btn-group">
            <button id="prevBtn">‚¨Ö Prev (r√¢nd model)</button>
            <button id="nextBtn">Next ‚û°</button>
          </div>
          <button class="secondary" id="resetBtn">Reset pƒÉr»õi de propozi»õie</button>
        </div>
        <div class="legend">
          ‚û§ Tap scurt pe coloanƒÉ = treci la urmƒÉtorul cuv√¢nt.  
          ‚û§ »öine apƒÉsat pe coloanƒÉ = deschizi lista completƒÉ (cu traduceri + cƒÉutare).  
          ‚û§ ‚≠ê la CONJUGƒÇRI = gramaticƒÉ de legƒÉturƒÉ (cere propozi»õia 2).  
          ‚û§ Sistem de <b>conjugare realƒÉ</b>: verbul se une»ôte cu finalul (ex: Í∞ÄÎã§ + -Í≥† ÏûàÏñ¥Ïöî ‚Üí Í∞ÄÍ≥† ÏûàÏñ¥Ïöî).
        </div>

        <div class="preview-card">
          <div class="preview-title">
            <span>Propozi»õia / fraza (coreeanƒÉ, cu particule & verb conjugat)</span>
          </div>
          <div class="preview-ko" id="previewKo">(alege cuvinte din tabel)</div>

          <div class="preview-title">
            <span>Traducere aproximativƒÉ (rom√¢nƒÉ ‚Äì pe pƒÉr»õi)</span>
            <button id="toggleRoBtn" class="secondary" style="padding:3px 8px;font-size:10px;">
              Ascunde traducerea
            </button>
          </div>
          <div class="preview-ro" id="previewRo"></div>

          <div class="preview-natural" id="naturalHint"></div>

          <div class="preview-buttons">
            <button id="randomBtn">üé≤ Random propozi»õie</button>
            <button id="speakBtn">üîä Audio coreeanƒÉ</button>
            <button id="favBtn" class="secondary">‚≠ê SalveazƒÉ propozi»õia</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCREEN 2: EXERCI»öII TOPIK -->
    <div class="screen" id="screen-exercises">
      <div class="card">
        <h2>üìù Exerci»õii TOPIK ‚Äì propozi»õii</h2>
        <div class="small-label">Alege tipul de exerci»õiu:</div>
        <select id="exerciseType">
          <option value="verb">Alege VERBUL corect</option>
          <option value="particle">Alege PARTICULA corectƒÉ (simplu)</option>
          <option value="particlePlus">Particule multiple (ÏùÄ/Îäî, Ïù¥/Í∞Ä, ÏùÑ/Î•º, Ïóê/ÏóêÏÑú)</option>
          <option value="conjug">Alege CONJUGAREA corectƒÉ</option>
        </select>

        <div class="exercise-question" id="exerciseQuestion">
          ApasƒÉ ‚Äû√éntrebare nouƒÉ‚Äù ca sƒÉ √Æncepi.
        </div>
        <div class="exercise-options" id="exerciseOptions"></div>

        <div class="btn-group">
          <button id="checkAnswerBtn">VerificƒÉ rƒÉspunsul</button>
          <button class="secondary" id="nextQuestionBtn">√éntrebare nouƒÉ</button>
        </div>
        <div class="exercise-feedback" id="exerciseFeedback"></div>
      </div>
      <div class="legend">
        ‚û§ Pentru ‚ÄûParticule multiple‚Äù ai mai multe spa»õii (1), (2), (3).  
        ‚û§ Toate trebuie corecte ca sƒÉ fie propozi»õia corectƒÉ.
      </div>
    </div>

    <!-- SCREEN 3: GLOSAR + FAVORITE -->
    <div class="screen" id="screen-glossary">
      <div class="card">
        <h2>üìö Glosar coreean‚Äìrom√¢n</h2>

        <div class="small-label">Propozi»õii favorite:</div>
        <div id="favoritesList" class="fav-list"></div>

        <div class="small-label" style="margin-top:6px;">CautƒÉ √Æn glosar (coreeanƒÉ sau rom√¢nƒÉ):</div>
        <div class="glossary-search">
          <input type="text" id="glossarySearch" placeholder="ex: Í∞ÄÎã§ sau a merge" />
        </div>
        <div class="glossary-list" id="glossaryList"></div>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <nav class="bottom-nav">
    <button class="nav-btn active" data-target="builder">
      <span class="icon">üèó</span>
      <span>Builder</span>
    </button>
    <button class="nav-btn" data-target="exercises">
      <span class="icon">üìù</span>
      <span>Exerci»õii</span>
    </button>
    <button class="nav-btn" data-target="glossary">
      <span class="icon">üìö</span>
      <span>Glosar</span>
    </button>
  </nav>

  <!-- overlay panel -->
  <div class="overlay hidden" id="overlay">
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title" id="panelTitle"></div>
          <div class="panel-sub" id="panelSub"></div>
        </div>
        <button class="panel-close" id="closePanelBtn">‚úï</button>
      </div>

      <!-- CƒÉutare √Æn lista de cuvinte -->
      <div class="panel-input-row">
        <input type="text" id="panelSearchInput" placeholder="CautƒÉ √Æn listƒÉ (primele litere)..." />
      </div>

      <!-- Cuv√¢nt nou + traducere -->
      <div class="panel-input-row">
        <input type="text" id="newWordInput" placeholder="Cuv√¢nt nou (coreeanƒÉ sau numƒÉr)..." />
      </div>
      <div class="panel-input-row">
        <input type="text" id="newWordTransInput" placeholder="Traducere √Æn rom√¢nƒÉ (ex: unu, azi) ‚Äì op»õional" />
        <button id="addWordBtn" class="secondary">+ Add</button>
      </div>

      <div class="panel-list" id="panelList"></div>
    </div>
  </div>

  <script>
/* === LISTE DE CUVINTE (de bazƒÉ) === */
const subjects = [
  "Ï†Ä","ÎÇò","ÎÑà","Ïö∞Î¶¨","ÎÑàÌù¨","ÏÇ¨Îûå","ÌïôÏÉù","ÏÑ†ÏÉùÎãò","ÏßÅÏõê","Ï†ÑÎ¨∏Í∞Ä","ÏßÄÏõêÏûê","Í¥ÄÎ¶¨Ïûê",
  "Î∂ÄÎ™®Îãò","ÏïÑÏù¥","Ïñ¥Î•∏","ÏãúÎØº","Í≥†Í∞ù","ÏùòÏÇ¨","Í∞ÑÌò∏ÏÇ¨","Ïó∞Íµ¨Ïûê","Í¥ÄÍ≥ÑÏûê","ÎåÄÌëú","ÌöåÏû•",
  "ÏÇ¨Ïö©Ïûê","Ï∞∏Í∞ÄÏûê","Ïö¥Ï†ÑÏûê","Ï£ºÎØº","ÌôòÏûê"
];
const times = [
  "Ïò§Îäò","Ïñ¥Ï†ú","ÎÇ¥Ïùº","ÏßÄÍ∏à","Î∞©Í∏à","Ï°∞Í∏à ÌõÑÏóê","Í≥ß","ÏµúÍ∑ºÏóê","ÏöîÏ¶ò","ÎßàÏπ®ÎÇ¥","Í≤∞Íµ≠",
  "Ïù¥Ï†ÑÏóê","Ïù¥ÌõÑÏóê","ÎãπÏãúÏóê","ÌïúÎèôÏïà","Í≥ÑÏÜç","Í∞ÄÎÅî","Ìï≠ÏÉÅ","ÏûêÏ£º","Ï†êÏ†ê","Ï∞®Ï∏∞","ÏùºÏ∞ç","Îä¶Í≤å"
];
const places = [
  "Ïßë","ÌïôÍµê","ÌöåÏÇ¨","ÏãùÎãπ","Ïπ¥Ìéò","ÎèÑÏÑúÍ¥Ä","Î≥ëÏõê","ÏãúÏû•","Î∞±ÌôîÏ†ê","Í≥µÌï≠","Í∏∞Ï∞®Ïó≠",
  "Î≤ÑÏä§Ï†ïÎ•òÏû•","Ïó∞Íµ¨ÏÜå","Í∏∞Í¥Ä","ÏßÄÏó≠ÏÇ¨Ìöå","ÌôòÍ≤Ω","ÎåÄÍ∏∞ÏóÖ","ÌöåÏùòÏã§","Î≤ïÏõê","Í≤ΩÏ∞∞ÏÑú",
  "Ìï¥Î≥Ä","ÏÇ∞","Í≥µÏõê","ÏùÄÌñâ"
];
const mods = [
  "Ïûò","Ïó¥Ïã¨Ìûà","Ï°∞Ïö©Ìûà","Ï≤úÏ≤úÌûà","Îπ®Î¶¨","Ï†ïÎßê","ÏïÑÏ£º","ÎÑàÎ¨¥","ÎßéÏù¥","Ï°∞Í∏à","Í∞ëÏûêÍ∏∞","ÎØ∏Î¶¨",
  "Î≤åÏç®","ÏïÑÍπå","Î∞©Í∏à","Í∏àÎ∞©","Í≥ß","Ìï≠ÏÉÅ","ÏûêÏ£º","Í∞ÄÎÅî","ÎìúÎ¨ºÍ≤å","ÏÉÅÎãπÌûà","ÍΩ§","ÎèÑÎåÄÏ≤¥","Ï†àÎåÄÎ°ú",
  "Ï†ÅÍ∑πÏ†ÅÏúºÎ°ú","Ï∂©Î∂ÑÌûà","ÌäπÌûà","Ïò§ÌûàÎ†§","Ï†êÏ†ê","Ï∞®Ï∏∞","Í≥ÑÏÜç"
];
const objects = [
  "Ï±Ö","Ïª§Ìîº","Î¨º","ÏùåÏãù","ÏòÅÌôî","Í∞ÄÎ∞©","Ï†ÑÌôî","Ïò∑","ÏûêÎ£å","Îç∞Ïù¥ÌÑ∞","Í≥ÑÌöç","Ï°∞Í±¥","ÏÉÅÌô©","Î¨∏Ï†ú",
  "Ìï¥Í≤∞Ï±Ö","ÏöîÏïΩ","Î≥¥Í≥†ÏÑú","Î¨∏ÏÑú","Ïª¥Ìì®ÌÑ∞","ÎÖ∏Ìä∏Î∂Å","Ìé∏ÏßÄ","ÏÑ†Î¨º","ÏùòÍ≤¨","Ï†ïÎ≥¥","Í¥ÄÍ≥Ñ","Í≤∞Í≥º",
  "ÏõêÏù∏","Î∞©Î≤ï","Ï†úÌíà","ÏÑúÎπÑÏä§","Ï†ïÏ±Ö","Î¨∏Ìôî"
];
const numerals = new Array(60).fill("");
const counters = [
  "Í∞ú","Î™Ö","Í∂å","Ïû•","ÎåÄ","Î≥ë","Ïûî","ÎßàÎ¶¨","Î≤à","ÏÇ¥","ÏÜ°Ïù¥","Ï§Ñ","Ï†ê","Í±¥","Ìöå","Í∞ÄÏßÄ","Ï™Ω"
];
const verbs = [
  "Í∞ÄÎã§","Ïò§Îã§","Î®πÎã§","ÎßàÏãúÎã§","Î≥¥Îã§","ÏùΩÎã§","Ïì∞Îã§","Î∞∞Ïö∞Îã§","ÏÇ¨Îã§","Ï£ºÎã§","Î∞õÎã§","ÏùºÌïòÎã§",
  "Í≥µÎ∂ÄÌïòÎã§","ÏöîÎ¶¨ÌïòÎã§","Ï≤≠ÏÜåÌïòÎã§","Ï§ÄÎπÑÌïòÎã§","ÎèÑÏôÄÏ£ºÎã§","ÏÇ¨Ïö©ÌïòÎã§","ÌïÑÏöîÌïòÎã§","Ï¢ãÏïÑÌïòÎã§",
  "Ïã´Ïñ¥ÌïòÎã§","Í∏∞Îã§Î¶¨Îã§","Ïâ¨Îã§","ÎßåÎÇòÎã§","Í±∑Îã§","Îã¨Î¶¨Îã§","ÏïâÎã§","ÏÑúÎã§","Í≤∞Ï†ïÌïòÎã§","Ï†úÏïàÌïòÎã§",
  "Ï†ÑÎã¨ÌïòÎã§","Ïú†ÏßÄÌïòÎã§","Î∞úÏÉùÌïòÎã§","Ï¶ùÍ∞ÄÌïòÎã§","Í∞êÏÜåÌïòÎã§","Ïù∏Ï†ïÌïòÎã§","Î∂ÑÏÑùÌïòÎã§","Í¥ÄÏ∞∞ÌïòÎã§",
  "Ìï¥Í≤∞ÌïòÎã§","Ïó∞Íµ¨ÌïòÎã§","ÌòëÎ†•ÌïòÎã§","ÏöîÏ≤≠ÌïòÎã§","Ï∂©Ï°±ÌïòÎã§","ÎπÑÍµêÌïòÎã§","ÏÑ§Î™ÖÌïòÎã§","ÏòàÏÉÅÌïòÎã§"
];
const conjugations = [
  "-ÏïÑÏöî/Ïñ¥Ïöî","-ÏïòÏñ¥Ïöî/ÏóàÏñ¥Ïöî","-Í≥† ÏûàÏñ¥Ïöî","-Í≥† Ïã∂Ïñ¥Ïöî","-(Ïúº)ÏÑ∏Ïöî","-(Ïúº)„Ñπ Í±∞ÏòàÏöî",
  "-ÏßÄ ÎßàÏÑ∏Ïöî","-ÏïÑ/Ïñ¥ Ï£ºÏÑ∏Ïöî","-ÏïÑ/Ïñ¥Ïïº ÎèºÏöî","-(Ïúº)„Ñπ Ïàò ÏûàÏñ¥Ïöî","-(Ïúº)„Ñπ Ïàò ÏóÜÏñ¥Ïöî",
  "-ÎçîÎùºÍ≥†Ïöî","-ÎÑ§Ïöî","-Íµ∞Ïöî","-Í≥† ÎÇòÏÑú","-Í∏∞ Ï†ÑÏóê","-(Ïúº)Î©¥ÏÑú","-(Ïúº)Î©∞",
  "-(Ïúº)„ÑπÏßÄÎèÑ Î™∞ÎùºÏöî","-(Ïúº)„ÑπÍ≤åÏöî","-(Ïúº)„ÑπÎûòÏöî?","-(Ïúº)„ÑπÍπåÏöî?","-Îäî Í≤å Ïñ¥ÎïåÏöî?",
  "-Îäî Ï§ëÏù¥ÏóêÏöî","-ÏïÑ/Ïñ¥ÎèÑ ÎèºÏöî","-(Ïúº)Î©¥ Ïïà ÎèºÏöî","-(Ïúº)ÎÇò","-(Ïúº)ÎØÄÎ°ú","-(Ïúº)„Ñ¥/Îäî ÎßåÌÅº",
  "-(Ïúº)„ÑπÏàòÎ°ù","-(Ïúº)„Ñ¥/ÎäîÎç∞ÎèÑ","-(Ïúº)„ÑπÏßÄÎùºÎèÑ","-(Ïúº)„Ñ¥/Îäî Î∞òÎ©¥Ïóê","-ÎèÑÎ°ù ÌïòÎã§",
  "-Í≤å ÎêòÎã§","-ÏïÑ/Ïñ¥ÏßÄÎã§","-Í∏∞ ÎßàÎ†®Ïù¥Îã§","-Í∏∞Ïóê","-Í∏∏Îûò","-Í≥† ÎßêÎã§","-Í≥†Ïûê ÌïòÎã§","-(Ïúº)„Ñπ ÎøêÏù¥Îã§"
];

/* === TRADUCERI (coreeanƒÉ ‚Üí rom√¢nƒÉ) === */
const translations = {
  subject:{ "Ï†Ä":"eu (formal)","ÎÇò":"eu (informal)","ÎÑà":"tu","Ïö∞Î¶¨":"noi","ÎÑàÌù¨":"voi",
    "ÏÇ¨Îûå":"persoanƒÉ","ÌïôÏÉù":"student/ƒÉ","ÏÑ†ÏÉùÎãò":"profesor","ÏßÅÏõê":"angajat",
    "Î∂ÄÎ™®Îãò":"pƒÉrin»õi","ÏïÑÏù¥":"copil","Ïñ¥Î•∏":"adult","Í≥†Í∞ù":"client","ÏùòÏÇ¨":"medic",
    "Í∞ÑÌò∏ÏÇ¨":"asistentƒÉ","Ïó∞Íµ¨Ïûê":"cercetƒÉtor","ÎåÄÌëú":"reprezentant","ÌôòÏûê":"pacient"
  },
  time:{ "Ïò§Îäò":"astƒÉzi","Ïñ¥Ï†ú":"ieri","ÎÇ¥Ïùº":"m√¢ine","ÏßÄÍ∏à":"acum","Î∞©Í∏à":"tocmai acum",
    "Ï°∞Í∏à ÌõÑÏóê":"pu»õin mai t√¢rziu","Í≥ß":"√Æn cur√¢nd","ÏµúÍ∑ºÏóê":"recent","ÏöîÏ¶ò":"√Æn ultima vreme",
    "ÎßàÏπ®ÎÇ¥":"√Æn cele din urmƒÉ","Í≤∞Íµ≠":"p√¢nƒÉ la urmƒÉ","Ïù¥Ï†ÑÏóê":"√Ænainte","Ïù¥ÌõÑÏóê":"dupƒÉ",
    "ÎãπÏãúÏóê":"atunci","ÌïúÎèôÏïà":"o perioadƒÉ","Í≥ÑÏÜç":"continuƒÉ","Í∞ÄÎÅî":"din c√¢nd √Æn c√¢nd",
    "Ìï≠ÏÉÅ":"√Æntotdeauna","ÏûêÏ£º":"des","Ï†êÏ†ê":"din ce √Æn ce","Ï∞®Ï∏∞":"treptat",
    "ÏùºÏ∞ç":"devreme","Îä¶Í≤å":"t√¢rziu"
  },
  place:{ "Ïßë":"acasƒÉ","ÌïôÍµê":"»ôcoalƒÉ","ÌöåÏÇ¨":"firmƒÉ / companie","ÏãùÎãπ":"restaurant","Ïπ¥Ìéò":"cafenea",
    "ÎèÑÏÑúÍ¥Ä":"bibliotecƒÉ","Î≥ëÏõê":"spital","ÏãúÏû•":"pia»õƒÉ","Î∞±ÌôîÏ†ê":"magazin universal",
    "Í≥µÌï≠":"aeroport","Í∏∞Ï∞®Ïó≠":"garƒÉ","Î≤ÑÏä§Ï†ïÎ•òÏû•":"sta»õie de autobuz","Ïó∞Íµ¨ÏÜå":"laborator",
    "Í∏∞Í¥Ä":"institu»õie","ÏßÄÏó≠ÏÇ¨Ìöå":"comunitate","ÌôòÍ≤Ω":"mediu","ÎåÄÍ∏∞ÏóÖ":"corpora»õie mare",
    "ÌöåÏùòÏã§":"salƒÉ de »ôedin»õe","Î≤ïÏõê":"instan»õƒÉ","Í≤ΩÏ∞∞ÏÑú":"sec»õie de poli»õie",
    "Ìï¥Î≥Ä":"plajƒÉ","ÏÇ∞":"munte","Í≥µÏõê":"parc","ÏùÄÌñâ":"bancƒÉ"
  },
  mod:{ "Ïûò":"bine","Ïó¥Ïã¨Ìûà":"cu s√¢rguin»õƒÉ","Ï°∞Ïö©Ìûà":"√Æn lini»ôte","Ï≤úÏ≤úÌûà":"√Æncet",
    "Îπ®Î¶¨":"repede","Ï†ïÎßê":"cu adevƒÉrat","ÏïÑÏ£º":"foarte","ÎÑàÎ¨¥":"prea / foarte",
    "ÎßéÏù¥":"mult","Ï°∞Í∏à":"pu»õin","Í∞ëÏûêÍ∏∞":"brusc","ÎØ∏Î¶¨":"√Æn avans","Î≤åÏç®":"deja",
    "ÏïÑÍπå":"mai devreme","Î∞©Í∏à":"chiar acum","Í∏àÎ∞©":"imediat","Í≥ß":"√Æn cur√¢nd",
    "Ìï≠ÏÉÅ":"mereu","ÏûêÏ£º":"des","Í∞ÄÎÅî":"din c√¢nd √Æn c√¢nd","ÎìúÎ¨ºÍ≤å":"rar",
    "ÏÉÅÎãπÌûà":"destul de","ÍΩ§":"bini»ôor","ÎèÑÎåÄÏ≤¥":"(deloc / √Æn √ÆntrebƒÉri)",
    "Ï†àÎåÄÎ°ú":"niciodatƒÉ (interdic»õie)","Ï†ÅÍ∑πÏ†ÅÏúºÎ°ú":"activ","Ï∂©Î∂ÑÌûà":"suficient",
    "ÌäπÌûà":"√Æn special","Ïò§ÌûàÎ†§":"mai degrabƒÉ","Ï†êÏ†ê":"din ce √Æn ce","Ï∞®Ï∏∞":"treptat",
    "Í≥ÑÏÜç":"√Æn mod continuu"
  },
  object:{ "Ï±Ö":"carte","Ïª§Ìîº":"cafea","Î¨º":"apƒÉ","ÏùåÏãù":"m√¢ncare","ÏòÅÌôî":"film",
    "Í∞ÄÎ∞©":"geantƒÉ","Ï†ÑÌôî":"telefon","Ïò∑":"haine","ÏûêÎ£å":"materiale","Îç∞Ïù¥ÌÑ∞":"date",
    "Í≥ÑÌöç":"plan","Ï°∞Í±¥":"condi»õie","ÏÉÅÌô©":"situa»õie","Î¨∏Ï†ú":"problemƒÉ",
    "Ìï¥Í≤∞Ï±Ö":"solu»õie","ÏöîÏïΩ":"rezumat","Î≥¥Í≥†ÏÑú":"raport","Î¨∏ÏÑú":"document",
    "Ïª¥Ìì®ÌÑ∞":"calculator","ÎÖ∏Ìä∏Î∂Å":"laptop","Ìé∏ÏßÄ":"scrisoare","ÏÑ†Î¨º":"cadou",
    "ÏùòÍ≤¨":"opinie","Ï†ïÎ≥¥":"informa»õie","Í¥ÄÍ≥Ñ":"rela»õie","Í≤∞Í≥º":"rezultat",
    "ÏõêÏù∏":"cauzƒÉ","Î∞©Î≤ï":"metodƒÉ","Ï†úÌíà":"produs","ÏÑúÎπÑÏä§":"serviciu",
    "Ï†ïÏ±Ö":"politicƒÉ","Î¨∏Ìôî":"culturƒÉ"
  },
  numeral:{},
  counter:{ "Í∞ú":"bucatƒÉ","Î™Ö":"persoanƒÉ","Í∂å":"volum (carte)","Ïû•":"foaie / paginƒÉ",
    "ÎåÄ":"aparat / vehicul","Î≥ë":"sticlƒÉ","Ïûî":"canƒÉ / pahar",
    "ÎßàÎ¶¨":"animal","Î≤à":"datƒÉ","ÏÇ¥":"ani (v√¢rstƒÉ)","ÏÜ°Ïù¥":"buchet / ciorchine",
    "Ï§Ñ":"r√¢nd / »ôir","Ï†ê":"punct","Í±¥":"caz","Ìöå":"datƒÉ (ocazie)",
    "Í∞ÄÏßÄ":"fel / tip","Ï™Ω":"paginƒÉ / direc»õie"
  },
  verb:{
    "Í∞ÄÎã§":"a merge","Ïò§Îã§":"a veni","Î®πÎã§":"a m√¢nca","ÎßàÏãúÎã§":"a bea","Î≥¥Îã§":"a vedea / a se uita",
    "ÏùΩÎã§":"a citi","Ïì∞Îã§":"a scrie","Î∞∞Ïö∞Îã§":"a √ÆnvƒÉ»õa","ÏÇ¨Îã§":"a cumpƒÉra","Ï£ºÎã§":"a da",
    "Î∞õÎã§":"a primi","ÏùºÌïòÎã§":"a lucra","Í≥µÎ∂ÄÌïòÎã§":"a studia","ÏöîÎ¶¨ÌïòÎã§":"a gƒÉti",
    "Ï≤≠ÏÜåÌïòÎã§":"a face curat","Ï§ÄÎπÑÌïòÎã§":"a pregƒÉti","ÎèÑÏôÄÏ£ºÎã§":"a ajuta",
    "ÏÇ¨Ïö©ÌïòÎã§":"a folosi","ÌïÑÏöîÌïòÎã§":"a fi necesar","Ï¢ãÏïÑÌïòÎã§":"a plƒÉcea",
    "Ïã´Ïñ¥ÌïòÎã§":"a nu plƒÉcea / a ur√Æ","Í∏∞Îã§Î¶¨Îã§":"a a»ôtepta","Ïâ¨Îã§":"a se odihni",
    "ÎßåÎÇòÎã§":"a se √Ænt√¢lni","Í±∑Îã§":"a merge pe jos","Îã¨Î¶¨Îã§":"a alerga",
    "ÏïâÎã§":"a se a»ôeza","ÏÑúÎã§":"a sta √Æn picioare","Í≤∞Ï†ïÌïòÎã§":"a decide",
    "Ï†úÏïàÌïòÎã§":"a propune","Ï†ÑÎã¨ÌïòÎã§":"a transmite","Ïú†ÏßÄÌïòÎã§":"a men»õine",
    "Î∞úÏÉùÌïòÎã§":"a se produce","Ï¶ùÍ∞ÄÌïòÎã§":"a cre»ôte","Í∞êÏÜåÌïòÎã§":"a scƒÉdea",
    "Ïù∏Ï†ïÌïòÎã§":"a recunoa»ôte","Î∂ÑÏÑùÌïòÎã§":"a analiza","Í¥ÄÏ∞∞ÌïòÎã§":"a observa",
    "Ìï¥Í≤∞ÌïòÎã§":"a rezolva","Ïó∞Íµ¨ÌïòÎã§":"a cerceta","ÌòëÎ†•ÌïòÎã§":"a colabora",
    "ÏöîÏ≤≠ÌïòÎã§":"a solicita","Ï∂©Ï°±ÌïòÎã§":"a satisface","ÎπÑÍµêÌïòÎã§":"a compara",
    "ÏÑ§Î™ÖÌïòÎã§":"a explica","ÏòàÏÉÅÌïòÎã§":"a anticipa"
  },
  conjug:{
    "-ÏïÑÏöî/Ïñ¥Ïöî":"prezent politicos",
    "-ÏïòÏñ¥Ïöî/ÏóàÏñ¥Ïöî":"trecut politicos",
    "-Í≥† ÏûàÏñ¥Ïöî":"ac»õiune √Æn desfƒÉ»ôurare",
    "-Í≥† Ïã∂Ïñ¥Ïöî":"vreau sƒÉ...",
    "-(Ïúº)ÏÑ∏Ïöî":"imperativ / onorific",
    "-(Ïúº)„Ñπ Í±∞ÏòàÏöî":"viitor",
    "-ÏßÄ ÎßàÏÑ∏Ïöî":"nu face»õi..., vƒÉ rog",
    "-ÏïÑ/Ïñ¥ Ï£ºÏÑ∏Ïöî":"vƒÉ rog sƒÉ...",
    "-ÏïÑ/Ïñ¥Ïïº ÎèºÏöî":"trebuie sƒÉ...",
    "-(Ïúº)„Ñπ Ïàò ÏûàÏñ¥Ïöî":"pot sƒÉ...",
    "-(Ïúº)„Ñπ Ïàò ÏóÜÏñ¥Ïöî":"nu pot sƒÉ...",
    "-ÎçîÎùºÍ≥†Ïöî":"am observat cƒÉ...",
    "-ÎÑ§Ïöî":"exclamativ (observa»õie surprinsƒÉ)",
    "-Íµ∞Ïöî":"exclamativ (constatare)",
    "-Í≥† ÎÇòÏÑú":"dupƒÉ ce...",
    "-Í∏∞ Ï†ÑÏóê":"√Ænainte sƒÉ...",
    "-(Ïúº)Î©¥ÏÑú":"√Æn timp ce...",
    "-(Ïúº)Î©∞":"»ôi (√Æn timp ce)",
    "-(Ïúº)„ÑπÏßÄÎèÑ Î™∞ÎùºÏöî":"s-ar putea sƒÉ...",
    "-(Ïúº)„ÑπÍ≤åÏöî":"voi face (pentru tine)",
    "-(Ïúº)„ÑπÎûòÏöî?":"ai chef sƒÉ...? / vreau sƒÉ...",
    "-(Ïúº)„ÑπÍπåÏöî?":"sƒÉ facem...?",
    "-Îäî Í≤å Ïñ¥ÎïåÏöî?":"ce-ar fi sƒÉ...?",
    "-Îäî Ï§ëÏù¥ÏóêÏöî":"sunt √Æn mijlocul ac»õiunii",
    "-ÏïÑ/Ïñ¥ÎèÑ ÎèºÏöî":"po»õi sƒÉ..., e √Æn regulƒÉ",
    "-(Ïúº)Î©¥ Ïïà ÎèºÏöî":"nu ai voie sƒÉ...",
    "-ÎèÑÎ°ù ÌïòÎã§":"sƒÉ faci √Æn a»ôa fel √Ænc√¢t sƒÉ...",
    "-Í≤å ÎêòÎã§":"ajungi sƒÉ...",
    "-ÏïÑ/Ïñ¥ÏßÄÎã§":"a deveni...",
    "-Í∏∞Ïóê":"pentru cƒÉ..., fiindcƒÉ",
    "-Í∏∏Îûò":"pentru cƒÉ (am vƒÉzut / sim»õit eu)",
    "-Í≥† ÎßêÎã§":"√Æn cele din urmƒÉ ajunge sƒÉ...",
    "-Í≥†Ïûê ÌïòÎã§":"a inten»õiona sƒÉ...",
    "-(Ïúº)„Ñπ ÎøêÏù¥Îã§":"doar..., nimic altceva"
  }
};

/* === SALVARE CUVINTE NOI === */
const STORAGE_KEY="ralucaKoreanCustomWords_v2";
const customData={
  subject:[],time:[],place:[],mod:[],object:[],
  numeral:[],counter:[],verb:[],conjug:[]
};
function loadCustomData(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw)return;
    const saved=JSON.parse(raw);
    Object.keys(customData).forEach(k=>{
      if(Array.isArray(saved[k]))customData[k]=saved[k];
    });
    Object.entries(customData).forEach(([key,arr])=>{
      arr.forEach(entry=>{
        if(!entry||!entry.word)return;
        const w=entry.word,ro=entry.ro||"";
        let ref=null;
        if(key==="subject")ref=subjects;
        else if(key==="time")ref=times;
        else if(key==="place")ref=places;
        else if(key==="mod")ref=mods;
        else if(key==="object")ref=objects;
        else if(key==="numeral")ref=numerals;
        else if(key==="counter")ref=counters;
        else if(key==="verb")ref=verbs;
        else if(key==="conjug")ref=conjugations;
        if(ref&&!ref.includes(w))ref.push(w);
        if(!translations[key])translations[key]={};
        if(ro)translations[key][w]=ro;
      });
    });
  }catch(e){}
}
function saveCustomData(){
  try{localStorage.setItem(STORAGE_KEY,JSON.stringify(customData));}catch(e){}
}
loadCustomData();

/* === HANGUL helperi pt conjugare === */
const H_BASE=0xAC00;
const JONG=["","„Ñ±","„Ñ≤","„Ñ≥","„Ñ¥","„Ñµ","„Ñ∂","„Ñ∑","„Ñπ","„Ñ∫","„Ñª","„Ñº","„ÑΩ","„Ñæ","„Ñø","„ÖÄ",
            "„ÖÅ","„ÖÇ","„ÖÑ","„ÖÖ","„ÖÜ","„Öá","„Öà","„Öä","„Öã","„Öå","„Öç","„Öé"];
const JUNG=["„Öè","„Öê","„Öë","„Öí","„Öì","„Öî","„Öï","„Öñ","„Öó","„Öò","„Öô","„Öö","„Öõ",
            "„Öú","„Öù","„Öû","„Öü","„Ö†","„Ö°","„Ö¢","„Ö£"];

function decomposeLastSyl(word){
  if(!word)return null;
  const ch=word.charCodeAt(word.length-1);
  const code=ch-H_BASE;
  if(code<0||code>11171)return null;
  const jong=code%28;
  const jung=((code-jong)/28)%21;
  const cho=Math.floor((code-jong)/28/21);
  return{cho,jung,jong,prefix:word.slice(0,-1)};
}
function hasBatchim(s){
  const d=decomposeLastSyl(s);
  return d?d.jong!==0:false;
}
function getVerbStem(dict){
  if(!dict)return"";
  return dict.endsWith("Îã§")?dict.slice(0,-1):dict;
}

/* verbe speciale */
const specialVerbMap={
  "Í∞ÄÎã§":{present:"Í∞ÄÏöî",past:"Í∞îÏñ¥Ïöî"},
  "Ïò§Îã§":{present:"ÏôÄÏöî",past:"ÏôîÏñ¥Ïöî"},
  "Î≥¥Îã§":{present:"Î¥êÏöî",past:"Î¥§Ïñ¥Ïöî"},
  "ÌïòÎã§":{present:"Ìï¥Ïöî",past:"ÌñàÏñ¥Ïöî"},
  "Î®πÎã§":{past:"Î®πÏóàÏñ¥Ïöî"},
  "ÏùΩÎã§":{past:"ÏùΩÏóàÏñ¥Ïöî"},
  "ÎßàÏãúÎã§":{past:"ÎßàÏÖ®Ïñ¥Ïöî"},
  "ÏÇ¥Îã§":{past:"ÏÇ¥ÏïòÏñ¥Ïöî"}
};

function presentPolite(dict){
  if(specialVerbMap[dict]?.present)return specialVerbMap[dict].present;
  if(dict==="ÌïòÎã§")return"Ìï¥Ïöî";
  const stem=getVerbStem(dict);
  const d=decomposeLastSyl(stem);
  if(!d)return stem+"Ïöî";
  const v=JUNG[d.jung];
  const aGroup=["„Öè","„Öë","„Öó","„Öõ","„Öò","„Öô","„Öö"].includes(v);
  if(stem.length===1&&aGroup)return stem+"Ïöî";
  return stem+(aGroup?"ÏïÑÏöî":"Ïñ¥Ïöî");
}
function pastPolite(dict){
  if(specialVerbMap[dict]?.past)return specialVerbMap[dict].past;
  if(dict==="ÌïòÎã§")return"ÌñàÏñ¥Ïöî";
  const stem=getVerbStem(dict);
  const d=decomposeLastSyl(stem);
  if(!d)return stem+"ÏóàÏñ¥Ïöî";
  const v=JUNG[d.jung];
  const aGroup=["„Öè","„Öë","„Öó","„Öõ","„Öò","„Öô","„Öö"].includes(v);
  if(aGroup)return stem+"ÏïòÏñ¥Ïöî";
  return stem+"ÏóàÏñ¥Ïöî";
}
function stemPlusAeo(dict){
  if(dict==="ÌïòÎã§")return"Ìï¥";
  const stem=getVerbStem(dict);
  const d=decomposeLastSyl(stem);
  if(!d)return stem;
  const v=JUNG[d.jung];
  const aGroup=["„Öè","„Öë","„Öó","„Öõ","„Öò","„Öô","„Öö"].includes(v);
  if(stem.length===1&&aGroup)return stem;
  return stem+(aGroup?"ÏïÑ":"Ïñ¥");
}

/* FUTUR -(Ïúº)„Ñπ‚Ä¶ cu compunerea corectƒÉ a lui „Ñπ */
function futureL(dict){
  const stem=getVerbStem(dict);
  const d=decomposeLastSyl(stem);
  if(!d)return stem+"·ÜØ"; // fallback rar
  if(d.jong===0){
    // fƒÉrƒÉ batchim ‚Üí punem „Ñπ ca Î∞õÏπ®: Ïûê ‚Üí Ïûò, Í∞Ä ‚Üí Í∞à
    const newCode=H_BASE + d.cho*21*28 + d.jung*28 + 8; // index 8 = „Ñπ
    const ch=String.fromCharCode(newCode);
    return d.prefix+ch;
  }else{
    // cu batchim ‚Üí adƒÉugƒÉm "ÏùÑ" separat: Î®πÎã§ ‚Üí Î®πÏùÑ
    return stem+"ÏùÑ";
  }
}

/* conjugƒÉri care leagƒÉ P2 */
const linkingConjugations=new Set([
  "-Í≥† ÎÇòÏÑú","-Í∏∞ Ï†ÑÏóê","-(Ïúº)Î©¥ÏÑú","-(Ïúº)Î©∞",
  "-(Ïúº)ÎÇò","-(Ïúº)ÎØÄÎ°ú","-(Ïúº)„Ñ¥/Îäî ÎßåÌÅº",
  "-(Ïúº)„ÑπÏàòÎ°ù","-(Ïúº)„Ñ¥/ÎäîÎç∞ÎèÑ","-(Ïúº)„ÑπÏßÄÎùºÎèÑ",
  "-(Ïúº)„Ñ¥/Îäî Î∞òÎ©¥Ïóê","-ÎèÑÎ°ù ÌïòÎã§","-Í∏∞Ïóê","-Í∏∏Îûò","-Í≥† ÎßêÎã§","-Í≥†Ïûê ÌïòÎã§"
]);
const isLinkingConj=v=>linkingConjugations.has(v);

/* ce conjugƒÉri ‚Äûtrag‚Äù spre trecut / viitor */
const timePastWords=new Set(["Ïñ¥Ï†ú","Ïù¥Ï†ÑÏóê","ÎãπÏãúÏóê","ÌïúÎèôÏïà","ÏµúÍ∑ºÏóê","ÎßàÏπ®ÎÇ¥","Í≤∞Íµ≠","Î∞©Í∏à"]);
const timeFutureWords=new Set(["ÎÇ¥Ïùº","Ï°∞Í∏à ÌõÑÏóê","Í≥ß","Ïù¥ÌõÑÏóê"]);
const conjPastLike=new Set(["-ÏïòÏñ¥Ïöî/ÏóàÏñ¥Ïöî","-ÎçîÎùºÍ≥†Ïöî"]);
const conjFutureLike=new Set(["-(Ïúº)„Ñπ Í±∞ÏòàÏöî","-(Ïúº)„ÑπÍ≤åÏöî","-(Ïúº)„ÑπÎûòÏöî?","-(Ïúº)„ÑπÏßÄÎèÑ Î™∞ÎùºÏöî"]);
function conjugationType(cj){
  if(!cj)return"none";
  if(conjPastLike.has(cj))return"past";
  if(conjFutureLike.has(cj))return"future";
  return"present";
}

/* === VERB + CONJUGARE ‚Üí expresie finalƒÉ coreeanƒÉ === */
function buildVerbPhrase(dictVerb,cj){
  if(!dictVerb&&!cj)return"";
  if(!dictVerb)return cj||"";
  if(!cj)return dictVerb;

  if(cj==="-ÏïÑÏöî/Ïñ¥Ïöî")return presentPolite(dictVerb);
  if(cj==="-ÏïòÏñ¥Ïöî/ÏóàÏñ¥Ïöî")return pastPolite(dictVerb);
  if(cj==="-(Ïúº)ÏÑ∏Ïöî")return futureL(dictVerb)+"ÏÑ∏Ïöî";
  if(cj==="-(Ïúº)„Ñπ Í±∞ÏòàÏöî")return futureL(dictVerb)+" Í±∞ÏòàÏöî";
  if(cj==="-(Ïúº)„ÑπÍ≤åÏöî")return futureL(dictVerb)+"Í≤åÏöî";
  if(cj==="-(Ïúº)„ÑπÎûòÏöî?")return futureL(dictVerb)+"ÎûòÏöî?";
  if(cj==="-(Ïúº)„ÑπÍπåÏöî?")return futureL(dictVerb)+"ÍπåÏöî?";
  if(cj==="-(Ïúº)„Ñπ Ïàò ÏûàÏñ¥Ïöî")return futureL(dictVerb)+" Ïàò ÏûàÏñ¥Ïöî";
  if(cj==="-(Ïúº)„Ñπ Ïàò ÏóÜÏñ¥Ïöî")return futureL(dictVerb)+" Ïàò ÏóÜÏñ¥Ïöî";
  if(cj==="-(Ïúº)„ÑπÏßÄÎèÑ Î™∞ÎùºÏöî")return futureL(dictVerb)+"ÏßÄÎèÑ Î™∞ÎùºÏöî";

  if(cj==="-Í≥† ÏûàÏñ¥Ïöî")return getVerbStem(dictVerb)+"Í≥† ÏûàÏñ¥Ïöî";
  if(cj==="-Í≥† Ïã∂Ïñ¥Ïöî")return getVerbStem(dictVerb)+"Í≥† Ïã∂Ïñ¥Ïöî";
  if(cj==="-ÏßÄ ÎßàÏÑ∏Ïöî")return getVerbStem(dictVerb)+"ÏßÄ ÎßàÏÑ∏Ïöî";
  if(cj==="-ÏïÑ/Ïñ¥ Ï£ºÏÑ∏Ïöî")return stemPlusAeo(dictVerb)+" Ï£ºÏÑ∏Ïöî";
  if(cj==="-ÏïÑ/Ïñ¥Ïïº ÎèºÏöî")return stemPlusAeo(dictVerb)+"Ïïº ÎèºÏöî";
  if(cj==="-Îäî Ï§ëÏù¥ÏóêÏöî")return getVerbStem(dictVerb)+"Îäî Ï§ëÏù¥ÏóêÏöî";
  if(cj==="-ÏïÑ/Ïñ¥ÎèÑ ÎèºÏöî")return stemPlusAeo(dictVerb)+"ÎèÑ ÎèºÏöî";

  if(cj==="-Í≤å ÎêòÎã§")return getVerbStem(dictVerb)+"Í≤å ÎèºÏöî";
  if(cj==="-ÏïÑ/Ïñ¥ÏßÄÎã§")return stemPlusAeo(dictVerb)+"ÏßÄÎã§";

  if(isLinkingConj(cj)){
    if(cj==="-Í≥† ÎÇòÏÑú")return getVerbStem(dictVerb)+"Í≥† ÎÇòÏÑú";
    if(cj==="-Í∏∞ Ï†ÑÏóê")return getVerbStem(dictVerb)+"Í∏∞ Ï†ÑÏóê";
    if(cj.includes("Î©¥ÏÑú"))return getVerbStem(dictVerb)+"Î©¥ÏÑú";
    if(cj.includes("Î©∞"))return getVerbStem(dictVerb)+"Î©∞";
    if(cj==="-ÎèÑÎ°ù ÌïòÎã§")return getVerbStem(dictVerb)+"ÎèÑÎ°ù Ìï¥Ïöî";
    if(cj==="-Í≥† ÎßêÎã§")return getVerbStem(dictVerb)+"Í≥† ÎßêÏïòÏñ¥Ïöî";
    if(cj==="-Í≥†Ïûê ÌïòÎã§")return getVerbStem(dictVerb)+"Í≥†Ïûê Ìï¥Ïöî";
    if(cj==="-Í∏∞Ïóê")return getVerbStem(dictVerb)+"Í∏∞Ïóê";
    if(cj==="-Í∏∏Îûò")return getVerbStem(dictVerb)+"Í∏∏Îûò";
    return getVerbStem(dictVerb)+cj.replace(/^-/, "");
  }

  // fallback ‚Äì verb + final, fƒÉrƒÉ spa»õiu »ôi fƒÉrƒÉ ‚Äû-‚Äù
return getVerbStem(dictVerb)+cj.replace(/^-/, "");
}

/* === RESTUL APP-ULUI (builder, preview etc.) === */

const glossaryEntries=[];
const columns=[
  {key:"subject",title:"SUBJECT",ko:"Ï£ºÏñ¥",data:subjects,hint:"Cine?",allowCustom:true},
  {key:"time",title:"TIME",ko:"ÏãúÍ∞Ñ",data:times,hint:"C√¢nd?",allowCustom:true},
  {key:"place",title:"PLACE",ko:"Ïû•ÏÜå",data:places,hint:"Unde?",allowCustom:true},
  {key:"mod",title:"MOD",ko:"Î∞©Î≤ï",data:mods,hint:"Cum?",allowCustom:true},
  {key:"object",title:"OBJECT",ko:"Î™©Ï†ÅÏñ¥",data:objects,hint:"Ce?",allowCustom:true},
  {key:"numeral",title:"NUMERAL",ko:"",data:numerals,hint:"NumƒÉr",allowCustom:true},
  {key:"counter",title:"COUNTER",ko:"ÏàòÎüâÏÇ¨",data:counters,hint:"Clasificator",allowCustom:true},
  {key:"verb",title:"VERB",ko:"ÎèôÏÇ¨",data:verbs,hint:"Ac»õiune",allowCustom:true},
  {key:"conjug",title:"CONJUGƒÇRI",ko:"",data:conjugations,hint:"FormƒÉ verbalƒÉ",allowCustom:true}
];
const maxLen=Math.max(...columns.map(c=>c.data.length));

let index=0;
const stateP1={},stateP2={},activeP1={},activeP2={};
columns.forEach(col=>{
  stateP1[col.key]=col.data[0]||"";
  stateP2[col.key]=col.data[0]||"";
  activeP1[col.key]=true;
  activeP2[col.key]=true;
});

/* referin»õe DOM (presupunem cƒÉ restul HTML e ca √Æn versiunea ta actualƒÉ) */
const tableP1=document.getElementById("tableP1");
const tableP2=document.getElementById("tableP2");
const titleP2=document.getElementById("titleP2");
const togglesP1=document.getElementById("togglesP1");
const togglesP2=document.getElementById("togglesP2");
const enableP2=document.getElementById("enableP2");
const prevBtn=document.getElementById("prevBtn");
const nextBtn=document.getElementById("nextBtn");
const resetBtn=document.getElementById("resetBtn");
const pageInfoEl=document.getElementById("pageInfo");
const previewKo=document.getElementById("previewKo");
const previewRo=document.getElementById("previewRo");
const naturalHint=document.getElementById("naturalHint");
const toggleRoBtn=document.getElementById("toggleRoBtn");
const randomBtn=document.getElementById("randomBtn");
const speakBtn=document.getElementById("speakBtn");
const favBtn=document.getElementById("favBtn");
const overlay=document.getElementById("overlay");
const panelTitle=document.getElementById("panelTitle");
const panelSub=document.getElementById("panelSub");
const panelList=document.getElementById("panelList");
const closePanelBtn=document.getElementById("closePanelBtn");
const panelSearchInput=document.getElementById("panelSearchInput");
const newWordInput=document.getElementById("newWordInput");
const newWordTransInput=document.getElementById("newWordTransInput");
const addWordBtn=document.getElementById("addWordBtn");
const modeButtons=document.querySelectorAll(".small-mode-btn");
const subtitleEl=document.getElementById("subtitle");
const screens={
  builder:document.getElementById("screen-builder"),
  exercises:document.getElementById("screen-exercises"),
  glossary:document.getElementById("screen-glossary")
};
const navButtons=document.querySelectorAll(".nav-btn");

/* mod simplu / TOPIK */
let currentMode="topik";
const simpleColumnsSet={subject:true,time:true,object:true,verb:true,conjug:true};
function isColumnVisible(key){
  return currentMode==="topik"||!!simpleColumnsSet[key];
}
modeButtons.forEach(btn=>{
  btn.addEventListener("click",()=>{
    currentMode=btn.dataset.mode;
    modeButtons.forEach(b=>b.classList.toggle("active",b===btn));
    render();
  });
});

/* navigare ecrane */
function setScreen(name){
  Object.entries(screens).forEach(([k,el])=>{
    el.classList.toggle("active",k===name);
  });
  navButtons.forEach(btn=>btn.classList.toggle("active",btn.dataset.target===name));
  if(name==="builder")subtitleEl.textContent="Builder propozi»õii + particule + audio + conjugƒÉri";
  else if(name==="exercises")subtitleEl.textContent="Exerci»õii TOPIK ‚Äì verb, particulƒÉ, conjugare";
  else subtitleEl.textContent="Glosar + propozi»õii favorite";
}
navButtons.forEach(btn=>btn.addEventListener("click",()=>setScreen(btn.dataset.target)));

/* toggles P1 / P2 */
function createToggleChips(){
  columns.forEach(col=>{
    const chip1=document.createElement("label");
    chip1.className="chip";
    const cb1=document.createElement("input");
    cb1.type="checkbox";cb1.checked=true;cb1.dataset.key=col.key;cb1.dataset.clause="p1";
    chip1.appendChild(cb1);chip1.append(col.title);togglesP1.appendChild(chip1);

    const chip2=document.createElement("label");
    chip2.className="chip";
    const cb2=document.createElement("input");
    cb2.type="checkbox";cb2.checked=true;cb2.dataset.key=col.key;cb2.dataset.clause="p2";
    chip2.appendChild(cb2);chip2.append(col.title);togglesP2.appendChild(chip2);
  });
  const sync=(wrapper,map)=>{
    wrapper.addEventListener("change",e=>{
      const cb=e.target;if(cb.tagName!=="INPUT")return;
      map[cb.dataset.key]=cb.checked;render();
    });
  };
  sync(togglesP1,activeP1);
  sync(togglesP2,activeP2);
}
createToggleChips();

enableP2.addEventListener("change",()=>{
  const on=enableP2.checked;
  if(on){titleP2.classList.remove("hidden");tableP2.classList.remove("hidden");}
  else{titleP2.classList.add("hidden");tableP2.classList.add("hidden");}
  updatePreview();
});

/* helper particule */
const pronouns=new Set(["Ï†Ä","ÎÇò","ÎÑà","Ïö∞Î¶¨","ÎÑàÌù¨"]);
function addSubjectWithParticle(word){
  if(!word)return"";
  const b=hasBatchim(word);
  if(pronouns.has(word))return word+(b?"ÏùÄ":"Îäî");
  return word+(b?"Ïù¥":"Í∞Ä");
}
const timeAdverbsNoParticle=new Set(["Ïò§Îäò","Ïñ¥Ï†ú","ÎÇ¥Ïùº","ÏßÄÍ∏à","Î∞©Í∏à","ÏöîÏ¶ò","Ìï≠ÏÉÅ","ÏûêÏ£º","Í∞ÄÎÅî","Í≥ÑÏÜç","Ï†êÏ†ê","Ï∞®Ï∏∞"]);
function addTimeWithParticle(word){
  if(!word)return"";
  if(timeAdverbsNoParticle.has(word))return word;
  return word+"Ïóê";
}
function addPlaceWithParticle(word){
  if(!word)return"";
  return word+"ÏóêÏÑú";
}
function addObjectWithParticle(word){
  if(!word)return"";
  return word+(hasBatchim(word)?"ÏùÑ":"Î•º");
}

/* desenare coloane */
function renderClauseRow(container,activeMap,state,clauseId){
  container.innerHTML="";
  columns.forEach(col=>{
    if(!isColumnVisible(col.key))return;
    const colDiv=document.createElement("div");
    colDiv.className="col";
    if(!activeMap[col.key])colDiv.classList.add("dimmed");
    colDiv.dataset.key=col.key;
    colDiv.dataset.clause=clauseId;

    const header=document.createElement("div");
    header.className="col-header";
    header.textContent=col.title+(col.ko?` (${col.ko})`:"");
    colDiv.appendChild(header);

    const label=document.createElement("div");
    label.className="col-body-label";
    label.textContent=col.hint||"";
    colDiv.appendChild(label);

    const main=document.createElement("div");
    main.className="col-body-main";
    main.textContent=state[col.key]||"";
    colDiv.appendChild(main);

    const extra=document.createElement("div");
    extra.className="col-body-extra";
    if(col.key==="conjug"&&state[col.key]&&isLinkingConj(state[col.key]))extra.textContent="‚≠ê cere propozi»õia 2";
    colDiv.appendChild(extra);
    container.appendChild(colDiv);
  });
}

/* === CONSTRUIRE propozi»õie + traducere pe pƒÉr»õi === */
const labelsRo={
  subject:"SUBJECT",
  time:"TIME",
  place:"PLACE",
  mod:"MOD",
  object:"OBJECT",
  numeral:"NUMƒÇR",
  counter:"COUNTER",
  verb:"VERB"
};
/* Propozi»õie rom√¢neascƒÉ naturalƒÉ ‚Äì Ordine B: Timp ‚Üí Subiect ‚Üí Loc ‚Üí Mod ‚Üí Obiect ‚Üí Verb */e.conjug]) ||
   /* Propozi»õie rom√¢neascƒÉ naturalƒÉ ‚Äì Subject ‚Üí Time ‚Üí Place ‚Üí Object ‚Üí Verb(+mod) */
function buildNaturalRomanian(state, activeMap){
  const use = (key) =>
    activeMap[key] !== false && isColumnVisible(key) && state[key];

  const getRo = (catKey, stateKey) => {
    const dict = translations[catKey] || {};
    const raw = state[stateKey];
    if (!raw) return "";
    return dict[raw] || raw;
  };

  // PƒÉr»õile rom√¢ne»ôti
  const timeRo    = use("time")    ? getRo("time", "time")       : "";
  let   subjRo    = use("subject") ? getRo("subject", "subject") : "";
  const placeRo   = use("place")   ? getRo("place", "place")     : "";
  const modRo     = use("mod")     ? getRo("mod", "mod")         : "";
  const objectRo  = use("object")  ? getRo("object", "object")   : "";
  const numeralRo = use("numeral") ? (state.numeral || "")       : "";

  // Scoatem ‚Äû(formal)‚Äù din mijloc »ôi √Æl punem la final, ca explica»õie
  let subjNote = "";
  if (subjRo.includes("(formal)")) {
    subjRo   = subjRo.replace(/\s*\(formal\)/, "");
    subjNote = "(formal)";
  }

  // Verb + explica»õie de timp verbal
  const verbRaw   = state.verb || "";
  const verbRoBase =
    (translations.verb && translations.verb[verbRaw]) || verbRaw || "";
  const conjRo =
    state.conjug
      ? (translations.conjug && translations.conjug[state.conjug]) ||
        state.conjug
      : "";

  let verbCore = "";
  if (verbRoBase) {
    // ‚Äûa merge‚Äù ‚Üí ‚Äûmerge‚Äù
    verbCore = verbRoBase.replace(/^a\s+/, "");
  }

  // Verb + mod ‚Üí ‚Äûmerge bine‚Äù, iar explica»õia rƒÉm√¢ne √Æn paranteze
  let verbPhrase = "";
  if (verbCore) {
    verbPhrase = verbCore;
    if (modRo) verbPhrase += " " + modRo;
    if (conjRo) verbPhrase += ` (${conjRo})`;
  } else if (conjRo) {
    verbPhrase = `(${conjRo})`;
  }

  // Obiectul: [numƒÉr] + substantiv
  let objectPhrase = "";
  if (objectRo) {
    const objPieces = [];
    if (numeralRo) objPieces.push(numeralRo);
    objPieces.push(objectRo);
    objectPhrase = objPieces.join(" ");
  }

  // Ordine rom√¢neascƒÉ:
  // SUBJECT ‚Üí TIME ‚Üí PLACE ‚Üí OBJECT ‚Üí VERB(+mod)
  const parts = [];

  if (subjRo) parts.push(subjRo);       // Eu
  if (timeRo) parts.push(timeRo);       // astƒÉzi
  if (placeRo) parts.push(placeRo);     // acasƒÉ
  if (objectPhrase) parts.push(objectPhrase); // carte / 2 cƒÉr»õi
  if (verbPhrase) parts.push(verbPhrase);     // merg bine (prezent politicos)

  // AdƒÉugƒÉm »ôi nota ‚Äû(formal)‚Äù la final, dacƒÉ existƒÉ
  if (subjNote) parts.push(subjNote);

  if (!parts.length) return "";

  let sentence = parts.join(" ");
  sentence = sentence.replace(/\s+/g, " ").trim();

  // MajusculƒÉ + punct
  sentence = sentence.charAt(0).toUpperCase() + sentence.slice(1);
  if (!/[.!?]$/.test(sentence)) sentence += ".";

  return sentence;
}
  
function buildClauseSentence(state,activeMap,conjOverride){
  const koParts=[];
  const roSegs=[];
  const use=k=>activeMap[k]!==false && isColumnVisible(k);

  const subj=state.subject;
  if(subj&&use("subject")){
    koParts.push(addSubjectWithParticle(subj));
    const ro=(translations.subject&&translations.subject[subj])||subj;
    roSegs.push(`${labelsRo.subject}: ${ro}`);
  }

  const t=state.time;
  if(t&&use("time")){
    koParts.push(addTimeWithParticle(t));
    const ro=(translations.time&&translations.time[t])||t;
    roSegs.push(`${labelsRo.time}: ${ro}`);
  }

  const p=state.place;
  if(p&&use("place")){
    koParts.push(addPlaceWithParticle(p));
    const ro=(translations.place&&translations.place[p])||p;
    roSegs.push(`${labelsRo.place}: ${ro}`);
  }

  const m=state.mod;
  if(m&&use("mod")){
    koParts.push(m);
    const ro=(translations.mod&&translations.mod[m])||m;
    roSegs.push(`${labelsRo.mod}: ${ro}`);
  }

  const obj=state.object;
  if(obj&&use("object")){
    koParts.push(addObjectWithParticle(obj));
    const ro=(translations.object&&translations.object[obj])||obj;
    roSegs.push(`${labelsRo.object}: ${ro}`);
  }

  const num=state.numeral;
  if(num&&use("numeral")){
    koParts.push(num);
    const ro=(translations.numeral&&translations.numeral[num])||num;
    roSegs.push(`${labelsRo.numeral}: ${ro}`);
  }

  const cnt=state.counter;
  if(cnt&&use("counter")){
    koParts.push(cnt);
    const ro=(translations.counter&&translations.counter[cnt])||cnt;
    roSegs.push(`${labelsRo.counter}: ${ro}`);
  }

  const v=state.verb;
  const cjUsed=conjOverride||state.conjug;
  if(v||cjUsed){
    const vp=buildVerbPhrase(v,cjUsed);
    if(vp){
      koParts.push(vp);
      const roVerb=(translations.verb&&translations.verb[v])||v||"";
      const cjExp=(translations.conjug&&translations.conjug[cjUsed])||"";
      let combined=roVerb||"";
      if(cjExp)combined+=` (${cjExp})`;
      roSegs.push(`${labelsRo.verb}: ${combined}`);
    }
  }

  return{
    ko:koParts.join(" "),
    roText:roSegs.join(" / "),
    time:t,
    conj:cjUsed
  };
}

/* NATURALITATE simplƒÉ (timp vs timp verbal) */
function analyzeNaturalnessP1(){
  const t=stateP1.time;
  const cj=stateP1.conjug;
  if(!t||!cj)return{ok:true,msg:"",suggestion:null};
  const tType=timePastWords.has(t)?"past":
              timeFutureWords.has(t)?"future":"neutral";
  const cType=conjugationType(cj);
  if(tType==="past"&&cType==="future"){
    const suggested="-ÏïòÏñ¥Ïöî/ÏóàÏñ¥Ïöî";
    const sent=buildClauseSentence(stateP1,activeP1,suggested);
    return{
      ok:false,
      msg:`‚Äû${t}‚Äù (trecut) cu final viitor ‚Äû${cj}‚Äù nu se prea folose»ôte. Exemplu mai natural:`,
      suggestion:sent.ko
    };
  }
  if(tType==="future"&&cType==="past"){
    const suggested="-(Ïúº)„Ñπ Í±∞ÏòàÏöî";
    const sent=buildClauseSentence(stateP1,activeP1,suggested);
    return{
      ok:false,
      msg:`‚Äû${t}‚Äù (viitor) cu final de trecut ‚Äû${cj}‚Äù poate suna nenatural. Exemplu mai natural:`,
      suggestion:sent.ko
    };
  }
  return{ok:true,msg:"",suggestion:null};
}

let showRo=true;
function updatePreview(){
  const c1 = buildClauseSentence(stateP1,activeP1,null);
  let koText = c1.ko || "";

  if(enableP2.checked && stateP1.conjug && isLinkingConj(stateP1.conjug)){
    const c2 = buildClauseSentence(stateP2,activeP2,null);
    if(c2.ko){
      koText += " " + c2.ko;
    }
  }

  if(!koText.trim()){
    previewKo.textContent="(alege cuvinte din tabel)";
    previewRo.textContent="";
    naturalHint.textContent="";
    return;
  }

  previewKo.textContent = koText;

  // ‚ûú aici folosim traducerea rom√¢neascƒÉ NATURALƒÇ
  const roNatural = buildNaturalRomanian(stateP1, activeP1);
  previewRo.textContent = showRo
    ? (roNatural || "(fƒÉrƒÉ traducere disponibilƒÉ √ÆncƒÉ)")
    : "¬∑¬∑¬∑ traducere ascunsƒÉ ¬∑¬∑¬∑";

  const nat = analyzeNaturalnessP1();
  if(nat.ok){
    naturalHint.textContent="‚úÖ Propozi»õie naturalƒÉ (dupƒÉ regulile simple din aplica»õie).";
  }else{
    naturalHint.textContent=`‚ö† ${nat.msg} „Äå${nat.suggestion}„Äç`;
  }
}

/* √ÆncƒÉrcare r√¢nd model »ôi navigare */
function loadRow(i){
  columns.forEach(col=>{
    stateP1[col.key]=col.data[i]||"";
  });
}
prevBtn.addEventListener("click",()=>{
  if(index>0){index--;loadRow(index);render();}
});
nextBtn.addEventListener("click",()=>{
  if(index<maxLen-1){index++;loadRow(index);render();}
});
resetBtn.addEventListener("click",()=>{
  [...togglesP1.querySelectorAll("input")].forEach(cb=>{cb.checked=true;activeP1[cb.dataset.key]=true;});
  [...togglesP2.querySelectorAll("input")].forEach(cb=>{cb.checked=true;activeP2[cb.dataset.key]=true;});
  render();
});
toggleRoBtn.addEventListener("click",()=>{
  showRo=!showRo;
  toggleRoBtn.textContent=showRo?"Ascunde traducerea":"AratƒÉ traducerea";
  updatePreview();
});

/* panel liste + adƒÉugare cuv√¢nt nou ‚Äì exact ca √Ænainte (nu schimb logicƒÉ) */
let panelClause="p1",panelKey="subject";
function renderPanelList(col){
  panelList.innerHTML="";
  const key=col.key;
  const map=translations[key]||{};
  const filter=(panelSearchInput.value||"").trim().toLowerCase();
  const words=col.data.filter(w=>{
    if(!w)return false;
    if(!filter)return true;
    return w.toLowerCase().startsWith(filter);
  });
  if(!words.length){
    const empty=document.createElement("div");
    empty.className="panel-item";
    empty.textContent="Nu existƒÉ cuvinte pentru filtrul introdus.";
    panelList.appendChild(empty);
    return;
  }
  words.forEach(word=>{
    const item=document.createElement("div");
    item.className="panel-item";
    const main=document.createElement("div");
    main.className="panel-item-main";
    main.textContent=word;
    item.appendChild(main);

    const extra=document.createElement("div");
    extra.className="panel-item-extra";
    const ro=map[word];
    if(ro){
      const tag=document.createElement("div");
      tag.className="panel-item-tag";
      tag.textContent=ro;
      extra.appendChild(tag);
    }
    if(key==="conjug"&&isLinkingConj(word)){
      const star=document.createElement("div");
      star.className="panel-item-tag";
      star.textContent="‚≠ê P2";
      extra.appendChild(star);
    }
    item.appendChild(extra);

    item.addEventListener("click",()=>{
      const target=panelClause==="p1"?stateP1:stateP2;
      target[key]=word;
      if(key==="conjug"&&isLinkingConj(word)){
        enableP2.checked=true;
        titleP2.classList.remove("hidden");
        tableP2.classList.remove("hidden");
      }
      overlay.classList.add("hidden");
      render();
    });

    panelList.appendChild(item);
  });
}
function openPanel(clause,key){
  panelClause=clause;panelKey=key;
  const col=columns.find(c=>c.key===key);if(!col)return;
  panelTitle.textContent=(clause==="p1"?"Propozi»õia 1 ‚Äì ":"Propozi»õia 2 ‚Äì ")+col.title;
  panelSub.textContent=col.hint||"";
  panelSearchInput.value="";newWordInput.value="";newWordTransInput.value="";
  renderPanelList(col);
  overlay.classList.remove("hidden");
  panelSearchInput.focus();
}
closePanelBtn.addEventListener("click",()=>overlay.classList.add("hidden"));
overlay.addEventListener("click",e=>{if(e.target===overlay)overlay.classList.add("hidden");});
panelSearchInput.addEventListener("input",()=>{
  const col=columns.find(c=>c.key===panelKey);
  if(col)renderPanelList(col);
});
addWordBtn.addEventListener("click",()=>{
  const txt=newWordInput.value.trim();
  if(!txt)return;
  const roTxt=(newWordTransInput.value||"").trim();
  const col=columns.find(c=>c.key===panelKey);
  if(!col||!col.allowCustom)return;

  if(!col.data.includes(txt))col.data.push(txt);
  if(!translations[panelKey])translations[panelKey]={};
  if(roTxt)translations[panelKey][txt]=roTxt;

  if(!customData[panelKey])customData[panelKey]=[];
  const exists=customData[panelKey].some(e=>e.word===txt);
  if(!exists)customData[panelKey].push({word:txt,ro:roTxt});
  else customData[panelKey].forEach(e=>{if(e.word===txt)e.ro=roTxt;});
  saveCustomData();

  newWordInput.value="";newWordTransInput.value="";
  renderPanelList(col);
});

/* click scurt = urmƒÉtorul cuv√¢nt; long press = panel */
function cycleColumnValue(clause,key){
  const col=columns.find(c=>c.key===key);if(!col)return;
  const arr=col.data;
  const state=clause==="p1"?stateP1:stateP2;
  const cur=state[key];
  let idx=arr.indexOf(cur);
  if(idx===-1)idx=0;
  let nextIdx=(idx+1)%arr.length;
  state[key]=arr[nextIdx]||"";
  render();
}
let longPressTimer=null,pressTarget=null;
function attachPressHandlers(tableEl){
  tableEl.addEventListener("pointerdown",e=>{
    const colDiv=e.target.closest(".col");if(!colDiv)return;
    e.preventDefault();
    pressTarget=colDiv;
    longPressTimer=setTimeout(()=>{
      if(pressTarget===colDiv){
        openPanel(colDiv.dataset.clause||"p1",colDiv.dataset.key);
        pressTarget=null;
      }
    },450);
  });
  tableEl.addEventListener("pointerup",e=>{
    const colDiv=e.target.closest(".col");
    if(longPressTimer){clearTimeout(longPressTimer);longPressTimer=null;}
    if(pressTarget&&colDiv===pressTarget){
      cycleColumnValue(colDiv.dataset.clause||"p1",colDiv.dataset.key);
    }
    pressTarget=null;
  });
  tableEl.addEventListener("pointerleave",()=>{
    if(longPressTimer){clearTimeout(longPressTimer);longPressTimer=null;}
    pressTarget=null;
  });
}
attachPressHandlers(tableP1);
attachPressHandlers(tableP2);

/* random, audio, favorite ‚Äì ca √Ænainte */
randomBtn.addEventListener("click",()=>{
  columns.forEach(col=>{
    if(!activeP1[col.key]||!isColumnVisible(col.key))return;
    const arr=col.data.filter(x=>x!==""&&x!=null);
    if(!arr.length)return;
    stateP1[col.key]=arr[Math.floor(Math.random()*arr.length)];
  });
  render();
});
speakBtn.addEventListener("click",()=>{
  if(!("speechSynthesis"in window)){alert("Browserul nu suportƒÉ audio.");return;}
  const text=previewKo.textContent;
  if(!text||text.includes("alege cuvinte"))return;
  const u=new SpeechSynthesisUtterance(text);
  u.lang="ko-KR";
  const vs=window.speechSynthesis.getVoices();
  const koV=vs.find(v=>v.lang&&v.lang.toLowerCase().startsWith("ko"));
  if(koV)u.voice=koV;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
});
const favorites=[];
const favoritesListEl=document.getElementById("favoritesList");
function renderFavorites(){
  if(!favoritesListEl)return;
  favoritesListEl.innerHTML="";
  if(!favorites.length){
    const div=document.createElement("div");
    div.className="small-label";
    div.textContent="Nu ai salvat √ÆncƒÉ nicio propozi»õie.";
    favoritesListEl.appendChild(div);
    return;
  }
  favorites.forEach(f=>{
    const item=document.createElement("div");
    item.className="fav-item";
    const ko=document.createElement("div");
    ko.className="fav-ko";
    ko.textContent=f.ko;
    const ro=document.createElement("div");
    ro.className="fav-ro";
    ro.textContent=f.ro;
    item.appendChild(ko);item.appendChild(ro);
    favoritesListEl.appendChild(item);
  });
}
favBtn.addEventListener("click",()=>{
  const ko=previewKo.textContent.trim();
  let ro=previewRo.textContent.trim();
  if(!ko||ko.includes("alege cuvinte"))return;
  if(ro.startsWith("¬∑¬∑¬∑"))ro="";
  const exists=favorites.some(f=>f.ko===ko&&f.ro===ro);
  if(!exists)favorites.push({ko,ro});
  renderFavorites();
  favBtn.textContent="‚≠ê Salvat!";
  setTimeout(()=>{favBtn.textContent="‚≠ê SalveazƒÉ propozi»õia";},800);
});
/* ================== EXERCI»öII TOPIK ‚Äì modul nou ================== */

// Elemente din HTML pentru exerci»õii
const exerciseTypeEl = document.getElementById("exerciseType");
const exerciseQuestionEl = document.getElementById("exerciseQuestion");
const exerciseOptionsEl = document.getElementById("exerciseOptions");
const exerciseFeedbackEl = document.getElementById("exerciseFeedback");
const checkAnswerBtn = document.getElementById("checkAnswerBtn");
const nextQuestionBtn = document.getElementById("nextQuestionBtn");

let currentExercise = null;

// helper random
function randItem(arr){
  return arr[Math.floor(Math.random()*arr.length)];
}

// Construim o propozi»õie coreeanƒÉ simplƒÉ pentru exerci»õii (fƒÉrƒÉ particule complicate)
function buildSimpleKoreanSentence(parts){
  const out = [];
  if(parts.time) out.push(parts.time);
  if(parts.subject) out.push(parts.subject);
  if(parts.place) out.push(parts.place);
  if(parts.mod) out.push(parts.mod);
  if(parts.object) out.push(parts.object);
  if(parts.verb) out.push(parts.verb);
  return out.join(" ");
}

// 1) Exerci»õiu: Alege VERBUL corect
function makeVerbExercise(){
  const subj = randItem(subjects);
  const t = randItem(times);
  const place = randItem(places);
  const obj = randItem(objects);
  const correctVerb = randItem(verbs);

  const sentenceKorean = buildSimpleKoreanSentence({
    time: t,
    subject: subj,
    place: place,
    object: obj,
    verb: "___"
  });

  // op»õiuni (4 verbe, 1 corect)
  const options = new Set();
  options.add(correctVerb);
  while(options.size < 4){
    options.add(randItem(verbs));
  }
  const optionsArr = Array.from(options).sort(() => Math.random()-0.5);

  currentExercise = {
    type: "verb",
    correct: correctVerb,
    options: optionsArr
  };

  exerciseQuestionEl.textContent = `Alege verbul corect pentru propozi»õia:  ${sentenceKorean}`;
  renderExerciseOptions(optionsArr);
  exerciseFeedbackEl.textContent = "";
}

// 2) Exerci»õiu: Alege PARTICULA corectƒÉ ‚Äì simplificat
// De ex: Ïò§Îäò ___ ÏπúÍµ¨Î•º ÎßåÎÇòÏöî.
// rƒÉspuns posibil: Ïóê, ÏóêÏÑú, ÏùÑ/Î•º etc. (facem doar un exerci»õiu de recunoa»ôtere)
const simpleParticles = ["ÏùÄ/Îäî","Ïù¥/Í∞Ä","ÏùÑ/Î•º","Ïóê","ÏóêÏÑú"];

function makeParticleExercise(){
  const t = randItem(times);
  const subj = randItem(subjects);
  const obj = randItem(objects);
  const place = randItem(places);

  const correct = randItem(simpleParticles);

  const sentence =
    `${t} ___ ${subj} ___ ${place} ___ ${obj} ___ Í∞ÄÏöî.`;

  const options = new Set();
  options.add(correct);
  while(options.size < 4){
    options.add(randItem(simpleParticles));
  }
  const optionsArr = Array.from(options).sort(() => Math.random()-0.5);

  currentExercise = {
    type: "particle",
    correct,
    options: optionsArr
  };

  exerciseQuestionEl.textContent = `Alege particula potrivitƒÉ (simplu):  ${sentence}`;
  renderExerciseOptions(optionsArr);
  exerciseFeedbackEl.textContent = "";
}

// 3) Exerci»õiu: Alege CONJUGAREA corectƒÉ
function makeConjugExercise(){
  const verb = randItem(verbs);
  const cj = randItem(conjugations);

  const baseSentence = `${verb} (___)`;
  const options = new Set();
  options.add(cj);
  while(options.size < 4){
    options.add(randItem(conjugations));
  }
  const optionsArr = Array.from(options).sort(() => Math.random()-0.5);

  currentExercise = {
    type: "conjug",
    correct: cj,
    verb,
    options: optionsArr
  };

  exerciseQuestionEl.textContent =
    `Alege forma corectƒÉ pentru verbul:  ${verb}  (forma politicosƒÉ / gramaticalƒÉ potrivitƒÉ)`;
  renderExerciseOptions(optionsArr);
  exerciseFeedbackEl.textContent = "";
}

// RENDER op»õiuni √Æn UI
function renderExerciseOptions(optionsArr){
  exerciseOptionsEl.innerHTML = "";
  optionsArr.forEach((opt, idx)=>{
    const id = "opt_"+idx+"_"+Date.now();
    const label = document.createElement("label");
    label.style.display = "flex";
    label.style.alignItems = "center";
    label.style.gap = "6px";
    const radio = document.createElement("input");
    radio.type = "radio";
    radio.name = "exerciseOption";
    radio.value = opt;
    radio.id = id;

    const span = document.createElement("span");
    span.textContent = opt;

    label.appendChild(radio);
    label.appendChild(span);
    exerciseOptionsEl.appendChild(label);
  });
}

// Generator √Æntrebare nouƒÉ
function newExerciseQuestion(){
  const type = exerciseTypeEl ? exerciseTypeEl.value : "verb";

  if(type === "verb"){
    makeVerbExercise();
  }else if(type === "particle"){
    makeParticleExercise();
  }else if(type === "conjug" || type === "conjugation"){
    makeConjugExercise();
  }else{
    // fallback: verb
    makeVerbExercise();
  }
}

// Verificare rƒÉspuns
function checkExerciseAnswer(){
  if(!currentExercise){
    exerciseFeedbackEl.textContent = "Mai √Ænt√¢i apasƒÉ ‚Äû√éntrebare nouƒÉ‚Äù.";
    return;
  }
  const chosen = Array.from(
    exerciseOptionsEl.querySelectorAll("input[name='exerciseOption']")
  ).find(x=>x.checked);

  if(!chosen){
    exerciseFeedbackEl.textContent = "Te rog sƒÉ alegi un rƒÉspuns.";
    return;
  }

  const val = chosen.value;
  const correct = currentExercise.correct;

  if(val === correct){
    exerciseFeedbackEl.textContent = "‚úÖ Corect! Bravo!";
  }else{
    exerciseFeedbackEl.textContent = `‚ùå Gre»ôit. RƒÉspunsul corect era: ${correct}`;
  }
}

// LegƒÉm butoanele
if(nextQuestionBtn){
  nextQuestionBtn.addEventListener("click", newExerciseQuestion);
}
if(checkAnswerBtn){
  checkAnswerBtn.addEventListener("click", checkExerciseAnswer);
}

// La √Ænceput: mesaj neutru
if(exerciseQuestionEl){
  exerciseQuestionEl.textContent = "ApasƒÉ ‚Äû√éntrebare nouƒÉ‚Äù ca sƒÉ √Æncepi exerci»õiile.";
}
    
/* glosar simplu (nu schimb) */
const glossarySearch=document.getElementById("glossarySearch");
const glossaryList=document.getElementById("glossaryList");
function addGlossaryFrom(list,catKey,catLabel){
  const map=translations[catKey]||{};
  list.forEach(w=>{
    if(!w)return;
    const ro=map[w]||"(fƒÉrƒÉ traducere √ÆncƒÉ)";
    glossaryEntries.push({ko:w,ro,category:catLabel});
  });
}
addGlossaryFrom(subjects,"subject","SUBJECT");
addGlossaryFrom(times,"time","TIME");
addGlossaryFrom(places,"place","PLACE");
addGlossaryFrom(mods,"mod","MOD");
addGlossaryFrom(objects,"object","OBJECT");
addGlossaryFrom(counters,"counter","COUNTER");
addGlossaryFrom(verbs,"verb","VERB");
addGlossaryFrom(conjugations,"conjug","CONJUGƒÇRI");

function renderGlossary(filter){
  if(!glossaryList)return;
  filter=(filter||"").toLowerCase();
  glossaryList.innerHTML="";
  const filtered=glossaryEntries.filter(e=>{
    if(!filter)return true;
    return e.ko.toLowerCase().includes(filter)||e.ro.toLowerCase().includes(filter);
  });
  if(!filtered.length){
    const div=document.createElement("div");
    div.className="small-label";
    div.textContent="Nu s-a gƒÉsit nimic pentru cƒÉutarea introdusƒÉ.";
    glossaryList.appendChild(div);
    return;
  }
  filtered.forEach(e=>{
    const item=document.createElement("div");
    item.className="glossary-item";
    const left=document.createElement("div");
    const ko=document.createElement("div");
    ko.className="glossary-ko";ko.textContent=e.ko;
    const ro=document.createElement("div");
    ro.className="glossary-ro";ro.textContent=e.ro;
    left.appendChild(ko);left.appendChild(ro);
    const cat=document.createElement("div");
    cat.className="glossary-cat";cat.textContent=e.category;
    item.appendChild(left);item.appendChild(cat);
    glossaryList.appendChild(item);
  });
}
if(glossarySearch)glossarySearch.addEventListener("input",()=>renderGlossary(glossarySearch.value));

/* ini»õializare */
function render(){
  renderClauseRow(tableP1,activeP1,stateP1,"p1");
  if(enableP2.checked)renderClauseRow(tableP2,activeP2,stateP2,"p2");
  pageInfoEl.textContent=`R√¢nd model: ${index+1} / ${maxLen}`;
  prevBtn.disabled=index===0;
  nextBtn.disabled=index===maxLen-1;
  updatePreview();
}
loadRow(index);
setScreen("builder");
render();
</script>
</body>
</html> 
