<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Raluca Korean â€“ Study App v1.3</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f7f3ff;
      --card-bg: #ffffff;
      --accent: #c9b5ff;
      --accent-strong: #9b7cff;
      --text-main: #333333;
      --text-soft: #666666;
      --border: #e0d7ff;
      --dimmed-bg: #f2eefc;
      --overlay-bg: rgba(0, 0, 0, 0.2);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#fdfbff,#f4f0ff);
      color:var(--text-main);display:flex;flex-direction:column;min-height:100vh;
    }
    .app{
      max-width:1000px;margin:0 auto;padding:10px 10px 60px;
      display:flex;flex-direction:column;gap:10px;min-height:100vh;
    }
    header{text-align:center;padding:4px 8px 4px;}
    header h1{font-size:18px;margin:2px 0;font-weight:700;color:var(--accent-strong);}
    header p{margin:0;font-size:11px;color:var(--text-soft);}

    .screen{display:none;flex-direction:column;gap:10px;flex:1;min-height:0;}
    .screen.active{display:flex;}

    .mode-panel{
      background:var(--card-bg);border-radius:12px;border:1px solid var(--border);
      padding:6px 8px;font-size:11px;display:flex;flex-direction:column;gap:4px;
      box-shadow:0 4px 12px rgba(120,96,190,0.08);
    }
    .mode-row{
      display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between;
    }
    .mode-row label{font-size:11px;display:flex;align-items:center;gap:4px;}
    .part-toggles{display:flex;flex-wrap:wrap;gap:6px;}
    .chip{
      display:inline-flex;align-items:center;gap:3px;
      padding:3px 8px;border-radius:999px;background:#ede7ff;color:var(--accent-strong);
      font-size:10px;cursor:pointer;
    }
    .chip input{margin:0;}
    .section-label{font-size:11px;font-weight:600;color:var(--accent-strong);margin-top:2px;}

    .small-mode-btn{
      padding:3px 8px;
      font-size:10px;
    }
    .small-mode-btn.active{
      background:var(--accent-strong);
      color:#fff;
    }

    .table-block{
      background:var(--card-bg);border-radius:14px;padding:8px;
      box-shadow:0 6px 16px rgba(120,96,190,0.12);border:1px solid var(--border);
      display:flex;flex-direction:column;gap:6px;flex:1;min-height:0;
    }
    .table-title{
      font-size:11px;font-weight:600;color:var(--text-soft);
      display:flex;justify-content:space-between;align-items:center;
    }
    .table-horizontal{
      display:flex;flex-direction:row;overflow-x:auto;padding-bottom:4px;gap:6px;
    }
    .col{
      min-width:110px;max-width:140px;flex:0 0 auto;background:#faf8ff;border-radius:10px;
      border:1px solid var(--border);display:flex;flex-direction:column;
      padding:6px 6px 8px;transition:0.2s;cursor:pointer;
      touch-action:manipulation;
    }
    .col-header{
      font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;
      color:var(--accent-strong);margin-bottom:4px;border-bottom:1px solid var(--border);
      padding-bottom:3px;
    }
    .col-body-label{font-size:10px;color:var(--text-soft);margin-bottom:2px;}
    .col-body-main{font-size:15px;font-weight:600;margin-bottom:2px;}
    .col-body-extra{font-size:11px;color:var(--text-soft);}
    .dimmed{
      opacity:0.35;background-image:repeating-linear-gradient(
        -45deg,var(--dimmed-bg),var(--dimmed-bg) 4px,#fdfbff 4px,#fdfbff 8px
      );
    }

    .controls{
      display:flex;justify-content:space-between;align-items:center;gap:8px;
      padding-top:4px;border-top:1px dashed var(--border);
    }
    .btn-group{display:flex;gap:6px;}
    button{
      border-radius:999px;border:none;padding:6px 10px;font-size:12px;font-weight:600;
      cursor:pointer;background:var(--accent);color:#fff;display:inline-flex;
      align-items:center;gap:4px;box-shadow:0 2px 6px rgba(90,70,160,0.25);
    }
    button.secondary{background:#ede7ff;color:var(--accent-strong);box-shadow:none;}
    button:disabled{opacity:0.4;box-shadow:none;cursor:default;}
    .page-indicator{font-size:11px;color:var(--text-soft);}
    .legend{font-size:10px;color:var(--text-soft);text-align:center;padding:2px 4px 0;}
    .hidden{display:none !important;}

    .preview-card{
      margin-top:6px;padding:8px;border-radius:12px;
      background:#f9f7ff;border:1px solid var(--border);
      display:flex;flex-direction:column;gap:4px;
    }
    .preview-title{
      font-size:11px;font-weight:600;color:var(--accent-strong);
      display:flex;justify-content:space-between;align-items:center;
    }
    .preview-ko{
      font-size:14px;font-weight:600;margin-top:2px;
    }
    .preview-ro{
      font-size:12px;color:var(--text-soft);
    }
    .preview-buttons{
      display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;
    }

    .overlay{
      position:fixed;inset:0;background:var(--overlay-bg);
      display:flex;justify-content:center;align-items:flex-end;z-index:1000;
    }
    .panel{
      width:100%;max-width:900px;background:var(--card-bg);
      border-radius:18px 18px 0 0;box-shadow:0 -6px 18px rgba(0,0,0,0.15);
      padding:10px 12px 14px;animation:slideUp 0.18s ease-out;
    }
    @keyframes slideUp{
      from{transform:translateY(40px);opacity:0;}
      to{transform:translateY(0);opacity:1;}
    }
    .panel-header{
      display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;
    }
    .panel-title{font-size:13px;font-weight:600;color:var(--accent-strong);}
    .panel-sub{font-size:11px;color:var(--text-soft);}
    .panel-close{
      background:transparent;color:var(--text-soft);box-shadow:none;
      padding:4px 6px;font-size:14px;
    }
    .panel-input-row{display:flex;gap:6px;margin-bottom:6px;}
    .panel-input-row input{
      flex:1;border-radius:999px;border:1px solid var(--border);
      padding:6px 10px;font-size:12px;
    }
    .panel-list{
      max-height:260px;overflow-y:auto;border-radius:10px;
      border:1px solid var(--border);background:#faf8ff;padding:4px;
    }
    .panel-item{
      padding:4px 8px;border-radius:8px;display:flex;justify-content:space-between;
      align-items:center;font-size:13px;cursor:pointer;
    }
    .panel-item:hover{background:#ede7ff;}
    .panel-item-main{font-weight:600;}
    .panel-item-extra{
      display:flex;flex-direction:column;align-items:flex-end;gap:2px;
    }
    .panel-item-tag{font-size:10px;color:var(--accent-strong);}

    .bottom-nav{
      position:fixed;bottom:0;left:0;right:0;
      background:#ffffffee;border-top:1px solid var(--border);
      display:flex;justify-content:space-around;align-items:center;
      padding:6px 0;backdrop-filter:blur(8px);z-index:500;
    }
    .nav-btn{
      flex:1;text-align:center;border:none;background:transparent;
      font-size:11px;color:var(--text-soft);padding:4px 0;cursor:pointer;
      display:flex;flex-direction:column;align-items:center;gap:2px;
    }
    .nav-btn span.icon{font-size:18px;}
    .nav-btn.active{color:var(--accent-strong);font-weight:600;}
    .nav-btn.active span.icon{transform:translateY(-1px);}
    @media (max-width:600px){
      header h1{font-size:16px;}
      .col{min-width:95px;}
    }

    .card{
      background:var(--card-bg);border-radius:14px;padding:10px;
      box-shadow:0 4px 12px rgba(120,96,190,0.12);border:1px solid var(--border);
      display:flex;flex-direction:column;gap:6px;
    }
    .card h2{
      margin:0;font-size:14px;color:var(--accent-strong);
    }
    .small-label{font-size:11px;color:var(--text-soft);}
    select{
      border-radius:999px;border:1px solid var(--border);
      padding:4px 10px;font-size:12px;background:#fff;
    }
    .exercise-question{
      font-size:14px;font-weight:600;margin-top:4px;
    }
    .exercise-options{display:flex;flex-direction:column;gap:4px;margin-top:2px;}
    .exercise-options label{
      font-size:13px;display:flex;align-items:center;gap:6px;
    }
    .exercise-feedback{
      font-size:12px;margin-top:4px;
    }

    .glossary-search{
      display:flex;gap:6px;align-items:center;margin-top:4px;
    }
    .glossary-search input{
      flex:1;border-radius:999px;border:1px solid var(--border);
      padding:6px 10px;font-size:12px;
    }
    .glossary-list{
      margin-top:6px;max-height:260px;overflow-y:auto;padding-right:2px;
    }
    .glossary-item{
      padding:6px 8px;border-radius:10px;border:1px solid var(--border);
      background:#faf8ff;margin-bottom:4px;font-size:12px;
      display:flex;justify-content:space-between;gap:8px;
    }
    .glossary-ko{font-weight:600;}
    .glossary-ro{color:var(--text-soft);}
    .glossary-cat{font-size:10px;color:var(--accent-strong);}

    .fav-list{
      margin-top:4px;max-height:140px;overflow-y:auto;padding-right:2px;
    }
    .fav-item{
      padding:4px 6px;border-radius:8px;border:1px solid var(--border);
      background:#fdfbff;margin-bottom:4px;font-size:11px;
    }
    .fav-ko{font-weight:600;margin-bottom:2px;}
    .fav-ro{color:var(--text-soft);}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Raluca Korean â€“ Study App</h1>
      <p id="subtitle">Builder propoziÈ›ii + particule + audio</p>
    </header>

    <!-- SCREEN 1: BUILDER -->
    <div class="screen active" id="screen-builder">
      <div class="mode-panel">
        <div class="mode-row">
          <span class="section-label">Mod afiÈ™are</span>
          <div>
            <button class="secondary small-mode-btn" data-mode="simple">Simplu</button>
            <button class="secondary small-mode-btn active" data-mode="topik">TOPIK</button>
          </div>
        </div>
        <div class="mode-row">
          <span class="section-label">PropoziÈ›ia 1 â€“ ce pÄƒrÈ›i foloseÈ™te?</span>
          <div class="part-toggles" id="togglesP1"></div>
        </div>
        <div class="mode-row">
          <label>
            <input type="checkbox" id="enableP2" />
            ActiveazÄƒ PropoziÈ›ia 2 (fraza)
          </label>
          <div class="part-toggles" id="togglesP2"></div>
        </div>
      </div>

      <div class="table-block">
        <div class="table-title">
          <span>PropoziÈ›ia 1</span>
          <span class="page-indicator" id="pageInfo"></span>
        </div>
        <div class="table-horizontal" id="tableP1"></div>

        <div class="table-title hidden" id="titleP2">
          <span>PropoziÈ›ia 2 (continuare / frazÄƒ)</span>
        </div>
        <div class="table-horizontal hidden" id="tableP2"></div>

        <div class="controls">
          <div class="btn-group">
            <button id="prevBtn">â¬… Prev (rÃ¢nd model)</button>
            <button id="nextBtn">Next â¡</button>
          </div>
          <button class="secondary" id="resetBtn">Reset pÄƒrÈ›i de propoziÈ›ie</button>
        </div>
        <div class="legend">
          â¤ Tap scurt pe coloanÄƒ = treci la urmÄƒtorul cuvÃ¢nt.  
          â¤ Èšine apÄƒsat pe coloanÄƒ = deschizi lista completÄƒ (cu traduceri).  
          â¤ â­ la CONJUGÄ‚RI = gramaticÄƒ de legÄƒturÄƒ (cere propoziÈ›ia 2).  
          â¤ DacÄƒ debifezi o parte sus, dispare È™i din propoziÈ›ia de jos È™i din random.
        </div>

        <div class="preview-card">
          <div class="preview-title">
            <span>PropoziÈ›ia / fraza (coreeanÄƒ, cu particule)</span>
          </div>
          <div class="preview-ko" id="previewKo">(alege cuvinte din tabel)</div>

          <div class="preview-title">
            <span>Traducere aproximativÄƒ (romÃ¢nÄƒ â€“ cuvinte)</span>
            <button id="toggleRoBtn" class="secondary" style="padding:3px 8px;font-size:10px;">
              Ascunde traducerea
            </button>
          </div>
          <div class="preview-ro" id="previewRo"></div>

          <div class="preview-buttons">
            <button id="randomBtn">ğŸ² Random propoziÈ›ie</button>
            <button id="speakBtn">ğŸ”Š Audio coreeanÄƒ</button>
            <button id="favBtn" class="secondary">â­ SalveazÄƒ propoziÈ›ia</button>
          </div>
        </div>
      </div>
    </div>

    <!-- SCREEN 2: EXERCIÈšII TOPIK -->
    <div class="screen" id="screen-exercises">
      <div class="card">
        <h2>ğŸ“ ExerciÈ›ii TOPIK â€“ propoziÈ›ii</h2>
        <div class="small-label">Alege tipul de exerciÈ›iu:</div>
        <select id="exerciseType">
          <option value="verb">Alege VERBUL corect</option>
          <option value="particle">Alege PARTICULA corectÄƒ (simplu)</option>
          <option value="particlePlus">Particule multiple (ì€/ëŠ”, ì´/ê°€, ì„/ë¥¼, ì—/ì—ì„œ)</option>
          <option value="conjug">Alege CONJUGAREA corectÄƒ</option>
        </select>

        <div class="exercise-question" id="exerciseQuestion">
          ApasÄƒ â€Ãntrebare nouÄƒâ€ ca sÄƒ Ã®ncepi.
        </div>
        <div class="exercise-options" id="exerciseOptions"></div>

        <div class="btn-group">
          <button id="checkAnswerBtn">VerificÄƒ rÄƒspunsul</button>
          <button class="secondary" id="nextQuestionBtn">Ãntrebare nouÄƒ</button>
        </div>
        <div class="exercise-feedback" id="exerciseFeedback"></div>
      </div>
      <div class="legend">
        â¤ Pentru â€Particule multipleâ€ ai mai multe spaÈ›ii (1), (2), (3).  
        â¤ Toate trebuie corecte ca sÄƒ fie propoziÈ›ia corectÄƒ.
      </div>
    </div>

    <!-- SCREEN 3: GLOSAR + FAVORITE -->
    <div class="screen" id="screen-glossary">
      <div class="card">
        <h2>ğŸ“š Glosar coreeanâ€“romÃ¢n</h2>

        <div class="small-label">PropoziÈ›ii favorite:</div>
        <div id="favoritesList" class="fav-list"></div>

        <div class="small-label" style="margin-top:6px;">CautÄƒ Ã®n glosar (coreeanÄƒ sau romÃ¢nÄƒ):</div>
        <div class="glossary-search">
          <input type="text" id="glossarySearch" placeholder="ex: ê°€ë‹¤ sau a merge" />
        </div>
        <div class="glossary-list" id="glossaryList"></div>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <nav class="bottom-nav">
    <button class="nav-btn active" data-target="builder">
      <span class="icon">ğŸ—</span>
      <span>Builder</span>
    </button>
    <button class="nav-btn" data-target="exercises">
      <span class="icon">ğŸ“</span>
      <span>ExerciÈ›ii</span>
    </button>
    <button class="nav-btn" data-target="glossary">
      <span class="icon">ğŸ“š</span>
      <span>Glosar</span>
    </button>
  </nav>

  <!-- overlay panel -->
  <div class="overlay hidden" id="overlay">
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="panel-title" id="panelTitle"></div>
          <div class="panel-sub" id="panelSub"></div>
        </div>
        <button class="panel-close" id="closePanelBtn">âœ•</button>
      </div>

      <div class="panel-input-row">
        <input type="text" id="newWordInput" placeholder="CuvÃ¢nt nou (coreeanÄƒ sau numÄƒr)..." />
      </div>
      <div class="panel-input-row">
        <input type="text" id="newWordTransInput" placeholder="Traducere Ã®n romÃ¢nÄƒ (ex: unu, azi) â€“ opÈ›ional" />
        <button id="addWordBtn" class="secondary">+ Add</button>
      </div>

      <div class="panel-list" id="panelList"></div>
    </div>
  </div>

  <script>
    /* === LISTE DE CUVINTE === */
    const subjects = [
      "ì €","ë‚˜","ë„ˆ","ìš°ë¦¬","ë„ˆí¬","ì‚¬ëŒ","í•™ìƒ","ì„ ìƒë‹˜","ì§ì›","ì „ë¬¸ê°€","ì§€ì›ì","ê´€ë¦¬ì",
      "ë¶€ëª¨ë‹˜","ì•„ì´","ì–´ë¥¸","ì‹œë¯¼","ê³ ê°","ì˜ì‚¬","ê°„í˜¸ì‚¬","ì—°êµ¬ì","ê´€ê³„ì","ëŒ€í‘œ","íšŒì¥",
      "ì‚¬ìš©ì","ì°¸ê°€ì","ìš´ì „ì","ì£¼ë¯¼","í™˜ì"
    ];
    const times = [
      "ì˜¤ëŠ˜","ì–´ì œ","ë‚´ì¼","ì§€ê¸ˆ","ë°©ê¸ˆ","ì¡°ê¸ˆ í›„ì—","ê³§","ìµœê·¼ì—","ìš”ì¦˜","ë§ˆì¹¨ë‚´","ê²°êµ­",
      "ì´ì „ì—","ì´í›„ì—","ë‹¹ì‹œì—","í•œë™ì•ˆ","ê³„ì†","ê°€ë”","í•­ìƒ","ìì£¼","ì ì ","ì°¨ì¸°","ì¼ì°","ëŠ¦ê²Œ"
    ];
    const places = [
      "ì§‘","í•™êµ","íšŒì‚¬","ì‹ë‹¹","ì¹´í˜","ë„ì„œê´€","ë³‘ì›","ì‹œì¥","ë°±í™”ì ","ê³µí•­","ê¸°ì°¨ì—­",
      "ë²„ìŠ¤ì •ë¥˜ì¥","ì—°êµ¬ì†Œ","ê¸°ê´€","ì§€ì—­ì‚¬íšŒ","í™˜ê²½","ëŒ€ê¸°ì—…","íšŒì˜ì‹¤","ë²•ì›","ê²½ì°°ì„œ",
      "í•´ë³€","ì‚°","ê³µì›","ì€í–‰"
    ];
    const mods = [
      "ì˜","ì—´ì‹¬íˆ","ì¡°ìš©íˆ","ì²œì²œíˆ","ë¹¨ë¦¬","ì •ë§","ì•„ì£¼","ë„ˆë¬´","ë§ì´","ì¡°ê¸ˆ","ê°‘ìê¸°","ë¯¸ë¦¬",
      "ë²Œì¨","ì•„ê¹Œ","ë°©ê¸ˆ","ê¸ˆë°©","ê³§","í•­ìƒ","ìì£¼","ê°€ë”","ë“œë¬¼ê²Œ","ìƒë‹¹íˆ","ê½¤","ë„ëŒ€ì²´","ì ˆëŒ€ë¡œ",
      "ì ê·¹ì ìœ¼ë¡œ","ì¶©ë¶„íˆ","íŠ¹íˆ","ì˜¤íˆë ¤","ì ì ","ì°¨ì¸°","ê³„ì†"
    ];
    const objects = [
      "ì±…","ì»¤í”¼","ë¬¼","ìŒì‹","ì˜í™”","ê°€ë°©","ì „í™”","ì˜·","ìë£Œ","ë°ì´í„°","ê³„íš","ì¡°ê±´","ìƒí™©","ë¬¸ì œ",
      "í•´ê²°ì±…","ìš”ì•½","ë³´ê³ ì„œ","ë¬¸ì„œ","ì»´í“¨í„°","ë…¸íŠ¸ë¶","í¸ì§€","ì„ ë¬¼","ì˜ê²¬","ì •ë³´","ê´€ê³„","ê²°ê³¼",
      "ì›ì¸","ë°©ë²•","ì œí’ˆ","ì„œë¹„ìŠ¤","ì •ì±…","ë¬¸í™”"
    ];
    const numerals = new Array(60).fill("");
    const counters = [
      "ê°œ","ëª…","ê¶Œ","ì¥","ëŒ€","ë³‘","ì”","ë§ˆë¦¬","ë²ˆ","ì‚´","í‰","ì†¡ì´","ì¤„","ì ","ê±´","íšŒ","ê°€ì§€","ìª½"
    ];
    const verbs = [
      "ê°€ë‹¤","ì˜¤ë‹¤","ë¨¹ë‹¤","ë§ˆì‹œë‹¤","ë³´ë‹¤","ì½ë‹¤","ì“°ë‹¤","ë°°ìš°ë‹¤","ì‚¬ë‹¤","ì£¼ë‹¤","ë°›ë‹¤","ì¼í•˜ë‹¤",
      "ê³µë¶€í•˜ë‹¤","ìš”ë¦¬í•˜ë‹¤","ì²­ì†Œí•˜ë‹¤","ì¤€ë¹„í•˜ë‹¤","ë„ì™€ì£¼ë‹¤","ì‚¬ìš©í•˜ë‹¤","í•„ìš”í•˜ë‹¤","ì¢‹ì•„í•˜ë‹¤",
      "ì‹«ì–´í•˜ë‹¤","ê¸°ë‹¤ë¦¬ë‹¤","ì‰¬ë‹¤","ë§Œë‚˜ë‹¤","ê±·ë‹¤","ë‹¬ë¦¬ë‹¤","ì•‰ë‹¤","ì„œë‹¤","ê²°ì •í•˜ë‹¤","ì œì•ˆí•˜ë‹¤",
      "ì „ë‹¬í•˜ë‹¤","ìœ ì§€í•˜ë‹¤","ë°œìƒí•˜ë‹¤","ì¦ê°€í•˜ë‹¤","ê°ì†Œí•˜ë‹¤","ì¸ì •í•˜ë‹¤","ë¶„ì„í•˜ë‹¤","ê´€ì°°í•˜ë‹¤",
      "í•´ê²°í•˜ë‹¤","ì—°êµ¬í•˜ë‹¤","í˜‘ë ¥í•˜ë‹¤","ìš”ì²­í•˜ë‹¤","ì¶©ì¡±í•˜ë‹¤","ë¹„êµí•˜ë‹¤","ì„¤ëª…í•˜ë‹¤","ì˜ˆìƒí•˜ë‹¤"
    ];
    const conjugations = [
      "-ì•„ìš”/ì–´ìš”","-ì•˜ì–´ìš”/ì—ˆì–´ìš”","-ê³  ìˆì–´ìš”","-ê³  ì‹¶ì–´ìš”","-(ìœ¼)ì„¸ìš”","-(ìœ¼)ã„¹ ê±°ì˜ˆìš”",
      "-ì§€ ë§ˆì„¸ìš”","-ì•„/ì–´ ì£¼ì„¸ìš”","-ì•„/ì–´ì•¼ ë¼ìš”","-(ìœ¼)ã„¹ ìˆ˜ ìˆì–´ìš”","-(ìœ¼)ã„¹ ìˆ˜ ì—†ì–´ìš”",
      "-ë”ë¼ê³ ìš”","-ë„¤ìš”","-êµ°ìš”","-ê³  ë‚˜ì„œ","-ê¸° ì „ì—","-(ìœ¼)ë©´ì„œ","-(ìœ¼)ã„¹ì§€ë„ ëª°ë¼ìš”",
      "-(ìœ¼)ã„¹ê²Œìš”","-(ìœ¼)ã„¹ë˜ìš”?","-(ìœ¼)ã„¹ê¹Œìš”?","-ëŠ” ê²Œ ì–´ë•Œìš”?","-ëŠ” ì¤‘ì´ì—ìš”",
      "-ì•„/ì–´ë„ ë¼ìš”","-(ìœ¼)ë©´ ì•ˆ ë¼ìš”","-(ìœ¼)ë©°","-(ìœ¼)ë‚˜","-(ìœ¼)ë¯€ë¡œ","-(ìœ¼)ã„´/ëŠ” ë§Œí¼",
      "-(ìœ¼)ã„¹ìˆ˜ë¡","-(ìœ¼)ã„´/ëŠ”ë°ë„","-(ìœ¼)ã„¹ì§€ë¼ë„","-(ìœ¼)ã„´/ëŠ” ë°˜ë©´ì—","-ë„ë¡ í•˜ë‹¤",
      "-ê²Œ ë˜ë‹¤","-ì•„/ì–´ì§€ë‹¤","-ê¸° ë§ˆë ¨ì´ë‹¤","-ê¸°ì—","-ê¸¸ë˜","-ê³  ë§ë‹¤","-ê³ ì í•˜ë‹¤","-(ìœ¼)ã„¹ ë¿ì´ë‹¤"
    ];

    // glosar (lista globalÄƒ, o actualizÄƒm È™i la cuvinte noi)
    const glossaryEntries = [];

    const translations = {
      subject: {
        "ì €":"eu (formal)","ë‚˜":"eu (informal)","ë„ˆ":"tu","ìš°ë¦¬":"noi","ë„ˆí¬":"voi",
        "ì‚¬ëŒ":"persoanÄƒ","í•™ìƒ":"student/Äƒ","ì„ ìƒë‹˜":"profesor","ì§ì›":"angajat",
        "ë¶€ëª¨ë‹˜":"pÄƒrinÈ›i","ì•„ì´":"copil","ì–´ë¥¸":"adult","ê³ ê°":"client","ì˜ì‚¬":"medic",
        "ê°„í˜¸ì‚¬":"asistentÄƒ","ì—°êµ¬ì":"cercetÄƒtor","ëŒ€í‘œ":"reprezentant","í™˜ì":"pacient"
      },
      time: {
        "ì˜¤ëŠ˜":"astÄƒzi","ì–´ì œ":"ieri","ë‚´ì¼":"mÃ¢ine","ì§€ê¸ˆ":"acum","ë°©ê¸ˆ":"tocmai acum",
        "ì¡°ê¸ˆ í›„ì—":"puÈ›in mai tÃ¢rziu","ê³§":"Ã®n curÃ¢nd","ìµœê·¼ì—":"recent","ìš”ì¦˜":"Ã®n ultima vreme",
        "ë§ˆì¹¨ë‚´":"Ã®n cele din urmÄƒ","ê²°êµ­":"pÃ¢nÄƒ la urmÄƒ","ì´ì „ì—":"Ã®nainte","ì´í›„ì—":"dupÄƒ",
        "ë‹¹ì‹œì—":"atunci","í•œë™ì•ˆ":"o perioadÄƒ","ê³„ì†":"continuÄƒ","ê°€ë”":"din cÃ¢nd Ã®n cÃ¢nd",
        "í•­ìƒ":"Ã®ntotdeauna","ìì£¼":"des","ì ì ":"din ce Ã®n ce","ì°¨ì¸°":"treptat",
        "ì¼ì°":"devreme","ëŠ¦ê²Œ":"tÃ¢rziu"
      },
      place: {
        "ì§‘":"acasÄƒ","í•™êµ":"È™coalÄƒ","íšŒì‚¬":"firmÄƒ / companie","ì‹ë‹¹":"restaurant","ì¹´í˜":"cafenea",
        "ë„ì„œê´€":"bibliotecÄƒ","ë³‘ì›":"spital","ì‹œì¥":"piaÈ›Äƒ","ë°±í™”ì ":"magazin universal",
        "ê³µí•­":"aeroport","ê¸°ì°¨ì—­":"garÄƒ","ë²„ìŠ¤ì •ë¥˜ì¥":"staÈ›ie de autobuz","ì—°êµ¬ì†Œ":"laborator",
        "ê¸°ê´€":"instituÈ›ie","ì§€ì—­ì‚¬íšŒ":"comunitate","í™˜ê²½":"mediu","ëŒ€ê¸°ì—…":"corporaÈ›ie mare",
        "íšŒì˜ì‹¤":"salÄƒ de È™edinÈ›e","ë²•ì›":"instanÈ›Äƒ","ê²½ì°°ì„œ":"secÈ›ie de poliÈ›ie",
        "í•´ë³€":"plajÄƒ","ì‚°":"munte","ê³µì›":"parc","ì€í–‰":"bancÄƒ"
      },
      mod: {
        "ì˜":"bine","ì—´ì‹¬íˆ":"cu sÃ¢rguinÈ›Äƒ","ì¡°ìš©íˆ":"Ã®n liniÈ™te","ì²œì²œíˆ":"Ã®ncet",
        "ë¹¨ë¦¬":"repede","ì •ë§":"cu adevÄƒrat","ì•„ì£¼":"foarte","ë„ˆë¬´":"prea / foarte",
        "ë§ì´":"mult","ì¡°ê¸ˆ":"puÈ›in","ê°‘ìê¸°":"brusc","ë¯¸ë¦¬":"Ã®n avans","ë²Œì¨":"deja",
        "ì•„ê¹Œ":"mai devreme","ë°©ê¸ˆ":"chiar acum","ê¸ˆë°©":"imediat","ê³§":"Ã®n curÃ¢nd",
        "í•­ìƒ":"mereu","ìì£¼":"des","ê°€ë”":"din cÃ¢nd Ã®n cÃ¢nd","ë“œë¬¼ê²Œ":"rar",
        "ìƒë‹¹íˆ":"destul de","ê½¤":"biniÈ™or","ë„ëŒ€ì²´":"(deloc / Ã®n Ã®ntrebÄƒri)",
        "ì ˆëŒ€ë¡œ":"niciodatÄƒ (interdicÈ›ie)","ì ê·¹ì ìœ¼ë¡œ":"activ","ì¶©ë¶„íˆ":"suficient",
        "íŠ¹íˆ":"Ã®n special","ì˜¤íˆë ¤":"mai degrabÄƒ","ì ì ":"din ce Ã®n ce","ì°¨ì¸°":"treptat",
        "ê³„ì†":"Ã®n mod continuu"
      },
      object: {
        "ì±…":"carte","ì»¤í”¼":"cafea","ë¬¼":"apÄƒ","ìŒì‹":"mÃ¢ncare","ì˜í™”":"film",
        "ê°€ë°©":"geantÄƒ","ì „í™”":"telefon","ì˜·":"haine","ìë£Œ":"materiale","ë°ì´í„°":"date",
        "ê³„íš":"plan","ì¡°ê±´":"condiÈ›ie","ìƒí™©":"situaÈ›ie","ë¬¸ì œ":"problemÄƒ",
        "í•´ê²°ì±…":"soluÈ›ie","ìš”ì•½":"rezumat","ë³´ê³ ì„œ":"raport","ë¬¸ì„œ":"document",
        "ì»´í“¨í„°":"calculator","ë…¸íŠ¸ë¶":"laptop","í¸ì§€":"scrisoare","ì„ ë¬¼":"cadou",
        "ì˜ê²¬":"opinie","ì •ë³´":"informaÈ›ie","ê´€ê³„":"relaÈ›ie","ê²°ê³¼":"rezultat",
        "ì›ì¸":"cauzÄƒ","ë°©ë²•":"metodÄƒ","ì œí’ˆ":"produs","ì„œë¹„ìŠ¤":"serviciu",
        "ì •ì±…":"politicÄƒ","ë¬¸í™”":"culturÄƒ"
      },
      numeral: {}, // aici vor intra È™i numerele noi + traducere
      counter: {
        "ê°œ":"bucatÄƒ","ëª…":"persoanÄƒ","ê¶Œ":"volum (carte)","ì¥":"foaie / paginÄƒ",
        "ëŒ€":"aparat / vehicul","ë³‘":"sticlÄƒ","ì”":"canÄƒ / pahar",
        "ë§ˆë¦¬":"animal","ë²ˆ":"datÄƒ","ì‚´":"ani (vÃ¢rstÄƒ)","ì†¡ì´":"buchet / ciorchine",
        "ì¤„":"rÃ¢nd / È™ir","ì ":"punct","ê±´":"caz","íšŒ":"datÄƒ (ocazie)",
        "ê°€ì§€":"fel / tip","ìª½":"paginÄƒ / direcÈ›ie"
      },
      verb: {
        "ê°€ë‹¤":"a merge","ì˜¤ë‹¤":"a veni","ë¨¹ë‹¤":"a mÃ¢nca","ë§ˆì‹œë‹¤":"a bea","ë³´ë‹¤":"a vedea / a se uita",
        "ì½ë‹¤":"a citi","ì“°ë‹¤":"a scrie","ë°°ìš°ë‹¤":"a Ã®nvÄƒÈ›a","ì‚¬ë‹¤":"a cumpÄƒra","ì£¼ë‹¤":"a da",
        "ë°›ë‹¤":"a primi","ì¼í•˜ë‹¤":"a lucra","ê³µë¶€í•˜ë‹¤":"a studia","ìš”ë¦¬í•˜ë‹¤":"a gÄƒti",
        "ì²­ì†Œí•˜ë‹¤":"a face curat","ì¤€ë¹„í•˜ë‹¤":"a pregÄƒti","ë„ì™€ì£¼ë‹¤":"a ajuta",
        "ì‚¬ìš©í•˜ë‹¤":"a folosi","í•„ìš”í•˜ë‹¤":"a fi necesar","ì¢‹ì•„í•˜ë‹¤":"a plÄƒcea",
        "ì‹«ì–´í•˜ë‹¤":"a nu plÄƒcea / a urÃ®","ê¸°ë‹¤ë¦¬ë‹¤":"a aÈ™tepta","ì‰¬ë‹¤":"a se odihni",
        "ë§Œë‚˜ë‹¤":"a se Ã®ntÃ¢lni","ê±·ë‹¤":"a merge pe jos","ë‹¬ë¦¬ë‹¤":"a alerga",
        "ì•‰ë‹¤":"a se aÈ™eza","ì„œë‹¤":"a sta Ã®n picioare","ê²°ì •í•˜ë‹¤":"a decide",
        "ì œì•ˆí•˜ë‹¤":"a propune","ì „ë‹¬í•˜ë‹¤":"a transmite","ìœ ì§€í•˜ë‹¤":"a menÈ›ine",
        "ë°œìƒí•˜ë‹¤":"a se produce","ì¦ê°€í•˜ë‹¤":"a creÈ™te","ê°ì†Œí•˜ë‹¤":"a scÄƒdea",
        "ì¸ì •í•˜ë‹¤":"a recunoaÈ™te","ë¶„ì„í•˜ë‹¤":"a analiza","ê´€ì°°í•˜ë‹¤":"a observa",
        "í•´ê²°í•˜ë‹¤":"a rezolva","ì—°êµ¬í•˜ë‹¤":"a cerceta","í˜‘ë ¥í•˜ë‹¤":"a colabora",
        "ìš”ì²­í•˜ë‹¤":"a solicita","ì¶©ì¡±í•˜ë‹¤":"a satisface","ë¹„êµí•˜ë‹¤":"a compara",
        "ì„¤ëª…í•˜ë‹¤":"a explica","ì˜ˆìƒí•˜ë‹¤":"a anticipa"
      },
      conjug: {
        "-ì•„ìš”/ì–´ìš”":"prezent politicos",
        "-ì•˜ì–´ìš”/ì—ˆì–´ìš”":"trecut politicos",
        "-ê³  ìˆì–´ìš”":"(sunt) Ã®n curs de a face",
        "-ê³  ì‹¶ì–´ìš”":"vreau sÄƒ...",
        "-(ìœ¼)ì„¸ìš”":"imperativ / onorific",
        "-(ìœ¼)ã„¹ ê±°ì˜ˆìš”":"viitor",
        "-ì§€ ë§ˆì„¸ìš”":"nu faceÈ›i..., vÄƒ rog",
        "-ì•„/ì–´ ì£¼ì„¸ìš”":"vÄƒ rog sÄƒ...",
        "-ì•„/ì–´ì•¼ ë¼ìš”":"trebuie sÄƒ...",
        "-(ìœ¼)ã„¹ ìˆ˜ ìˆì–´ìš”":"pot sÄƒ...",
        "-(ìœ¼)ã„¹ ìˆ˜ ì—†ì–´ìš”":"nu pot sÄƒ...",
        "-ë”ë¼ê³ ìš”":"chiar am observat cÄƒ...",
        "-ë„¤ìš”":"exclamativ (observaÈ›ie)",
        "-êµ°ìš”":"exclamativ (constatare)",
        "-ê³  ë‚˜ì„œ":"dupÄƒ ce...",
        "-ê¸° ì „ì—":"Ã®nainte sÄƒ...",
        "-(ìœ¼)ë©´ì„œ":"Ã®n timp ce...",
        "-(ìœ¼)ã„¹ì§€ë„ ëª°ë¼ìš”":"s-ar putea sÄƒ...",
        "-(ìœ¼)ã„¹ê²Œìš”":"voi face pentru tine",
        "-(ìœ¼)ã„¹ë˜ìš”?":"ai chef sÄƒ...?/vreau sÄƒ...",
        "-(ìœ¼)ã„¹ê¹Œìš”?":"sÄƒ facem...?",
        "-ëŠ” ê²Œ ì–´ë•Œìš”?":"ce-ar fi sÄƒ...?",
        "-ëŠ” ì¤‘ì´ì—ìš”":"sunt Ã®n mijlocul acÈ›iunii",
        "-ì•„/ì–´ë„ ë¼ìš”":"poÈ›i sÄƒ..., e Ã®n regulÄƒ",
        "-(ìœ¼)ë©´ ì•ˆ ë¼ìš”":"nu ai voie sÄƒ...",
        "-(ìœ¼)ë©°":"È™i (Ã®n timp ce)",
        "-(ìœ¼)ë‚˜":"dar / Ã®nsÄƒ",
        "-(ìœ¼)ë¯€ë¡œ":"deoarece / fiindcÄƒ",
        "-(ìœ¼)ã„´/ëŠ” ë§Œí¼":"pe cÃ¢t..., atÃ¢t...",
        "-(ìœ¼)ã„¹ìˆ˜ë¡":"cu cÃ¢t..., cu atÃ¢t...",
        "-(ìœ¼)ã„´/ëŠ”ë°ë„":"deÈ™i...",
        "-(ìœ¼)ã„¹ì§€ë¼ë„":"chiar dacÄƒ...",
        "-(ìœ¼)ã„´/ëŠ” ë°˜ë©´ì—":"pe de altÄƒ parte",
        "-ë„ë¡ í•˜ë‹¤":"sÄƒ faci Ã®n aÈ™a fel Ã®ncÃ¢t sÄƒ...",
        "-ê²Œ ë˜ë‹¤":"ajungi sÄƒ..., devine cÄƒ...",
        "-ì•„/ì–´ì§€ë‹¤":"a deveni...",
        "-ê¸° ë§ˆë ¨ì´ë‹¤":"este firesc sÄƒ...",
        "-ê¸°ì—":"pentru cÄƒ..., fiindcÄƒ",
        "-ê¸¸ë˜":"pentru cÄƒ (am vÄƒzut / simÈ›it eu)",
        "-ê³  ë§ë‹¤":"Ã®n cele din urmÄƒ ajunge sÄƒ...",
        "-ê³ ì í•˜ë‹¤":"a intenÈ›iona sÄƒ...",
        "-(ìœ¼)ã„¹ ë¿ì´ë‹¤":"doar..., nimic altceva"
      }
    };

    const linkingConjugations = new Set([
      "-ê³  ë‚˜ì„œ","-ê¸° ì „ì—","-(ìœ¼)ë©´ì„œ","-(ìœ¼)ë©°","-(ìœ¼)ë‚˜","-(ìœ¼)ë¯€ë¡œ",
      "-(ìœ¼)ã„´/ëŠ” ë§Œí¼","-(ìœ¼)ã„¹ìˆ˜ë¡","-(ìœ¼)ã„´/ëŠ”ë°ë„","-(ìœ¼)ã„¹ì§€ë¼ë„",
      "-(ìœ¼)ã„´/ëŠ” ë°˜ë©´ì—","-ë„ë¡ í•˜ë‹¤","-ê¸°ì—","-ê¸¸ë˜","-ê³  ë§ë‹¤","-ê³ ì í•˜ë‹¤"
    ]);
    const isLinkingConj = v => linkingConjugations.has(v);

    const columns = [
      { key:"subject", title:"SUBJECT", ko:"ì£¼ì–´",   data:subjects,    hint:"Cine?",        allowCustom:true },
      { key:"time",    title:"TIME",    ko:"ì‹œê°„",   data:times,       hint:"CÃ¢nd?",        allowCustom:true },
      { key:"place",   title:"PLACE",   ko:"ì¥ì†Œ",   data:places,      hint:"Unde?",        allowCustom:true },
      { key:"mod",     title:"MOD",     ko:"ë°©ë²•",   data:mods,        hint:"Cum?",         allowCustom:true },
      { key:"object",  title:"OBJECT",  ko:"ëª©ì ì–´", data:objects,     hint:"Ce?",          allowCustom:true },
      { key:"numeral", title:"NUMERAL", ko:"",      data:numerals,    hint:"NumÄƒr",        allowCustom:true },
      { key:"counter", title:"COUNTER", ko:"ìˆ˜ëŸ‰ì‚¬", data:counters,    hint:"Clasificator", allowCustom:true },
      { key:"verb",    title:"VERB",    ko:"ë™ì‚¬",   data:verbs,       hint:"AcÈ›iune",      allowCustom:true },
      { key:"conjug",  title:"CONJUGÄ‚RI", ko:"",    data:conjugations,hint:"FormÄƒ (P1/P2)",allowCustom:true }
    ];
    const maxLen = Math.max(...columns.map(c => c.data.length));

    let index=0;
    const stateP1={}, stateP2={}, activeP1={}, activeP2={};
    columns.forEach(col=>{
      stateP1[col.key]=col.data[0]||"";
      stateP2[col.key]=col.data[0]||"";
      activeP1[col.key]=true;
      activeP2[col.key]=true;
    });

    // mode simplu vs TOPIK
    let currentMode = "topik";
    const simpleColumnsSet = {
      subject:true,
      time:true,
      object:true,
      verb:true,
      conjug:true
    };
    function isColumnVisible(key){
      return currentMode === "topik" || !!simpleColumnsSet[key];
    }

    const tableP1=document.getElementById("tableP1");
    const tableP2=document.getElementById("tableP2");
    const titleP2=document.getElementById("titleP2");
    const pageInfoEl=document.getElementById("pageInfo");
    const prevBtn=document.getElementById("prevBtn");
    const nextBtn=document.getElementById("nextBtn");
    const resetBtn=document.getElementById("resetBtn");
    const enableP2=document.getElementById("enableP2");
    const togglesP1=document.getElementById("togglesP1");
    const togglesP2=document.getElementById("togglesP2");

    const overlay=document.getElementById("overlay");
    const panelTitle=document.getElementById("panelTitle");
    const panelSub=document.getElementById("panelSub");
    const panelList=document.getElementById("panelList");
    const closePanelBtn=document.getElementById("closePanelBtn");
    const newWordInput=document.getElementById("newWordInput");
    const newWordTransInput=document.getElementById("newWordTransInput");
    const addWordBtn=document.getElementById("addWordBtn");

    const previewKo=document.getElementById("previewKo");
    const previewRo=document.getElementById("previewRo");
    const toggleRoBtn=document.getElementById("toggleRoBtn");
    const randomBtn=document.getElementById("randomBtn");
    const speakBtn=document.getElementById("speakBtn");
    const favBtn=document.getElementById("favBtn");

    const subtitleEl=document.getElementById("subtitle");

    const screens = {
      builder: document.getElementById("screen-builder"),
      exercises: document.getElementById("screen-exercises"),
      glossary: document.getElementById("screen-glossary")
    };
    const navButtons = document.querySelectorAll(".nav-btn");

    const modeButtons = document.querySelectorAll(".small-mode-btn");

    function setScreen(name){
      Object.entries(screens).forEach(([k,el])=>{
        el.classList.toggle("active", k===name);
      });
      navButtons.forEach(btn=>{
        btn.classList.toggle("active", btn.dataset.target===name);
      });
      if(name==="builder"){
        subtitleEl.textContent="Builder propoziÈ›ii + particule + audio";
      }else if(name==="exercises"){
        subtitleEl.textContent="ExerciÈ›ii TOPIK â€“ verb, particulÄƒ, conjugare";
      }else{
        subtitleEl.textContent="Glosar + propoziÈ›ii favorite";
        renderGlossary("");
        renderFavorites();
      }
    }
    navButtons.forEach(btn=>{
      btn.addEventListener("click",()=>setScreen(btn.dataset.target));
    });

    modeButtons.forEach(btn=>{
      btn.addEventListener("click",()=>{
        const mode = btn.dataset.mode;
        currentMode = mode;
        modeButtons.forEach(b=>b.classList.toggle("active", b===btn));
        render();
      });
    });

    /* funcÈ›ii particule */
    const hasBatchim = (syl) => {
      if(!syl) return false;
      const code = syl.charCodeAt(syl.length-1) - 0xAC00;
      if(code < 0 || code > 11171) return false;
      const jong = code % 28;
      return jong !== 0;
    };
    const pronouns = new Set(["ì €","ë‚˜","ë„ˆ","ìš°ë¦¬","ë„ˆí¬"]);
    function addSubjectWithParticle(word){
      if(!word) return "";
      const batchim = hasBatchim(word);
      if(pronouns.has(word)){
        return word + (batchim ? "ì€" : "ëŠ”");
      } else {
        return word + (batchim ? "ì´" : "ê°€");
      }
    }
    function addObjectWithParticle(word){
      if(!word) return "";
      const batchim = hasBatchim(word);
      return word + (batchim ? "ì„" : "ë¥¼");
    }
    const timeAdverbsNoParticle = new Set([
      "ì˜¤ëŠ˜","ì–´ì œ","ë‚´ì¼","ì§€ê¸ˆ","ë°©ê¸ˆ","ìš”ì¦˜","í•­ìƒ","ìì£¼","ê°€ë”","ê³„ì†","ì ì ","ì°¨ì¸°"
    ]);
    function addTimeWithParticle(word){
      if(!word) return "";
      if(timeAdverbsNoParticle.has(word)) return word;
      return word + "ì—";
    }
    function addPlaceWithParticle(word){
      if(!word) return "";
      return word + "ì—ì„œ";
    }

    function createToggleChips(){
      columns.forEach(col=>{
        const chip1=document.createElement("label");
        chip1.className="chip";
        const cb1=document.createElement("input");
        cb1.type="checkbox";cb1.checked=true;cb1.dataset.key=col.key;cb1.dataset.clause="p1";
        chip1.appendChild(cb1);chip1.append(col.title);togglesP1.appendChild(chip1);

        const chip2=document.createElement("label");
        chip2.className="chip";
        const cb2=document.createElement("input");
        cb2.type="checkbox";cb2.checked=true;cb2.dataset.key=col.key;cb2.dataset.clause="p2";
        chip2.appendChild(cb2);chip2.append(col.title);togglesP2.appendChild(chip2);
      });

      togglesP1.addEventListener("change",e=>{
        const cb=e.target;if(cb.tagName.toLowerCase()!=="input")return;
        activeP1[cb.dataset.key]=cb.checked;render();
      });
      togglesP2.addEventListener("change",e=>{
        const cb=e.target;if(cb.tagName.toLowerCase()!=="input")return;
        activeP2[cb.dataset.key]=cb.checked;render();
      });

      resetBtn.addEventListener("click",()=>{
        [...togglesP1.querySelectorAll("input")].forEach(cb=>{
          cb.checked=true;activeP1[cb.dataset.key]=true;
        });
        [...togglesP2.querySelectorAll("input")].forEach(cb=>{
          cb.checked=true;activeP2[cb.dataset.key]=true;
        });
        render();
      });

      enableP2.addEventListener("change",()=>{
        const on=enableP2.checked;
        if(on){titleP2.classList.remove("hidden");tableP2.classList.remove("hidden");}
        else{titleP2.classList.add("hidden");tableP2.classList.add("hidden");}
        updatePreview();
      });
    }

    function renderClauseRow(container,activeMap,state,clauseId){
      container.innerHTML="";
      columns.forEach(col=>{
        if(!isColumnVisible(col.key)) return;
        const colDiv=document.createElement("div");
        colDiv.className="col";
        if(!activeMap[col.key])colDiv.classList.add("dimmed");
        colDiv.dataset.key=col.key;colDiv.dataset.clause=clauseId;

        const header=document.createElement("div");
        header.className="col-header";
        header.textContent=col.title+(col.ko?` (${col.ko})`:"");
        colDiv.appendChild(header);

        const label=document.createElement("div");
        label.className="col-body-label";
        label.textContent=col.hint||"";
        colDiv.appendChild(label);

        const main=document.createElement("div");
        main.className="col-body-main";
        main.textContent=state[col.key]||"";
        colDiv.appendChild(main);

        const extra=document.createElement("div");
        extra.className="col-body-extra";
        if(col.key==="conjug" && state[col.key] && isLinkingConj(state[col.key])){
          extra.textContent="â­ cere propoziÈ›ia 2";
        }else extra.textContent="";
        colDiv.appendChild(extra);

        container.appendChild(colDiv);
      });
    }

    /* propoziÈ›ie care respectÄƒ ce e bifat + modul */
    function buildClauseSentence(state, activeMap){
      const koParts=[], roParts=[];
      const use = (key) => activeMap[key] !== false && isColumnVisible(key);

      const subj = state.subject;
      if(subj && use("subject")){
        koParts.push(addSubjectWithParticle(subj));
        roParts.push((translations.subject && translations.subject[subj]) || subj);
      }
      const t = state.time;
      if(t && use("time")){
        koParts.push(addTimeWithParticle(t));
        roParts.push((translations.time && translations.time[t]) || t);
      }
      const p = state.place;
      if(p && use("place")){
        koParts.push(addPlaceWithParticle(p));
        roParts.push((translations.place && translations.place[p]) || p);
      }
      const m = state.mod;
      if(m && use("mod")){
        koParts.push(m);
        roParts.push((translations.mod && translations.mod[m]) || m);
      }
      const obj = state.object;
      if(obj && use("object")){
        koParts.push(addObjectWithParticle(obj));
        roParts.push((translations.object && translations.object[obj]) || obj);
      }
      const num = state.numeral;
      if(num && use("numeral")){
        koParts.push(num);
        const nm = (translations.numeral && translations.numeral[num]) || num;
        roParts.push(nm);
      }
      const cnt = state.counter;
      if(cnt && use("counter")){
        koParts.push(cnt);
        roParts.push((translations.counter && translations.counter[cnt]) || cnt);
      }
      const v = state.verb;
      if(v && use("verb")){
        koParts.push(v);
        roParts.push((translations.verb && translations.verb[v]) || v);
      }
      const cj = state.conjug;
      if(cj && use("conjug")){
        koParts.push(cj);
        roParts.push((translations.conjug && translations.conjug[cj]) || cj);
      }
      return { ko: koParts.join(" "), ro: roParts };
    }

    let showRo=true;
    function updatePreview(){
      const c1=buildClauseSentence(stateP1, activeP1);
      let koText=c1.ko;
      let roWords=[...c1.ro];

      const conj1=stateP1["conjug"];
      if(enableP2.checked && conj1 && isLinkingConj(conj1)){
        const c2=buildClauseSentence(stateP2, activeP2);
        if(c2.ko){
          koText = koText + " / " + c2.ko;
          roWords = roWords.concat(["//"], c2.ro);
        }
      }

      if(!koText){
        previewKo.textContent="(alege cuvinte din tabel)";
        previewRo.textContent="";
        return;
      }
      previewKo.textContent=koText;
      if(showRo){
        previewRo.textContent = roWords.length ? roWords.join(" ") : "(fÄƒrÄƒ traducere disponibilÄƒ)";
      }else{
        previewRo.textContent = "Â·Â·Â· traducere ascunsÄƒ Â·Â·Â·";
      }
    }

    function render(){
      renderClauseRow(tableP1,activeP1,stateP1,"p1");
      if(enableP2.checked) renderClauseRow(tableP2,activeP2,stateP2,"p2");
      pageInfoEl.textContent=`RÃ¢nd model: ${index+1} / ${maxLen}`;
      prevBtn.disabled=index===0;
      nextBtn.disabled=index===maxLen-1;
      updatePreview();
    }

    let panelClause="p1";
    let panelKey="subject";

    function openPanel(clause,key){
      panelClause=clause;panelKey=key;
      const col=columns.find(c=>c.key===key);if(!col)return;
      panelTitle.textContent=(clause==="p1"?"PropoziÈ›ia 1 â€“ ":"PropoziÈ›ia 2 â€“ ")+col.title;
      panelSub.textContent=col.hint||"";
      newWordInput.value="";
      if(newWordTransInput) newWordTransInput.value="";
      panelList.innerHTML="";

      const map=translations[key]||{};
      col.data.forEach(word=>{
        if(!word)return;
        const item=document.createElement("div");
        item.className="panel-item";

        const main=document.createElement("div");
        main.className="panel-item-main";
        main.textContent=word;
        item.appendChild(main);

        const extraBox=document.createElement("div");
        extraBox.className="panel-item-extra";

        const ro=map[word];
        if(ro){
          const roDiv=document.createElement("div");
          roDiv.className="panel-item-tag";
          roDiv.textContent=ro;
          extraBox.appendChild(roDiv);
        }
        if(key==="conjug" && isLinkingConj(word)){
          const star=document.createElement("div");
          star.className="panel-item-tag";
          star.textContent="â­ P2";
          extraBox.appendChild(star);
        }
        item.appendChild(extraBox);

        item.addEventListener("click",()=>{
          const target = clause==="p1" ? stateP1 : stateP2;
          target[key]=word;
          if(key==="conjug" && isLinkingConj(word)){
            enableP2.checked=true;
            titleP2.classList.remove("hidden");
            tableP2.classList.remove("hidden");
          }
          overlay.classList.add("hidden");
          render();
        });

        panelList.appendChild(item);
      });

      overlay.classList.remove("hidden");
      newWordInput.focus();
    }

    closePanelBtn.addEventListener("click",()=>overlay.classList.add("hidden"));
    overlay.addEventListener("click",e=>{if(e.target===overlay)overlay.classList.add("hidden");});
    addWordBtn.addEventListener("click",()=>{
      const txt=newWordInput.value.trim();
      if(!txt)return;
      const roTxt = (newWordTransInput.value || "").trim();
      const col=columns.find(c=>c.key===panelKey);
      if(!col||!col.allowCustom)return;

      // adÄƒugÄƒm Ã®n lista de cuvinte pentru coloana respectivÄƒ
      col.data.push(txt);

      // salvÄƒm traducerea (dacÄƒ existÄƒ) Ã®n dictionarul de traduceri
      if(!translations[panelKey]) translations[panelKey] = {};
      if(roTxt){
        translations[panelKey][txt] = roTxt;
      }

      // adÄƒugÄƒm È™i Ã®n glosar
      const roForGloss = roTxt || "(fÄƒrÄƒ traducere Ã®ncÄƒ)";
      const categoryLabel = col.title || "CUSTOM";
      glossaryEntries.push({ko: txt, ro: roForGloss, category: categoryLabel});

      newWordInput.value="";
      if(newWordTransInput) newWordTransInput.value="";
      openPanel(panelClause,panelKey);
    });

    function loadRow(i){
      columns.forEach(col=>{
        const v=col.data[i]||"";
        stateP1[col.key]=v;
      });
    }
    prevBtn.addEventListener("click",()=>{if(index>0){index--;loadRow(index);render();}});
    nextBtn.addEventListener("click",()=>{if(index<maxLen-1){index++;loadRow(index);render();}});

    toggleRoBtn.addEventListener("click",()=>{
      showRo=!showRo;
      toggleRoBtn.textContent = showRo ? "Ascunde traducerea" : "AratÄƒ traducerea";
      updatePreview();
    });

    randomBtn.addEventListener("click",()=>{
      columns.forEach(col=>{
        if(!activeP1[col.key]) return;
        if(!isColumnVisible(col.key)) return;
        const arr=col.data.filter(x=>x!=="" && x!=null);
        if(!arr.length) return;
        const rand = arr[Math.floor(Math.random()*arr.length)];
        stateP1[col.key]=rand;
      });
      render();
    });

    speakBtn.addEventListener("click",()=>{
      if(!("speechSynthesis" in window)){alert("Browserul nu suportÄƒ audio.");return;}
      const text=previewKo.textContent;
      if(!text || text.includes("alege cuvinte")) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang="ko-KR";
      const voices = window.speechSynthesis.getVoices();
      const koVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith("ko"));
      if(koVoice) utter.voice = koVoice;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
    });

    // click scurt = next word, long press = panel
    function cycleColumnValue(clause,key){
      const col = columns.find(c=>c.key===key);
      if(!col) return;
      const arr = col.data;
      const state = clause==="p1" ? stateP1 : stateP2;
      const current = state[key];
      let idx = arr.indexOf(current);
      if(idx === -1) idx = 0;
      let nextIdx = (idx + 1) % arr.length;
      state[key] = arr[nextIdx] || "";
      render();
    }

    let longPressTimer = null;
    let pressTarget = null;

    function attachPressHandlers(tableEl){
      tableEl.addEventListener("pointerdown",e=>{
        const colDiv=e.target.closest(".col");if(!colDiv)return;
        e.preventDefault();
        pressTarget = colDiv;
        longPressTimer = setTimeout(()=>{
          if(pressTarget === colDiv){
            const key = colDiv.dataset.key;
            const clause = colDiv.dataset.clause || "p1";
            openPanel(clause,key);
            pressTarget = null;
          }
        }, 450); // 0.45s long press
      });
      tableEl.addEventListener("pointerup",e=>{
        const colDiv=e.target.closest(".col");
        if(longPressTimer){clearTimeout(longPressTimer);longPressTimer=null;}
        if(pressTarget && colDiv === pressTarget){
          const key = colDiv.dataset.key;
          const clause = colDiv.dataset.clause || "p1";
          cycleColumnValue(clause,key);
        }
        pressTarget = null;
      });
      tableEl.addEventListener("pointerleave",()=>{
        if(longPressTimer){clearTimeout(longPressTimer);longPressTimer=null;}
        pressTarget = null;
      });
    }

    createToggleChips();
    loadRow(index);
    attachPressHandlers(tableP1);
    attachPressHandlers(tableP2);
    render();

    /* ===== FAVORITE ===== */
    const favorites = [];
    const favoritesListEl = document.getElementById("favoritesList");

    function renderFavorites(){
      favoritesListEl.innerHTML = "";
      if(!favorites.length){
        const div=document.createElement("div");
        div.className="small-label";
        div.textContent="Nu ai salvat Ã®ncÄƒ nicio propoziÈ›ie.";
        favoritesListEl.appendChild(div);
        return;
      }
      favorites.forEach(f=>{
        const item=document.createElement("div");
        item.className="fav-item";
        const ko=document.createElement("div");
        ko.className="fav-ko";
        ko.textContent=f.ko;
        const ro=document.createElement("div");
        ro.className="fav-ro";
        ro.textContent=f.ro || "";
        item.appendChild(ko);item.appendChild(ro);
        favoritesListEl.appendChild(item);
      });
    }

    favBtn.addEventListener("click",()=>{
      const ko = previewKo.textContent.trim();
      let ro = previewRo.textContent.trim();
      if(!ko || ko.includes("alege cuvinte")) return;
      if(ro.startsWith("Â·Â·Â·")) ro = "";
      const exists = favorites.some(f=>f.ko===ko && f.ro===ro);
      if(!exists){
        favorites.push({ko,ro});
      }
      renderFavorites();
      favBtn.textContent = "â­ Salvat!";
      setTimeout(()=>{favBtn.textContent="â­ SalveazÄƒ propoziÈ›ia";},800);
    });

    /* ===== EXERCIÈšII TOPIK ===== */
    const exerciseTypeSelect=document.getElementById("exerciseType");
    const exerciseQuestionEl=document.getElementById("exerciseQuestion");
    const exerciseOptionsEl=document.getElementById("exerciseOptions");
    const exerciseFeedbackEl=document.getElementById("exerciseFeedback");
    const checkAnswerBtn=document.getElementById("checkAnswerBtn");
    const nextQuestionBtn=document.getElementById("nextQuestionBtn");

    const exerciseSets = {
      verb: [
        {
          sentence: "ì €ëŠ” ì•„ì¹¨ì— ì»¤í”¼ë¥¼ ___ .",
          options: ["ë§ˆì…”ìš”","ë¨¹ì–´ìš”","ê°€ìš”"],
          correct: 0,
          explanation: "ì»¤í”¼ëŠ” ë³´í†µ ë§ˆì…”ìš” (a bea cafea), nu ë¨¹ì–´ìš”."
        },
        {
          sentence: "ì•„ì´ë“¤ì´ ê³µì›ì—ì„œ ê³µì„ ___ .",
          options: ["ì½ì–´ìš”","ì°¨ìš”","ì¨ìš”"],
          correct: 1,
          explanation: "ê³µì„ ì°¨ë‹¤ = a È™uta/mingea (a lovi cu piciorul)."
        },
        {
          sentence: "ì €ëŠ” ì§‘ì—ì„œ í•œêµ­ì–´ë¥¼ ___ .",
          options: ["ê³µë¶€í•´ìš”","ë§ˆì…”ìš”","ë“ì—¬ìš”"],
          correct: 0,
          explanation: "í•œêµ­ì–´ë¥¼ ê³µë¶€í•´ìš” = Ã®nvÄƒÈ› coreeanÄƒ."
        }
      ],
      particle: [
        {
          sentence: "ì €___ ë‚´ì¼ ì¹œêµ¬ë¥¼ ë§Œë‚  ê±°ì˜ˆìš”.",
          options: ["ëŠ”","ë¥¼","ì—"],
          correct: 0,
          explanation: "ì €ëŠ” = subiect marcat cu ì€/ëŠ”."
        },
        {
          sentence: "ì €ëŠ” í•™êµ___ ê³µë¶€í•´ìš”.",
          options: ["ì—","ì—ì„œ","ì„"],
          correct: 1,
          explanation: "AcÈ›iunea 'a studia' se Ã®ntÃ¢mplÄƒ la È™coalÄƒ â†’ í•™êµì—ì„œ."
        },
        {
          sentence: "ì €ëŠ” ì±…___ ì½ì–´ìš”.",
          options: ["ì„","ì—","ê°€"],
          correct: 0,
          explanation: "ì±…ì„ ì½ì–´ìš” â†’ obiect + ì„/ë¥¼."
        }
      ],
      conjug: [
        {
          sentence: "ë‚´ì¼ ë¹„ê°€ ì˜¬ ___ .",
          options: ["ê±°ì˜ˆìš”","ê³  ìˆì–´ìš”","ì§€ ë§ˆì„¸ìš”"],
          correct: 0,
          explanation: "ì˜¬ ê±°ì˜ˆìš” = va ploua (viitor)."
        },
        {
          sentence: "ì§€ê¸ˆ ë°¥ì„ ë¨¹ê³  ___ .",
          options: ["ì‹¶ì–´ìš”","ìˆì–´ìš”","ê°ˆ ê±°ì˜ˆìš”"],
          correct: 1,
          explanation: "ë¨¹ê³  ìˆì–´ìš” = mÄƒnÃ¢nc acum (acÈ›iune Ã®n curs)."
        },
        {
          sentence: "ë„ˆë¬´ í”¼ê³¤í•´ì„œ ì˜¤ëŠ˜ ì¼ì° ìì•¼ ___ .",
          options: ["ë¼ìš”","ì‹¶ì–´ìš”","ìˆ˜ ìˆì–´ìš”"],
          correct: 0,
          explanation: "ìì•¼ ë¼ìš” = trebuie sÄƒ dorm devreme."
        }
      ]
    };

    // set special pentru particule multiple
    const particlePlusSet = [
      {
        parts: ["ì˜¤ëŠ˜ ", "ì €ëŠ” ", "í•™êµì—ì„œ ", "í•œêµ­ì–´ë¥¼ ", "ê³µë¶€í•´ìš”."],
        blanks: [
          {
            label: "SpaÈ›iul (1): dupÄƒ ì˜¤ëŠ˜ / Ã®nainte de ì €ëŠ” (subiectul)",
            options: ["-ëŠ”","-ì´/ê°€","(nimic)"],
            correct: 2,
            explanation: "ì˜¤ëŠ˜ este adverb de timp, de obicei fÄƒrÄƒ particulÄƒ Ã®n aceastÄƒ propoziÈ›ie."
          },
          {
            label: "SpaÈ›iul (2): dupÄƒ ì €ëŠ” (particula de subiect)",
            options: ["ì´","ê°€","ëŠ”","ì„"],
            correct: 2,
            explanation: "ì €ëŠ” â€“ subiect marcat cu ëŠ”."
          },
          {
            label: "SpaÈ›iul (3): locul acÈ›iunii (í•™êµâ€¦)",
            options: ["ì—","ì—ì„œ"],
            correct: 1,
            explanation: "ê³µë¶€í•˜ë‹¤ se face undeva â†’ í•™êµì—ì„œ (la È™coalÄƒ, acÈ›iune)."
          }
        ],
        lastText: "",
        globalExplanation: "ì˜¤ëŠ˜ ì €ëŠ” í•™êµì—ì„œ í•œêµ­ì–´ë¥¼ ê³µë¶€í•´ìš”. = Azi eu Ã®nvÄƒÈ› coreeanÄƒ la È™coalÄƒ."
      }
    ];

    let currentQuestion = null;
    let selectedOptionIndex = null;
    let selectedMulti = [];

    function loadRandomExercise(){
      const type = exerciseTypeSelect.value;
      exerciseOptionsEl.innerHTML="";
      exerciseFeedbackEl.textContent="";
      exerciseFeedbackEl.style.color="#333";

      if(type === "particlePlus"){
        const set = particlePlusSet;
        if(!set || !set.length) return;
        currentQuestion = set[Math.floor(Math.random()*set.length)];
        selectedMulti = new Array(currentQuestion.blanks.length).fill(null);

        exerciseQuestionEl.textContent = currentQuestion.globalExplanation.split("=")[0].trim() + " (completezi spaÈ›iile de mai jos)";

        currentQuestion.blanks.forEach((blank, idx)=>{
          const block = document.createElement("div");
          block.style.marginTop = "4px";
          const title = document.createElement("div");
          title.className = "small-label";
          title.textContent = `(${idx+1}) ${blank.label}`;
          block.appendChild(title);

          blank.options.forEach((opt, optIdx)=>{
            const id = `multi-${idx}-${optIdx}`;
            const label = document.createElement("label");
            const radio = document.createElement("input");
            radio.type="radio";
            radio.name=`blank-${idx}`;
            radio.value=optIdx;
            radio.id=id;
            radio.addEventListener("change",()=>{
              selectedMulti[idx] = optIdx;
            });
            const span=document.createElement("span");
            span.textContent = opt;
            label.appendChild(radio);
            label.appendChild(span);
            block.appendChild(label);
          });
          exerciseOptionsEl.appendChild(block);
        });
      } else {
        const set = exerciseSets[type];
        if(!set || !set.length)return;
        currentQuestion = set[Math.floor(Math.random()*set.length)];
        selectedOptionIndex = null;
        exerciseQuestionEl.textContent = currentQuestion.sentence;
        currentQuestion.blanks = undefined;
        currentQuestion.options.forEach((opt,idx)=>{
          const id="opt-"+idx;
          const label=document.createElement("label");
          const radio=document.createElement("input");
          radio.type="radio";radio.name="exerciseOption";radio.value=idx;radio.id=id;
          radio.addEventListener("change",()=>{selectedOptionIndex=idx;});
          const span=document.createElement("span");
          span.textContent=opt;
          label.appendChild(radio);label.appendChild(span);
          exerciseOptionsEl.appendChild(label);
        });
      }
    }

    checkAnswerBtn.addEventListener("click",()=>{
      const type = exerciseTypeSelect.value;
      if(!currentQuestion){
        exerciseFeedbackEl.textContent="Mai Ã®ntÃ¢i apasÄƒ â€Ãntrebare nouÄƒâ€.";
        return;
      }

      if(type === "particlePlus" && currentQuestion.blanks){
        for(let i=0;i<currentQuestion.blanks.length;i++){
          if(selectedMulti[i]===null){
            exerciseFeedbackEl.textContent=`Te rog alege rÄƒspuns pentru spaÈ›iul (${i+1}).`;
            return;
          }
        }
        let allCorrect = true;
        let detailLines = [];
        currentQuestion.blanks.forEach((blank,idx)=>{
          const isCorrect = selectedMulti[idx] === blank.correct;
          if(isCorrect){
            detailLines.push(`(${idx+1}) âœ” ${blank.explanation}`);
          }else{
            const correctOpt = blank.options[blank.correct];
            detailLines.push(`(${idx+1}) âœ˜ Corect: "${correctOpt}". ${blank.explanation}`);
            allCorrect = false;
          }
        });
        const fullSentence = currentQuestion.globalExplanation || "";
        if(allCorrect){
          exerciseFeedbackEl.style.color="#2e7d32";
          exerciseFeedbackEl.textContent = "âœ” Toate spaÈ›iile sunt corecte! " + fullSentence;
        }else{
          exerciseFeedbackEl.style.color="#c62828";
          exerciseFeedbackEl.textContent = detailLines.join(" / ") + " | " + fullSentence;
        }
        return;
      }

      if(selectedOptionIndex===null){
        exerciseFeedbackEl.textContent="Te rog alege un rÄƒspuns.";
        return;
      }
      if(selectedOptionIndex===currentQuestion.correct){
        exerciseFeedbackEl.textContent="âœ” Corect! " + currentQuestion.explanation;
        exerciseFeedbackEl.style.color="#2e7d32";
      }else{
        const correctText=currentQuestion.options[currentQuestion.correct];
        exerciseFeedbackEl.textContent=`âœ˜ Nu e corect. RÄƒspuns corect: "${correctText}". ${currentQuestion.explanation}`;
        exerciseFeedbackEl.style.color="#c62828";
      }
    });

    nextQuestionBtn.addEventListener("click",loadRandomExercise);
    exerciseTypeSelect.addEventListener("change",loadRandomExercise);

    /* ===== GLOSAR ===== */
    const glossarySearch=document.getElementById("glossarySearch");
    const glossaryList=document.getElementById("glossaryList");

    function addGlossaryFrom(list, catKey, categoryLabel){
      const map = translations[catKey] || {};
      list.forEach(w=>{
        if(!w) return;
        const ro = map[w] || "(fÄƒrÄƒ traducere Ã®ncÄƒ)";
        glossaryEntries.push({ko:w, ro, category:categoryLabel});
      });
    }

    addGlossaryFrom(subjects,"subject","SUBJECT");
    addGlossaryFrom(times,"time","TIME");
    addGlossaryFrom(places,"place","PLACE");
    addGlossaryFrom(mods,"mod","MOD");
    addGlossaryFrom(objects,"object","OBJECT");
    addGlossaryFrom(counters,"counter","COUNTER");
    addGlossaryFrom(verbs,"verb","VERB");
    addGlossaryFrom(conjugations,"conjug","CONJUGÄ‚RI");
    addGlossaryFrom(numerals,"numeral","NUMERAL");

    function renderGlossary(filter){
      filter = (filter||"").toLowerCase();
      glossaryList.innerHTML="";
      const filtered = glossaryEntries.filter(e=>{
        if(!filter) return true;
        return e.ko.toLowerCase().includes(filter) || e.ro.toLowerCase().includes(filter);
      });
      if(!filtered.length){
        const div=document.createElement("div");
        div.className="small-label";
        div.textContent="Nu s-a gÄƒsit nimic pentru cÄƒutarea introdusÄƒ.";
        glossaryList.appendChild(div);
        return;
      }
      filtered.forEach(e=>{
        const item=document.createElement("div");
        item.className="glossary-item";
        const left=document.createElement("div");
        const ko=document.createElement("div");
        ko.className="glossary-ko";
        ko.textContent=e.ko;
        const ro=document.createElement("div");
        ro.className="glossary-ro";
        ro.textContent=e.ro;
        left.appendChild(ko);left.appendChild(ro);
        const cat=document.createElement("div");
        cat.className="glossary-cat";
        cat.textContent=e.category;
        item.appendChild(left);item.appendChild(cat);
        glossaryList.appendChild(item);
      });
    }

    glossarySearch.addEventListener("input",()=>renderGlossary(glossarySearch.value));

    // porneÈ™te pe Builder
    setScreen("builder");
  </script>
</body>
</html>
